<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Calculator - v10.9 (Form Creator Integration)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/12.4.1/math.min.js"></script>
    <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />
    <script>
        // --- Tailwind CSS Configuration (FROM ORIGINAL CODE) ---
        tailwind.config = { /* ... Keep your existing config ... */ };
    </script>
    <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <style>
        /* --- Base Styles & Tailwind @apply rules (FROM ORIGINAL CODE) --- */
        body { font-family: 'Inter', sans-serif; background-color: #f9f9f9; color: #333; }
        /* Base style for energy pool sections */
        .energy-pool { @apply p-5 mb-5 rounded-lg shadow-sm border-l-4; transition: box-shadow 0.3s ease-in-out, opacity 0.3s ease-in-out; }
        /* Dynamic Pool Styles */
        .energy-pool-ki { border-left-color: #FF9800; } .energy-pool-ki h3 { color: #e65100; }
        .energy-pool-nen { border-left-color: #2196F3; } .energy-pool-nen h3 { color: #0d47a1; }
        .energy-pool-chakra { border-left-color: #9C27B0; } .energy-pool-chakra h3 { color: #4a148c; }
        .energy-pool-magic { border-left-color: #26a69a; } .energy-pool-magic h3 { color: #00796b; }
        .energy-pool-cursed { border-left-color: #dc2626; } .energy-pool-cursed h3 { color: #b91c1c; }
        .energy-pool-reiatsu { border-left-color: #475569; } .energy-pool-reiatsu h3 { color: #1e293b; }
        .energy-pool-haki { border-left-color: #1f2937; } .energy-pool-haki h3 { color: #000000; }
        .energy-pool-alchemy { border-left-color: #f59e0b; } .energy-pool-alchemy h3 { color: #b45309; }
        .energy-pool-nature { border-left-color: #84cc16; } .energy-pool-nature h3 { color: #4d7c0f; }
        .energy-pool-force { border-left-color: #d946ef; } .energy-pool-force h3 { color: #a21caf; }
        /* Base Slider Track Style */
        .energy-slider { @apply w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer; transition: background 0.2s ease-in-out; }
        /* Base Slider Thumb Style */
        .energy-slider::-webkit-slider-thumb { appearance: none; width: 20px; height: 20px; border-radius: 50%; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.2); transition: background 0.3s; border: none; background: #9ca3af; }
        .energy-slider::-moz-range-thumb { width: 20px; height: 20px; border-radius: 50%; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.2); transition: background 0.3s; border: none; background: #9ca3af; }
        /* Slider Thumb Colors */
        #ki-energy-slider::-webkit-slider-thumb { background: #FF9800; } #ki-energy-slider::-moz-range-thumb { background: #FF9800; }
        #nen-energy-slider::-webkit-slider-thumb { background: #2196F3; } #nen-energy-slider::-moz-range-thumb { background: #2196F3; }
        #chakra-energy-slider::-webkit-slider-thumb { background: #9C27B0; } #chakra-energy-slider::-moz-range-thumb { background: #9C27B0; }
        #magic-energy-slider::-webkit-slider-thumb { background: #26a69a; } #magic-energy-slider::-moz-range-thumb { background: #26a69a; }
        #cursed-energy-slider::-webkit-slider-thumb { background: #dc2626; } #cursed-energy-slider::-moz-range-thumb { background: #dc2626; }
        #reiatsu-energy-slider::-webkit-slider-thumb { background: #475569; } #reiatsu-energy-slider::-moz-range-thumb { background: #475569; }
        #haki-energy-slider::-webkit-slider-thumb { background: #1f2937; } #haki-energy-slider::-moz-range-thumb { background: #1f2937; }
        #alchemy-energy-slider::-webkit-slider-thumb { background: #f59e0b; } #alchemy-energy-slider::-moz-range-thumb { background: #f59e0b; }
        #nature-energy-slider::-webkit-slider-thumb { background: #84cc16; } #nature-energy-slider::-moz-range-thumb { background: #84cc16; }
        #force-energy-slider::-webkit-slider-thumb { background: #d946ef; } #force-energy-slider::-moz-range-thumb { background: #d946ef; }
        /* Slider Thumb Hover Colors */
        #ki-energy-slider:hover::-webkit-slider-thumb { background: #e65100; } #ki-energy-slider:hover::-moz-range-thumb { background: #e65100; }
        #nen-energy-slider:hover::-webkit-slider-thumb { background: #0d47a1; } #nen-energy-slider:hover::-moz-range-thumb { background: #0d47a1; }
        #chakra-energy-slider:hover::-webkit-slider-thumb { background: #4a148c; } #chakra-energy-slider:hover::-moz-range-thumb { background: #4a148c; }
        #magic-energy-slider:hover::-webkit-slider-thumb { background: #00796b; } #magic-energy-slider:hover::-moz-range-thumb { background: #00796b; }
        #cursed-energy-slider:hover::-webkit-slider-thumb { background: #b91c1c; } #cursed-energy-slider:hover::-moz-range-thumb { background: #b91c1c; }
        #reiatsu-energy-slider:hover::-webkit-slider-thumb { background: #1e293b; } #reiatsu-energy-slider:hover::-moz-range-thumb { background: #1e293b; }
        #haki-energy-slider:hover::-webkit-slider-thumb { background: #000000; } #haki-energy-slider:hover::-moz-range-thumb { background: #000000; }
        #alchemy-energy-slider:hover::-webkit-slider-thumb { background: #b45309; } #alchemy-energy-slider:hover::-moz-range-thumb { background: #b45309; }
        #nature-energy-slider:hover::-webkit-slider-thumb { background: #4d7c0f; } #nature-energy-slider:hover::-moz-range-thumb { background: #4d7c0f; }
        #force-energy-slider:hover::-webkit-slider-thumb { background: #a21caf; } #force-energy-slider:hover::-moz-range-thumb { background: #a21caf; }
        /* Dynamic Modifier Box Styles */
        .modifier-type-option.additive { border-color: theme('colors.success'); color: theme('colors.success-dark'); }
        .modifier-type-option.additive.active { background-color: theme('colors.success-light'); box-shadow: 0 1px 5px rgba(76, 175, 80, 0.3); animation: pulse-additive 0.5s; color: theme('colors.success'); }
        .modifier-type-option.multiplicative { border-color: theme('colors.ki'); color: theme('colors.ki-dark'); }
        .modifier-type-option.multiplicative.active { background-color: theme('colors.ki / 0.1'); box-shadow: 0 1px 5px rgba(255, 152, 0, 0.3); animation: pulse-multiplicative 0.5s; color: theme('colors.ki'); }
        /* Custom Animation Classes */
        .animate-pulse-result { animation: pulse-result 0.3s ease-in-out; }
        .animate-flash-red { animation: flash-red-bg 0.5s ease-out; }
        .animate-flash-green { animation: flash-green-bg 0.5s ease-out; }
        .animate-kaioken-glow { animation: kaioken-glow 1.5s infinite ease-in-out; }
        /* Static Glow classes */
        .static-glow-ki { box-shadow: 0 0 10px #FF980080; } .static-glow-nen { box-shadow: 0 0 10px #2196F380; } .static-glow-chakra { box-shadow: 0 0 10px #9C27B080; } .static-glow-magic { box-shadow: 0 0 10px #26a69a80; } .static-glow-cursed { box-shadow: 0 0 10px #dc262680; } .static-glow-reiatsu { box-shadow: 0 0 10px #47556980; } .static-glow-haki { box-shadow: 0 0 10px #1f293780; } .static-glow-alchemy { box-shadow: 0 0 10px #f59e0b80; } .static-glow-nature { box-shadow: 0 0 10px #84cc1680; } .static-glow-force { box-shadow: 0 0 10px #d946ef80; }
        /* Accessibility utility */
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }
        /* Stats Panel Styling */
        .stats-panel { border-left-width: 4px; transition: border-color 0.3s ease-in-out, box-shadow 1.5s ease-in-out; }
        .stats-panel-header { transition: color 0.3s ease-in-out; }
        /* Common Label Style */
        .lbl { @apply block mb-1 font-medium text-sm text-gray-600; }
        /* Common Input Style */
        .inpt { @apply w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:border-transparent text-sm transition-colors duration-300; }
        /* Input Readonly Style */
        .inpt:read-only { @apply bg-gray-100 cursor-not-allowed opacity-70; }
        /* Common Regen Button Style */
        .regen-btn { @apply px-3 py-2 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 transition-all duration-150 ease-in-out text-sm font-semibold shadow-sm active:scale-95; }
        /* Save/Load Button Style */
        .save-load-btn { @apply px-3 py-1 text-sm text-white rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-1 transition-all duration-150 ease-in-out active:scale-95; }
        /* Readonly display style */
        .readonly-display { @apply inline-block font-medium text-gray-800 min-h-[42px] px-2 py-2 w-full bg-gray-50 rounded-md border border-gray-200; line-height: 1.5; word-break: break-all; }
        /* Equation Display Styles */
        .equation-number { @apply font-semibold text-blue-600 hover:text-blue-800 underline transition-colors duration-150; cursor: pointer; }
        .equation-number:hover { text-shadow: 0 0 8px rgba(147, 197, 253, 0.8); }
        .equation-operator { @apply text-gray-600 mx-1; }
        .equation-group { @apply mx-0.5; }
        /* Animation for source input pulse */
        .animate-pulse-source { animation: pulse-source-input 0.8s ease-out; }
        /* Attack Button Active State */
        .attack-btn.active { @apply ring-2 ring-offset-2 scale-105 brightness-110; }
        #super-attack-btn.active { @apply ring-blue-600 bg-blue-700; }
        #ultimate-attack-btn.active { @apply ring-purple-600 bg-purple-700; }
        /* Form list item */
        .form-list-item { @apply p-3 bg-gray-100 rounded-md shadow-sm text-sm border border-gray-200; }
        /* Form dropdown */
        .form-dropdown { @apply inpt mt-2 bg-white; } /* Reuse inpt style and add margin */
        /* Specific styles for Form Creator Section */
        #form-creator-section { @apply border border-teal-200; }
        #form-creator-section h3 { @apply text-teal-700 border-b border-teal-200 pb-2; }
        #add-form-btn { @apply mt-4; } /* Use regen-btn structure for styling */

        /* Style for the Form List Display in Character Stats */
        #form-list-display-container { /* Add specific styles if needed */}
        #form-list-display { /* Styles for the list itself */}
        .displayed-form-item { /* Styles for each item in the list */ }

        /* Style for Form Dropdown in Energy Pool Template */
        .energy-pool .form-selection-area { /* Container for label and dropdown */ }
        .energy-pool .form-dropdown-label { /* Style for the dropdown label */ }
        .energy-pool .form-dropdown { /* Specific dropdown styling within the pool */ }


        /* --- Keep the rest of your existing styles --- */
    </style>
</head>
<body class="p-4 md:p-6">

    <div class="mb-4 flex flex-wrap gap-2">
        <button id="save-state-btn" class="save-load-btn bg-blue-500 hover:bg-blue-600 focus:ring-blue-400">Save State</button>
        <button id="load-state-btn" class="save-load-btn bg-gray-500 hover:bg-gray-600 focus:ring-gray-400">Load State</button>
        <button id="clear-state-btn" class="save-load-btn bg-red-500 hover:bg-red-600 focus:ring-red-400">Clear Saved</button>
        <button id="show-character-stats-btn" class="save-load-btn bg-teal-500 hover:bg-teal-600 focus:ring-teal-400">Character Stats</button>
    </div>
    <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">Energy Calculator</h1>

    <div id="main-calculator-content">
        <div class="flex flex-col md:flex-row gap-6 max-w-7xl mx-auto">

            <div class="flex-grow md:w-3/4">

                <div id="message-area" class="mb-4 p-3 rounded-md text-sm hidden" role="alert"></div>

                <div class="energy-pool bg-white p-5 mb-5 rounded-lg shadow-sm border-l-4 border-gray-400">
                    <h3 class="text-xl font-semibold mb-4 flex items-center">
                        Damage Modifiers
                        <span class="flex-grow h-px bg-gray-200 ml-3"></span>
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div><label for="base-damage" class="lbl">Base Damage:</label><input type="text" id="base-damage" placeholder="e.g., 100" aria-required="true" class="inpt focus:ring-success"></div>
                        <div><label for="attack-compression-points" class="lbl">Attack Compression Points:</label><input type="text" id="attack-compression-points" placeholder="e.g., 10" value="0" class="inpt focus:ring-red-500"></div>
                        <div><label for="base-multiplier" class="lbl">Base Multiplier:</label><input type="text" id="base-multiplier" placeholder="e.g., 1.5" value="1" class="inpt focus:ring-success"></div>
                        <div><label for="form-multiplier" class="lbl">Global Form Multiplier:</label><input type="text" id="form-multiplier" placeholder="e.g., 2" value="1" class="inpt focus:ring-success"></div>
                    </div>
                    <div id="dynamic-modifiers-container" class="mb-4"><h4 class="text-md font-semibold mb-2 text-gray-700">Additional Factors:</h4></div>
                    <button id="add-dynamic-box" aria-label="Add modifier factor" class="px-4 py-2 bg-chakra text-white rounded-md hover:bg-chakra-dark focus:outline-none focus:ring-2 focus:ring-chakra focus:ring-offset-2 transition-all duration-150 ease-in-out text-sm font-semibold shadow-sm active:scale-95">
                        Add Factor
                    </button>
                </div>

                <div class="form-group mb-5">
                    <label for="energy-type" class="lbl">Energy Type:</label>
                    <select id="energy-type" aria-label="Select energy type" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-success focus:border-transparent text-sm bg-white">
                        <option value="ki">Ki Energy</option>
                        <option value="nen">Nen Energy</option>
                        <option value="chakra">Chakra Energy</option>
                        <option value="magic">Magic Energy</option>
                        <option value="cursed">Cursed Energy</option>
                        <option value="reiatsu">Reiatsu</option>
                        <option value="haki">Haki</option>
                        <option value="alchemy">Alchemy</option>
                        <option value="nature">Nature Energy</option>
                        <option value="force">Force Energy</option>
                    </select>
                </div>

                <div id="energy-pools-container" class="mb-5">
                    </div>

                <div id="form-creator-section" class="bg-white p-5 mb-5 rounded-lg shadow-sm border border-teal-200">
                    <h3 class="text-xl font-semibold mb-4 text-teal-700 border-b border-teal-200 pb-2">Form Creator</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="form-name-input" class="lbl">Form Name:</label>
                            <input type="text" id="form-name-input" placeholder="e.g., Super Saiyan" class="inpt focus:ring-teal-500">
                        </div>
                        <div>
                            <label for="form-multiplier-input" class="lbl">Form Damage Multiplier:</label>
                            <input type="text" id="form-multiplier-input" placeholder="e.g., 50" value="1" class="inpt focus:ring-teal-500">
                        </div>
                        <div>
                            <label for="pool-max-multiplier-input" class="lbl">Pool Max Multiplier:</label>
                            <input type="text" id="pool-max-multiplier-input" placeholder="e.g., 1.5" value="1" class="inpt focus:ring-teal-500">
                        </div>
                        <div class="md:col-span-2">
                           <label for="form-energy-type" class="lbl">Assign to Energy Type:</label>
                            <select id="form-energy-type" class="inpt focus:ring-teal-500 bg-white">
                                <option value="ki">Ki</option>
                                <option value="nen">Nen</option>
                                <option value="chakra">Chakra</option>
                                <option value="magic">Magic</option>
                                <option value="cursed">Cursed</option>
                                <option value="reiatsu">Reiatsu</option>
                                <option value="haki">Haki</option>
                                <option value="alchemy">Alchemy</option>
                                <option value="nature">Nature</option>
                                <option value="force">Force</option>
                            </select>
                        </div>
                         <div class="md:col-span-2 flex items-center gap-2 mt-2">
                            <input type="checkbox" id="resistance-checkbox" class="h-4 w-4 rounded border-gray-300 text-teal-600 focus:ring-teal-500">
                            <label for="resistance-checkbox" class="text-sm text-gray-700 select-none">Does this form affect Resistances?</label>
                        </div>
                        <div id="resistance-values" class="hidden md:col-span-2 mt-2 grid grid-cols-1 sm:grid-cols-2 gap-4 p-3 bg-teal-50 border border-teal-200 rounded-md">
                            <div>
                                <label for="ac-value" class="lbl">AC Add/Multiplier:</label>
                                <input type="text" id="ac-value" placeholder="e.g., +5 or *1.1" class="inpt focus:ring-teal-500">
                            </div>
                            <div>
                                <label for="true-resistance-value" class="lbl">True Resistance Add/Multiplier:</label>
                                <input type="text" id="true-resistance-value" placeholder="e.g., +10 or *1.2" class="inpt focus:ring-teal-500">
                            </div>
                            <p class="sm:col-span-2 text-xs text-gray-500 mt-1">Enter value starting with '+' for additive, '*' for multiplicative (e.g., +10, *1.5). Default is additive if symbol omitted.</p>
                        </div>
                    </div>
                    <button id="add-form-btn" class="regen-btn bg-teal-500 hover:bg-teal-600 focus:ring-teal-400 mt-4">
                        Add Form to List
                    </button>
                </div>
                <div id="attacks-section" class="bg-white p-5 mb-5 rounded-lg shadow-sm">
                     </div>

                <div id="all-sliders-container" class="bg-white p-5 mb-5 rounded-lg shadow-sm">
                    </div>

                <button id="calculate-btn" aria-label="Calculate final damage value" class="w-full px-4 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-150 ease-in-out text-lg font-semibold shadow-md mb-5 active:scale-95">
                    Calculate Damage
                </button>

                <div id="loading" class="loading text-center p-5 hidden">
                    </div>
                <div id="result" class="result bg-success-light p-5 rounded-lg border-l-4 border-success shadow-sm hidden" aria-live="polite">
                    </div>

            </div> <div id="stats-panel" class="stats-panel md:w-1/4 lg:w-1/5 p-5 bg-white rounded-lg shadow-sm self-start sticky top-6 border-stats-border">
                 </div> </div> </div> <div id="character-stats-screen" class="hidden bg-white p-6 rounded-lg shadow-md max-w-7xl mx-auto mt-6 border border-gray-200">
         <div class="flex justify-between items-center mb-4 border-b pb-2">
            <h2 class="text-2xl font-bold text-gray-700">Character Stats</h2>
            </div>
         <div id="form-list-display-container" class="mt-6 pt-4 border-t border-gray-200">
             <h3 class="text-xl font-semibold mb-4 text-gray-700">Created Forms</h3>
             <div id="form-list-display" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 max-h-60 overflow-y-auto">
                 <p id="no-forms-message" class="text-gray-500 text-sm italic md:col-span-2 lg:col-span-3">No forms created yet.</p>
             </div>
         </div>
         </div> <template id="energy-pool-template">
        <div class="energy-pool bg-gradient-to-br from-white p-5 mb-5 rounded-lg shadow-sm border-l-4" style="display: none;">
            <h3 class="text-xl font-semibold mb-4 flex items-center">
                <span class="pool-title">Energy Pool Title</span>
                <span class="flex-grow h-px bg-gray-200 ml-3"></span>
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="lbl base-max-energy-label">Base Max Energy (Calculated):</label>
                    <span id="" class="readonly-display base-max-energy">0</span>
                </div>
                <div><label class="lbl max-multiplier-label" for="">Pool Max Multiplier:</label><input type="text" value="1" class="inpt max-multiplier"></div>
                <div>
                    <label class="lbl total-energy-label">Total Energy (Calculated):</label>
                    <span id="" class="readonly-display total-energy">0</span>
                </div>
                <div>
                    <label class="lbl current-energy-label">Current Energy:</label>
                    <span id="" class="readonly-display current-energy">0</span>
                </div>
                <div><label class="lbl damage-per-power-label" for="">Damage per Energy Point:</label><input type="text" value="1" class="inpt damage-per-power"></div>
                <div>
                    <label class="lbl regen-percent-label" for="">Regeneration Rate (% of Total):</label>
                    <div class="flex items-center gap-2">
                        <input type="text" placeholder="e.g., 10" class="flex-grow p-2 border border-gray-300 rounded-md focus:ring-2 focus:border-transparent text-sm regen-percent">
                        <button class="regen-btn bg-success hover:bg-success-dark focus:ring-success px-3 py-2 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 transition-all duration-150 ease-in-out text-sm font-semibold shadow-sm active:scale-95">Regen</button>
                    </div>
                </div>

                <div class="md:col-span-2 mt-3 pt-3 border-t border-gray-200 form-selection-area hidden"> <label class="lbl form-dropdown-label" for="">Select Active Form:</label>
                     <select class="form-dropdown inpt bg-white">
                         <option value="1" data-pool-max="1" data-ac="0" data-true-resistance="0" data-form-name="Base Form">Base Form (No Multiplier)</option>
                         </select>
                </div>
                 </div>
        </div>
    </template>

    <template id="energy-slider-template">
       </template>


    <script>
        // --- Original DOM Element References & Global State (Keep these) ---
        const energyTypeSelect = document.getElementById('energy-type');
        const energyPoolsContainer = document.getElementById('energy-pools-container');
        // ... (keep all other original const declarations)
        const ryokoEquationInput = document.getElementById('ryoko-equation-input');

        // --- NEW: Form Creator/List Element References ---
        const formCreatorSection = document.getElementById('form-creator-section');
        const formNameInput = document.getElementById('form-name-input'); // Added name input
        const formMultiplierInput_creator = document.getElementById('form-multiplier-input'); // Renamed to avoid conflict
        const poolMaxMultiplierInput_creator = document.getElementById('pool-max-multiplier-input');
        const resistanceCheckbox = document.getElementById('resistance-checkbox');
        const resistanceValues = document.getElementById('resistance-values');
        const acValueInput = document.getElementById('ac-value');
        const trueResistanceValueInput = document.getElementById('true-resistance-value');
        const formEnergyTypeSelect = document.getElementById('form-energy-type');
        const addFormBtn = document.getElementById('add-form-btn');
        const formListDisplay = document.getElementById('form-list-display'); // Display area in Character Stats
        const noFormsMessage = document.getElementById('no-forms-message');

        // --- Global State (Keep original + add forms) ---
        let totalDamageDealt = 0, totalEnergySpent = 0, attackCount = 0, highestDamage = 0;
        const LOCAL_STORAGE_KEY = 'energyCalculatorState_v1.3'; // Incremented version for state
        let poolAnimationTimeoutId = null;
        const ALL_ENERGY_TYPES = ['ki', 'nen', 'chakra', 'magic', 'cursed', 'reiatsu', 'haki', 'alchemy', 'nature', 'force'];
        let dynamicModifierCount = 0;
        let activeAttacks = {};
        let characterForms = {}; // NEW: Store created forms { energyType: [formObj, ...], ... }
        const ATTACK_RESERVE_COLOR = '#fed7aa';
        const SLIDER_TRACK_COLOR = '#e5e7eb';
        const DEFAULT_RYOKO_EQUATION = '((11250000 * 19 * 10 * 25 * 5 * 10 * 5 * 470) / 2) * 110';

        const ENERGY_TYPE_DETAILS = { /* ... Keep your existing details object ... */ };

        // --- Utility Functions (Keep all original functions) ---
        // safeParseFloat, formatSimpleNumber, showMessage, showLoading, triggerAnimation,
        // formatStatNumber, parseFormattedNumber, escapeHtml

        // --- Energy Pool Logic (Keep original functions, MAY NEED MODIFICATION LATER) ---
        // getEnergyElements, calculateBaseMaxEnergy, updateSliderVisibility,
        // calculateAndResetEnergy, regenerateEnergy

        // --- Kaioken Styling & Health Update (Keep original functions) ---
        // applyKaiokenStyle, removeKaiokenStyle, updateCurrentHealthDisplay, regenerateHealth

        // --- Show/Hide Logic & Pool Animation (Keep original functions) ---
        // showSelectedEnergyPool

        // --- Attack Logic (Keep original functions) ---
        // updateAttackButtonStates, updateSliderLimitAndStyle, handleAttackButtonClick

        // --- Dynamic Modifiers Logic (Keep original functions) ---
        // addDynamicModifier, addListenersToModifierBox

        // --- Stats Update Logic (Keep original functions) ---
        // updateStatsDisplay

        // --- Calculation Logic (Keep original functions, NEEDS MODIFICATION FOR FORMS/RESISTANCES) ---
        // updateSingleSliderDisplay, performCalculation

        // --- Number Formatting (Keep original functions) ---
        // displayAllFormats, convertNumberToWords

        // --- State Management (NEEDS MODIFICATION FOR FORMS) ---
        function gatherState() {
            const state = {
                // --- Keep all original state properties ---
                baseDamage: baseDamageInput.value, baseMultiplier: baseMultiplierInput.value, formMultiplier: formMultiplierInput.value, attackCompressionPoints: attackCompressionPointsInput.value,
                selectedEnergyType: energyTypeSelect.value, sliderPercentages: {}, energyPools: {}, dynamicModifiers: [], activeAttacks: activeAttacks,
                kaiokenActive: kaiokenCheckbox.checked, maxHealth: maxHealthInput.value, kaiokenStrain: kaiokenStrainInput.value, currentHealth: currentHealthEl?.textContent || '0',
                characterName: characterNameInput?.value || '', charBaseHealth: charBaseHealthInput?.value || '',
                charBaseMultiplier: charBaseMultiplierInput?.value || '1',
                charVitality: charVitalityInput?.value || '', charSoulPower: charSoulPowerInput?.value || '', charSoulHp: charSoulHpInput?.value || '',
                ryokoCheckboxState: ryokoCheckbox?.checked || false,
                ryokoEquationValue: ryokoEquationInput?.value || '',
                activeView: characterStatsScreen?.classList.contains('hidden') ? 'calculator' : 'stats',
                totalDamageDealt: totalDamageDealt, totalEnergySpent: totalEnergySpent, attackCount: attackCount, highestDamage: highestDamage,
                // --- NEW: Add forms and selected form state ---
                characterForms: characterForms,
                selectedForms: {} // { energyType: selectedFormNameOrIndex, ... }
            };

            ALL_ENERGY_TYPES.forEach(type => {
                const els = getEnergyElements(type);
                if (els) {
                    state.energyPools[type] = {
                        maxMultiplier: els.maxMultiplierEl?.value || '1',
                        currentEnergy: els.currentEnergyEl?.textContent || '0',
                        damagePerPower: els.damagePerPowerEl?.value || '1',
                        regenPercent: els.regenPercentEl?.value || ''
                    };
                    state.sliderPercentages[type] = els.energySlider?.value || '0';

                    // NEW: Save selected form
                    const formDropdown = els.poolDiv?.querySelector('.form-dropdown');
                    if (formDropdown) {
                        state.selectedForms[type] = formDropdown.value; // Save the value (which is the formMultiplier)
                    }
                }
            });

            dynamicModifiersContainer.querySelectorAll('.dynamic-box').forEach(box => {
                 const nameInput = box.querySelector('.modifier-name-input');
                 const valueInput = box.querySelector('.modifier-value-input');
                 const typeOption = box.querySelector('.modifier-type-option.active');
                 if (nameInput && valueInput && typeOption) {
                     state.dynamicModifiers.push({ name: nameInput.value, value: valueInput.value, type: typeOption.dataset.value });
                 }
             });

            return state;
        }

        function applyState(state) {
            if (!state) return;

             // --- Restore original state properties ---
            if (characterNameInput) characterNameInput.value = state.characterName || '';
            // ... (restore all other original inputs: baseDamage, multipliers, char stats, kaioken etc.) ...
            baseDamageInput.value = state.baseDamage || ''; baseMultiplierInput.value = state.baseMultiplier || '1'; formMultiplierInput.value = state.formMultiplier || '1'; attackCompressionPointsInput.value = state.attackCompressionPoints || '0';
            energyTypeSelect.value = state.selectedEnergyType || 'ki';
             kaiokenCheckbox.checked = state.kaiokenActive || false; maxHealthInput.value = state.maxHealth || '1000'; kaiokenStrainInput.value = state.kaiokenStrain || '10'; if(currentHealthEl) { const savedHealthNum = parseFormattedNumber(state.currentHealth || '0'); currentHealthEl.textContent = formatStatNumber(savedHealthNum); }
             totalDamageDealt = state.totalDamageDealt || 0; totalEnergySpent = state.totalEnergySpent || 0; attackCount = state.attackCount || 0; highestDamage = state.highestDamage || 0;
             activeAttacks = state.activeAttacks || {};
             // Ryoko Mode
            if (charBaseMultiplierInput) charBaseMultiplierInput.value = state.charBaseMultiplier || '1';
            if (ryokoCheckbox) ryokoCheckbox.checked = state.ryokoCheckboxState || false;
            if (ryokoEquationInput) ryokoEquationInput.value = state.ryokoEquationValue || '';
            handleRyokoCheckboxChange(); // Apply UI changes based on loaded Ryoko state


            // --- NEW: Restore Forms ---
            characterForms = state.characterForms || {};
            updateFormListDisplay(); // Update the list in Character Stats
            updateAllFormDropdowns(); // Add options to dropdowns in energy pools

            // --- Restore original energy pool values (AFTER forms are loaded for dropdowns) ---
             if (state.energyPools) { ALL_ENERGY_TYPES.forEach(type => { /* ... restore pool values ... */ }); }
             if (state.sliderPercentages) { ALL_ENERGY_TYPES.forEach(type => { /* ... restore slider values ... */ }); }

            // NEW: Set selected forms in dropdowns
            if (state.selectedForms) {
                 ALL_ENERGY_TYPES.forEach(type => {
                     const els = getEnergyElements(type);
                     const formDropdown = els?.poolDiv?.querySelector('.form-dropdown');
                     if (formDropdown && state.selectedForms[type] !== undefined) {
                         formDropdown.value = state.selectedForms[type];
                         // Trigger change event manually if needed to update calculations immediately
                         // formDropdown.dispatchEvent(new Event('change'));
                     }
                 });
             }


            // --- Restore dynamic modifiers ---
            dynamicModifiersContainer.innerHTML = '<h4 class="text-md font-semibold mb-2 text-gray-700">Additional Factors:</h4>'; dynamicModifierCount = 0; if (state.dynamicModifiers && Array.isArray(state.dynamicModifiers)) { state.dynamicModifiers.forEach(modData => addDynamicModifier(modData)); }

            // --- Final UI Updates ---
            ALL_ENERGY_TYPES.forEach(type => { updateSliderLimitAndStyle(type); });
            updateAttackButtonStates(energyTypeSelect.value);
            updateEquationDisplay();
            showSelectedEnergyPool(); // This should handle Kaioken visibility too
            if (state.activeView === 'stats') { showCharacterStatsView(); } else { showCalculatorView(); }
        }

        // --- Keep original saveState and clearState ---
        function saveState() { try { const state = gatherState(); const stateString = JSON.stringify(state); localStorage.setItem(LOCAL_STORAGE_KEY, stateString); showMessage('State saved successfully!', 'success'); } catch (error) { console.error("Error saving state:", error); showMessage(`Failed to save state. ${error.message}`, 'error'); } }
        function loadState() { const stateString = localStorage.getItem(LOCAL_STORAGE_KEY); if (stateString) { try { const state = JSON.parse(stateString); applyState(state); showMessage('State loaded successfully!', 'success'); return true; } catch (error) { console.error("Error loading state:", error); showMessage(`Failed to load saved state. Data might be corrupted. ${error.message}`, 'error'); localStorage.removeItem(LOCAL_STORAGE_KEY); } } return false; }
        function clearState() { if (confirm('Are you sure you want to clear the saved state? This cannot be undone.')) { localStorage.removeItem(LOCAL_STORAGE_KEY); showMessage('Saved state cleared. Reloading.', 'success'); setTimeout(() => window.location.reload(), 1000); } }


        // --- Generate Elements from Templates (Keep original) ---
        function generateEnergySections() { /* ... Keep original function ... */ }

        // --- Equation Display Function (Keep original, NEEDS MODIFICATION for forms) ---
        function updateEquationDisplay() { /* ... Keep original function ... */ }

        // --- Click Handler for Equation Numbers (Keep original) ---
        function handleEquationClick(event) { /* ... Keep original function ... */ }

        // --- Tab Switching Logic (Keep original) ---
        function showCharacterStatsView() { /* ... Keep original function ... */ }
        function showCalculatorView() { /* ... Keep original function ... */ }

        // --- Event Listener Helper (Keep original) ---
        function handleStatChange() { /* ... Keep original function ... */ }

        // --- Ryoko Mode Logic (Keep original) ---
        function handleRyokoCheckboxChange() { /* ... Keep original function ... */ }
        function evaluateRyokoEquation() { /* ... Keep original function ... */ }


        // --- NEW: Form Management Functions ---

        /** Updates the display list of forms in the Character Stats screen */
        function updateFormListDisplay() {
            if (!formListDisplay || !noFormsMessage) return;
            formListDisplay.innerHTML = ''; // Clear existing list
            let hasForms = false;
            Object.keys(characterForms).forEach(energyType => {
                characterForms[energyType].forEach((form, index) => {
                    hasForms = true;
                    const formItem = document.createElement('div');
                    formItem.className = 'displayed-form-item p-3 bg-gray-50 rounded-md shadow-sm text-sm border border-gray-200 relative'; // Added relative for potential delete button
                    let resistanceText = '';
                    if (form.acValue || form.trueResistanceValue) {
                        resistanceText = ` (Res: AC ${form.acValue}, TR ${form.trueResistanceValue})`;
                    }
                    formItem.innerHTML = `
                        <strong class="text-teal-700">${form.name || `Form ${index + 1}`} (${energyType.toUpperCase()})</strong><br>
                        Dmg Multi: x${formatSimpleNumber(form.formMultiplier)}, Pool Multi: x${formatSimpleNumber(form.poolMaxMultiplier)}
                        ${resistanceText}
                        <button class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs hover:bg-red-700 focus:outline-none focus:ring-1 focus:ring-red-400" data-energy-type="${energyType}" data-form-index="${index}" title="Delete Form">&times;</button>
                    `;
                    // Add event listener for the delete button
                    formItem.querySelector('button').addEventListener('click', handleDeleteForm);
                    formListDisplay.appendChild(formItem);
                });
            });
            noFormsMessage.classList.toggle('hidden', hasForms);
        }

        /** Handles deleting a form */
        function handleDeleteForm(event) {
            const btn = event.currentTarget;
            const energyType = btn.dataset.energyType;
            const index = parseInt(btn.dataset.formIndex, 10);

            if (characterForms[energyType] && characterForms[energyType][index] !== undefined) {
                const formName = characterForms[energyType][index].name || `Form ${index + 1}`;
                if (confirm(`Are you sure you want to delete the form "${formName}" for ${energyType.toUpperCase()}?`)) {
                    characterForms[energyType].splice(index, 1); // Remove form from array
                    if (characterForms[energyType].length === 0) {
                        delete characterForms[energyType]; // Remove energy type if no forms left
                    }
                    updateFormListDisplay();
                    updateAllFormDropdowns();
                    // Potentially trigger recalculation or reset selection if the deleted form was active
                    showMessage(`Form "${formName}" deleted.`, 'success');
                    // Save state? Or let user save manually.
                }
            }
        }


        /** Updates the form selection dropdown for a specific energy type pool */
        function updateFormDropdown(energyType) {
            const els = getEnergyElements(energyType);
            if (!els || !els.poolDiv) return;

            const formSelectionArea = els.poolDiv.querySelector('.form-selection-area');
            let dropdown = els.poolDiv.querySelector('.form-dropdown');
            let formLabel = els.poolDiv.querySelector('.form-dropdown-label');


            const formsForType = characterForms[energyType] || [];

            if (formsForType.length > 0) {
                // Ensure elements exist or create them
                if (!formSelectionArea) {
                    console.error("'.form-selection-area' not found in template for", energyType); return;
                }
                 if (!dropdown) {
                     console.error("'.form-dropdown' not found in template for", energyType); return;
                 }
                  if (!formLabel) {
                      console.error("'.form-dropdown-label' not found in template for", energyType); return;
                  }

                formLabel.htmlFor = `${energyType}-form-select`; // Set label association
                dropdown.id = `${energyType}-form-select`;

                // Preserve selected value if possible
                 const previouslySelectedValue = dropdown.value;

                 // Clear existing options except the base form
                 dropdown.innerHTML = `<option value="1" data-pool-max="1" data-ac="0" data-true-resistance="0" data-form-name="Base Form">Base Form (No Multiplier)</option>`;

                 formsForType.forEach((form) => {
                     const option = document.createElement('option');
                     // Use formMultiplier as value for now, consider unique ID later
                     option.value = form.formMultiplier;
                     option.dataset.poolMax = form.poolMaxMultiplier;
                     option.dataset.ac = form.acValue || 0; // Store resistance info
                     option.dataset.trueResistance = form.trueResistanceValue || 0;
                     option.dataset.formName = form.name || 'Unnamed Form'; // Store name
                     option.textContent = `${form.name || 'Unnamed Form'} (x${formatSimpleNumber(form.formMultiplier)})`;
                     dropdown.appendChild(option);
                 });

                 // Try to restore previous selection
                 if (dropdown.querySelector(`option[value="${previouslySelectedValue}"]`)) {
                    dropdown.value = previouslySelectedValue;
                 } else {
                     dropdown.value = "1"; // Default to base form if previous selection is gone
                 }


                formSelectionArea.classList.remove('hidden'); // Show the dropdown

                 // Add event listener if not already present
                 if (!dropdown.dataset.listenerAttached) {
                     dropdown.addEventListener('change', handleFormSelectionChange);
                     dropdown.dataset.listenerAttached = 'true';
                 }


            } else {
                // Hide dropdown if no forms exist for this type
                if (formSelectionArea) formSelectionArea.classList.add('hidden');
            }
        }

         /** Updates dropdowns for all energy types */
         function updateAllFormDropdowns() {
             ALL_ENERGY_TYPES.forEach(type => updateFormDropdown(type));
         }

         /** Handles change event on form selection dropdowns */
         function handleFormSelectionChange(event) {
             const dropdown = event.target;
             const selectedOption = dropdown.options[dropdown.selectedIndex];
             const energyType = dropdown.id.split('-')[0]; // Infer type from ID

             // --- TODO: Implement logic based on selected form ---
             // 1. Get values from selectedOption.dataset (poolMax, ac, trueResistance)
             // 2. Update the corresponding energy pool's max multiplier input? Or handle it directly in calculation?
             // 3. Update the GLOBAL form multiplier input? Or handle override in calculation?
             // 4. Store the selected AC/True Resistance for use in calculation.
             // 5. Trigger updateEquationDisplay() and potentially updateStatsDisplay()

             const formName = selectedOption.dataset.formName || 'Selected Form';
              showMessage(`${energyType.toUpperCase()}: Switched to ${formName}`, 'info');

              // Example: Update pool max multiplier input directly (Choose ONE way to handle this)
              // const els = getEnergyElements(energyType);
              // if (els && els.maxMultiplierEl) {
              //     els.maxMultiplierEl.value = selectedOption.dataset.poolMax || '1';
              //     calculateAndResetEnergy(energyType); // Recalculate pool based on new max
              // }

              updateEquationDisplay(); // Update equation which might depend on selected form
         }


        /** Parses resistance input string (+5, *1.2, 10) */
        function parseResistanceValue(inputString) {
             if (!inputString || typeof inputString !== 'string') return { type: 'add', value: 0 };
             inputString = inputString.trim();
             if (inputString.startsWith('*')) {
                 return { type: 'multiply', value: safeParseFloat(inputString.substring(1), 1) };
             } else if (inputString.startsWith('+')) {
                 return { type: 'add', value: safeParseFloat(inputString.substring(1), 0) };
             } else {
                 // Default to additive if no symbol
                 return { type: 'add', value: safeParseFloat(inputString, 0) };
             }
         }


        // --- Event Listeners Setup ---
        function setupEventListeners() {
            // --- Keep all original listeners ---
            energyTypeSelect.addEventListener('change', () => { showSelectedEnergyPool(); updateEquationDisplay(); });
            calculateBtn.addEventListener('click', () => { triggerAnimation(calculateBtn, 'pulse'); performCalculation(); });
            addDynamicBoxBtn.addEventListener('click', () => { triggerAnimation(addDynamicBoxBtn, 'pulse'); addDynamicModifier(); updateEquationDisplay(); });
            [baseDamageInput, attackCompressionPointsInput, baseMultiplierInput, formMultiplierInput].forEach(input => { if(input) { input.addEventListener('input', updateEquationDisplay); input.addEventListener('change', updateEquationDisplay); } });
            // Character Stat inputs listener
             const characterStatInputs = [ charBaseHealthInput, charVitalityInput, charSoulPowerInput, charSoulHpInput ];
             characterStatInputs.forEach(input => { if (input) { input.addEventListener('input', handleStatChange); } });
             // Specific handling for Character Base Multiplier and Ryoko Mode
             if (charBaseMultiplierInput) { charBaseMultiplierInput.addEventListener('input', () => { if (!charBaseMultiplierInput.readOnly) { handleStatChange(); } }); }
             if (ryokoCheckbox) { ryokoCheckbox.addEventListener('change', handleRyokoCheckboxChange); }
             if (ryokoEquationInput) { ryokoEquationInput.addEventListener('input', evaluateRyokoEquation); ryokoEquationInput.addEventListener('change', evaluateRyokoEquation); }
             // Dynamically generated energy pool inputs and sliders
             ALL_ENERGY_TYPES.forEach(type => { const els = getEnergyElements(type); if (els) { if (els.maxMultiplierEl) els.maxMultiplierEl.addEventListener('input', () => { calculateAndResetEnergy(type); updateStatsDisplay(); updateEquationDisplay(); }); if (els.damagePerPowerEl) els.damagePerPowerEl.addEventListener('input', () => { updateSingleSliderDisplay(type); updateEquationDisplay(); }); if (els.energySlider) { els.energySlider.addEventListener('input', (event) => { const slider = event.target; const currentType = slider.dataset.type; const activeAttack = activeAttacks[currentType] || null; let limitPercent = 100; if (activeAttack === 'super') limitPercent = 95; else if (activeAttack === 'ultimate') limitPercent = 90; if (parseInt(slider.value) > limitPercent) { slider.value = limitPercent; } updateSingleSliderDisplay(currentType); updateEquationDisplay(); }); } const regenBtn = els.poolDiv?.querySelector('.regen-btn'); if (regenBtn) { regenBtn.addEventListener('click', function() { triggerAnimation(this, 'pulse'); regenerateEnergy(this.dataset.type); }); } } else { console.warn(`Could not find elements for type ${type} to attach listeners.`); } });
            // Kaioken section listeners
             if (kaiokenCheckbox) { kaiokenCheckbox.addEventListener('change', () => { const isChecked = kaiokenCheckbox.checked; kaiokenDetails.classList.toggle('hidden', !isChecked); if (isChecked) { applyKaiokenStyle(); updateCurrentHealthDisplay(); } else { removeKaiokenStyle(); } updateEquationDisplay(); }); }
             if (maxHealthInput) { maxHealthInput.addEventListener('input', () => { updateCurrentHealthDisplay(); updateEquationDisplay(); }); maxHealthInput.addEventListener('change', () => { updateCurrentHealthDisplay(); updateEquationDisplay(); }); }
             if (kaiokenStrainInput) { kaiokenStrainInput.addEventListener('input', updateEquationDisplay); }
             if (regenHealthBtn) { regenHealthBtn.addEventListener('click', () => { triggerAnimation(regenHealthBtn, 'pulse'); regenerateHealth(); }); }
            // Save/Load/Clear Button Listeners
             if (saveBtn) saveBtn.addEventListener('click', () => { triggerAnimation(saveBtn, 'pulse'); saveState(); });
             if (loadBtn) loadBtn.addEventListener('click', () => { triggerAnimation(loadBtn, 'pulse'); loadState(); });
             if (clearBtn) clearBtn.addEventListener('click', () => { triggerAnimation(clearBtn, 'pulse'); clearState(); });
            // Equation click listener
             if (equationDisplayEl) { equationDisplayEl.addEventListener('click', handleEquationClick); }
            // Reset Attack Count button listener
             if (resetAttackCountBtn) { resetAttackCountBtn.addEventListener('click', () => { triggerAnimation(resetAttackCountBtn, 'pulse'); attackCount = 0; updateStatsDisplay(); showMessage('Attack count reset.', 'info'); }); }
            // Attack Button Listeners
             if (superAttackBtn) superAttackBtn.addEventListener('click', handleAttackButtonClick);
             if (ultimateAttackBtn) ultimateAttackBtn.addEventListener('click', handleAttackButtonClick);
            // Tab Switching Button Listener
             if (showCharacterStatsBtn) { showCharacterStatsBtn.addEventListener('click', () => { triggerAnimation(showCharacterStatsBtn, 'pulse'); if (characterStatsScreen && characterStatsScreen.classList.contains('hidden')) { showCharacterStatsView(); } else { showCalculatorView(); } }); }


            // --- NEW: Form Creator Event Listeners ---
            if (resistanceCheckbox) {
                resistanceCheckbox.addEventListener('change', () => {
                    resistanceValues.classList.toggle('hidden', !resistanceCheckbox.checked);
                });
            }

            if (addFormBtn) {
                addFormBtn.addEventListener('click', () => {
                    triggerAnimation(addFormBtn, 'pulse');
                    const energyType = formEnergyTypeSelect.value;
                    const formName = formNameInput.value.trim(); // Get form name
                    const formMultiplier = safeParseFloat(formMultiplierInput_creator.value, 1);
                    const poolMaxMultiplier = safeParseFloat(poolMaxMultiplierInput_creator.value, 1);
                    const affectsResistances = resistanceCheckbox.checked;
                    // Use the parsing function
                    const acData = affectsResistances ? parseResistanceValue(acValueInput.value) : { type: 'add', value: 0 };
                    const trData = affectsResistances ? parseResistanceValue(trueResistanceValueInput.value) : { type: 'add', value: 0 };

                    if (!formName) {
                         showMessage('Please enter a name for the form.', 'error');
                         formNameInput.focus();
                         triggerAnimation(formNameInput, 'shakeX');
                         return;
                     }

                    // Store form data
                    if (!characterForms[energyType]) {
                        characterForms[energyType] = [];
                    }
                    characterForms[energyType].push({
                        name: formName, // Store the name
                        formMultiplier: formMultiplier,
                        poolMaxMultiplier: poolMaxMultiplier,
                        acValue: acData.value, // Store parsed value
                        acType: acData.type,   // Store 'add' or 'multiply'
                        trueResistanceValue: trData.value, // Store parsed value
                        trueResistanceType: trData.type    // Store 'add' or 'multiply'
                    });

                    // Update UI
                    updateFormListDisplay(); // Update list in Character Stats
                    updateFormDropdown(energyType); // Update the dropdown for the specific energy type

                    showMessage(`Form "${formName}" added for ${energyType.toUpperCase()} energy type!`, 'success');

                    // Optionally clear creator inputs
                    // formNameInput.value = '';
                    // formMultiplierInput_creator.value = '1';
                    // poolMaxMultiplierInput_creator.value = '1';
                    // resistanceCheckbox.checked = false;
                    // resistanceValues.classList.add('hidden');
                    // acValueInput.value = '';
                    // trueResistanceValueInput.value = '';
                });
            }

            console.log("Event listeners set up.");
        }


        // --- Initial Setup on Page Load ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Loaded. Initializing Energy Calculator v10.9 (Form Creator Integration)..."); // Updated version

            activeAttacks = {};
            ALL_ENERGY_TYPES.forEach(type => { activeAttacks[type] = null; });

            characterForms = {}; // Initialize form storage

            generateEnergySections(); // Generates pools AND adds the (initially empty) dropdown structure

            const stateLoaded = loadState(); // This now calls applyState which handles forms too
            setupEventListeners(); // Sets up ALL listeners, including new form ones

            if (!stateLoaded) {
                 ALL_ENERGY_TYPES.forEach(type => { calculateAndResetEnergy(type); });
                 handleRyokoCheckboxChange();
                 showCalculatorView();
                 showSelectedEnergyPool();
                 updateFormListDisplay(); // Show initial state (no forms)
                 updateAllFormDropdowns(); // Ensure dropdowns are correct (base form only)
                 updateStatsDisplay();
                 updateEquationDisplay();
             } else {
                 // State loaded by applyState, which should handle forms and dropdowns
                 // Ensure pools are calculated based on loaded stats and potentially selected forms
                 ALL_ENERGY_TYPES.forEach(type => { calculateAndResetEnergy(type); });
                 updateStatsDisplay();
                 updateEquationDisplay();
             }

            console.log(`Initialization complete. ${stateLoaded ? '(Saved state loaded)' : '(Using default state)'}`);
        });

    </script>

</body>
</html>
