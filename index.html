<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
          theme: {
            extend: {
              colors: {
                ki: '#FF9800', // Orange
                nen: '#2196F3', // Blue
                chakra: '#9C27B0', // Purple
                'ki-dark': '#e65100',
                'nen-dark': '#0d47a1',
                'chakra-dark': '#4a148c',
                'success-light': '#e8f5e9',
                'success': '#4CAF50',
                'success-dark': '#2e7d32',
                'error-light': '#ffebee',
                'error': '#f44336',
                'error-dark': '#c62828',
              },
              animation: {
                spin: 'spin 1s linear infinite',
                shake: 'shake 0.5s ease-in-out',
                fadeIn: 'fadeIn 0.3s ease-in',
                pulse: 'pulse 1.5s infinite',
                'pulse-additive': 'pulse-additive 0.5s',
                'pulse-multiplicative': 'pulse-multiplicative 0.5s',
              },
              keyframes: {
                spin: {
                  '0%': { transform: 'rotate(0deg)' },
                  '100%': { transform: 'rotate(360deg)' },
                },
                shake: {
                  '0%, 100%': { transform: 'translateX(0)' },
                  '25%, 75%': { transform: 'translateX(-5px)' },
                  '50%': { transform: 'translateX(5px)' },
                },
                fadeIn: {
                  from: { opacity: 0, transform: 'translateY(10px)' },
                  to: { opacity: 1, transform: 'translateY(0)' },
                },
                pulse: {
                  '0%, 100%': { transform: 'scale(1)' },
                  '50%': { transform: 'scale(1.05)' },
                },
                'pulse-additive': {
                  '0%, 100%': { color: '#558b2f' }, // success-dark adjusted
                  '50%': { color: '#8BC34A' }, // Original green
                },
                'pulse-multiplicative': {
                  '0%, 100%': { color: '#e65100' }, // ki-dark
                  '50%': { color: '#FF9800' }, // ki
                },
              }
            }
          }
        }
    </script>
    <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <style>
        /* Basic body styling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9f9f9;
            color: #333;
        }
        /* Style for energy pool borders */
        .energy-pool-ki { border-left-color: theme('colors.ki'); }
        .energy-pool-ki h3 { color: theme('colors.ki-dark'); }
        .energy-pool-nen { border-left-color: theme('colors.nen'); }
        .energy-pool-nen h3 { color: theme('colors.nen-dark'); }
        .energy-pool-chakra { border-left-color: theme('colors.chakra'); }
        .energy-pool-chakra h3 { color: theme('colors.chakra-dark'); }

        /* Custom slider thumb styles */
        .energy-slider::-webkit-slider-thumb {
            appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: theme('colors.success');
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background 0.3s;
        }
        .energy-slider::-moz-range-thumb {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: theme('colors.success');
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background 0.3s;
        }
        .energy-slider::-webkit-slider-thumb:hover { background: theme('colors.success-dark'); }
        .energy-slider::-moz-range-thumb:hover { background: theme('colors.success-dark'); }

        /* Style for dynamic modifier type buttons */
        .modifier-type-option.additive { border-color: theme('colors.success'); color: theme('colors.success-dark'); }
        .modifier-type-option.additive.active { background-color: theme('colors.success-light'); box-shadow: 0 1px 5px rgba(76, 175, 80, 0.3); animation: pulse-additive 0.5s; color: theme('colors.success'); }
        .modifier-type-option.multiplicative { border-color: theme('colors.ki'); color: theme('colors.ki-dark'); }
        .modifier-type-option.multiplicative.active { background-color: theme('colors.ki / 0.1'); box-shadow: 0 1px 5px rgba(255, 152, 0, 0.3); animation: pulse-multiplicative 0.5s; color: theme('colors.ki'); }

        /* Ensure animations run */
        .animate-pulse-additive { animation: pulse-additive 0.5s; }
        .animate-pulse-multiplicative { animation: pulse-multiplicative 0.5s; }

        /* Visually hidden class for accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
    </style>
</head>
<body class="max-w-3xl mx-auto p-4 md:p-6">
    <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">Energy Calculator</h1>

    <div id="message-area" class="mb-4 p-3 rounded-md text-sm hidden" role="alert"></div>

    <div class="energy-pool bg-white p-5 mb-5 rounded-lg shadow-sm border-l-4 border-gray-400">
        <h3 class="text-xl font-semibold mb-4 flex items-center">
            Damage Modifiers
            <span class="flex-grow h-px bg-gray-200 ml-3"></span>
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div class="form-group">
                <label for="base-damage" class="block mb-1 font-medium text-sm text-gray-600">Base Damage:</label>
                <input type="text" id="base-damage" placeholder="e.g., 100" aria-required="true" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-success focus:border-transparent text-sm">
            </div>
            <div class="form-group">
                <label for="base-multiplier" class="block mb-1 font-medium text-sm text-gray-600">Base Multiplier:</label>
                <input type="text" id="base-multiplier" placeholder="e.g., 1.5" value="1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-success focus:border-transparent text-sm">
            </div>
            <div class="form-group">
                <label for="form-multiplier" class="block mb-1 font-medium text-sm text-gray-600">Form Multiplier:</label>
                <input type="text" id="form-multiplier" placeholder="e.g., 2" value="1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-success focus:border-transparent text-sm">
            </div>
        </div>

        <div id="dynamic-modifiers-container" class="mb-4">
            <h4 class="text-md font-semibold mb-2 text-gray-700">Additional Factors:</h4>
            </div>
        <button id="add-dynamic-box" aria-label="Add modifier factor" class="px-4 py-2 bg-chakra text-white rounded-md hover:bg-chakra-dark focus:outline-none focus:ring-2 focus:ring-chakra focus:ring-offset-2 transition duration-150 ease-in-out text-sm font-semibold shadow-sm">
            Add Factor
        </button>
    </div>

    <div class="form-group mb-5">
        <label for="energy-type" class="block mb-1 font-medium text-sm text-gray-600">Energy Type:</label>
        <select id="energy-type" aria-label="Select energy type" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-success focus:border-transparent text-sm bg-white">
            <option value="ki">Ki Energy</option>
            <option value="nen">Nen Energy</option>
            <option value="chakra">Chakra Energy</option>
        </select>
    </div>

    <div id="ki-pool" class="energy-pool energy-pool-ki bg-white p-5 mb-5 rounded-lg shadow-sm border-l-4">
        <h3 class="text-xl font-semibold mb-4 flex items-center">
            Ki Energy Pool
            <span class="flex-grow h-px bg-gray-200 ml-3"></span>
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="form-group">
                <label for="ki-max-energy" class="block mb-1 font-medium text-sm text-gray-600">Max Energy:</label>
                <input type="text" id="ki-max-energy" placeholder="Enter maximum" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-ki focus:border-transparent text-sm">
            </div>
            <div class="form-group">
                <label for="ki-max-multiplier" class="block mb-1 font-medium text-sm text-gray-600">Max Energy Multiplier:</label>
                <input type="text" id="ki-max-multiplier" placeholder="e.g., 1" value="1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-ki focus:border-transparent text-sm">
            </div>
            <div class="form-group">
                <label for="ki-total-energy" class="block mb-1 font-medium text-sm text-gray-600">Total Energy (Calculated):</label>
                <input type="text" id="ki-total-energy" readonly class="w-full p-2 border border-gray-300 rounded-md bg-gray-100 text-sm">
            </div>
             <div class="form-group">
                <label for="ki-current-energy" class="block mb-1 font-medium text-sm text-gray-600">Current Energy:</label>
                <input type="text" id="ki-current-energy" readonly class="w-full p-2 border border-gray-300 rounded-md bg-gray-100 text-sm">
            </div>
            <div class="form-group">
                <label for="ki-damage-per-power" class="block mb-1 font-medium text-sm text-gray-600">Damage per Energy Point:</label>
                <input type="text" id="ki-damage-per-power" placeholder="e.g., 0.5" value="1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-ki focus:border-transparent text-sm">
            </div>
            <div class="form-group">
                <label for="ki-regen-percent" class="block mb-1 font-medium text-sm text-gray-600">Regeneration Rate (% of Max):</label>
                <div class="flex items-center gap-2">
                    <input type="text" id="ki-regen-percent" placeholder="e.g., 10" class="flex-grow p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-ki focus:border-transparent text-sm">
                    <button data-type="ki" class="regen-button px-3 py-2 bg-ki text-white rounded-md hover:bg-ki-dark focus:outline-none focus:ring-2 focus:ring-ki focus:ring-offset-2 transition duration-150 ease-in-out text-sm font-semibold shadow-sm">Regen</button>
                </div>
            </div>
        </div>
    </div>

    <div id="nen-pool" class="energy-pool energy-pool-nen bg-white p-5 mb-5 rounded-lg shadow-sm border-l-4">
         <h3 class="text-xl font-semibold mb-4 flex items-center">
            Nen Energy Pool
            <span class="flex-grow h-px bg-gray-200 ml-3"></span>
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="form-group">
                <label for="nen-max-energy" class="block mb-1 font-medium text-sm text-gray-600">Max Energy:</label>
                <input type="text" id="nen-max-energy" placeholder="Enter maximum" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-nen focus:border-transparent text-sm">
            </div>
            <div class="form-group">
                <label for="nen-max-multiplier" class="block mb-1 font-medium text-sm text-gray-600">Max Energy Multiplier:</label>
                <input type="text" id="nen-max-multiplier" placeholder="e.g., 1" value="1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-nen focus:border-transparent text-sm">
            </div>
            <div class="form-group">
                <label for="nen-total-energy" class="block mb-1 font-medium text-sm text-gray-600">Total Energy (Calculated):</label>
                <input type="text" id="nen-total-energy" readonly class="w-full p-2 border border-gray-300 rounded-md bg-gray-100 text-sm">
            </div>
             <div class="form-group">
                <label for="nen-current-energy" class="block mb-1 font-medium text-sm text-gray-600">Current Energy:</label>
                <input type="text" id="nen-current-energy" readonly class="w-full p-2 border border-gray-300 rounded-md bg-gray-100 text-sm">
            </div>
            <div class="form-group">
                <label for="nen-damage-per-power" class="block mb-1 font-medium text-sm text-gray-600">Damage per Energy Point:</label>
                <input type="text" id="nen-damage-per-power" placeholder="e.g., 0.5" value="1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-nen focus:border-transparent text-sm">
            </div>
            <div class="form-group">
                <label for="nen-regen-percent" class="block mb-1 font-medium text-sm text-gray-600">Regeneration Rate (% of Max):</label>
                <div class="flex items-center gap-2">
                    <input type="text" id="nen-regen-percent" placeholder="e.g., 10" class="flex-grow p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-nen focus:border-transparent text-sm">
                    <button data-type="nen" class="regen-button px-3 py-2 bg-nen text-white rounded-md hover:bg-nen-dark focus:outline-none focus:ring-2 focus:ring-nen focus:ring-offset-2 transition duration-150 ease-in-out text-sm font-semibold shadow-sm">Regen</button>
                </div>
            </div>
        </div>
    </div>

    <div id="chakra-pool" class="energy-pool energy-pool-chakra bg-white p-5 mb-5 rounded-lg shadow-sm border-l-4">
         <h3 class="text-xl font-semibold mb-4 flex items-center">
            Chakra Energy Pool
            <span class="flex-grow h-px bg-gray-200 ml-3"></span>
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="form-group">
                <label for="chakra-max-energy" class="block mb-1 font-medium text-sm text-gray-600">Max Energy:</label>
                <input type="text" id="chakra-max-energy" placeholder="Enter maximum" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-chakra focus:border-transparent text-sm">
            </div>
            <div class="form-group">
                <label for="chakra-max-multiplier" class="block mb-1 font-medium text-sm text-gray-600">Max Energy Multiplier:</label>
                <input type="text" id="chakra-max-multiplier" placeholder="e.g., 1" value="1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-chakra focus:border-transparent text-sm">
            </div>
            <div class="form-group">
                <label for="chakra-total-energy" class="block mb-1 font-medium text-sm text-gray-600">Total Energy (Calculated):</label>
                <input type="text" id="chakra-total-energy" readonly class="w-full p-2 border border-gray-300 rounded-md bg-gray-100 text-sm">
            </div>
             <div class="form-group">
                <label for="chakra-current-energy" class="block mb-1 font-medium text-sm text-gray-600">Current Energy:</label>
                <input type="text" id="chakra-current-energy" readonly class="w-full p-2 border border-gray-300 rounded-md bg-gray-100 text-sm">
            </div>
            <div class="form-group">
                <label for="chakra-damage-per-power" class="block mb-1 font-medium text-sm text-gray-600">Damage per Energy Point:</label>
                <input type="text" id="chakra-damage-per-power" placeholder="e.g., 0.5" value="1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-chakra focus:border-transparent text-sm">
            </div>
            <div class="form-group">
                <label for="chakra-regen-percent" class="block mb-1 font-medium text-sm text-gray-600">Regeneration Rate (% of Max):</label>
                <div class="flex items-center gap-2">
                    <input type="text" id="chakra-regen-percent" placeholder="e.g., 10" class="flex-grow p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-chakra focus:border-transparent text-sm">
                    <button data-type="chakra" class="regen-button px-3 py-2 bg-chakra text-white rounded-md hover:bg-chakra-dark focus:outline-none focus:ring-2 focus:ring-chakra focus:ring-offset-2 transition duration-150 ease-in-out text-sm font-semibold shadow-sm">Regen</button>
                </div>
            </div>
        </div>
    </div>

    <div class="energy-slider-container bg-white p-5 mb-5 rounded-lg shadow-sm">
        <label for="energy-slider" class="block mb-2 font-medium text-gray-600">Energy Used for Attack (% of Current):</label>
        <input type="range" id="energy-slider" class="energy-slider w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" min="0" max="100" value="50" aria-valuemin="0" aria-valuemax="100" aria-valuenow="50" role="slider">
        <div class="flex justify-between text-xs text-gray-500 mt-1 px-1">
            <span>0%</span>
            <span>25%</span>
            <span>50%</span>
            <span>75%</span>
            <span>100%</span>
        </div>
        <div class="mt-3 text-center text-sm font-medium text-success-dark bg-success-light p-2 rounded-md" id="energy-slider-value-display">
             50% (Energy Used: 0, Extra Damage: 0.00)
        </div>
    </div>

    <button id="calculate-btn" aria-label="Calculate final damage value" class="w-full px-4 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out text-lg font-semibold shadow-md mb-5">
        Calculate Damage
    </button>

    <div id="loading" class="loading text-center p-5 hidden">
        <div class="loading-spinner inline-block w-8 h-8 border-4 border-t-success border-gray-200 rounded-full animate-spin" aria-hidden="true"></div>
        <div class="loading-text mt-2 text-gray-600">Calculating...</div>
        <span class="sr-only">Loading, please wait</span>
    </div>

    <div id="result" class="result bg-success-light p-5 rounded-lg border-l-4 border-success shadow-sm hidden animate-fadeIn" aria-live="polite">
        <div class="result-title text-lg font-semibold mb-2 text-success-dark">Calculated Damage:</div>
        <div id="result-value" class="result-value text-3xl font-bold mb-3 break-words">0</div>
        <div id="result-details" class="result-details text-sm text-gray-700 mt-3 border-t border-success/30 pt-3">
            <p><strong>Energy Used:</strong> <span id="result-energy-used">0</span></p>
            <p><strong>Extra Damage from Energy:</strong> <span id="result-extra-damage">0.00</span></p>
            <hr class="my-2 border-success/20">
            <p><strong>Scientific Notation:</strong> <span id="result-scientific">0</span></p>
            <p><strong>In Words:</strong> <span id="result-words">Zero</span></p>
        </div>
    </div>


    <script>
        // --- DOM Element References ---
        const energyTypeSelect = document.getElementById('energy-type');
        const kiPoolDiv = document.getElementById('ki-pool');
        const nenPoolDiv = document.getElementById('nen-pool');
        const chakraPoolDiv = document.getElementById('chakra-pool');
        const energySlider = document.getElementById('energy-slider');
        const energySliderValueDisplay = document.getElementById('energy-slider-value-display');
        const calculateBtn = document.getElementById('calculate-btn');
        const resultDiv = document.getElementById('result');
        const resultValueEl = document.getElementById('result-value');
        const resultEnergyUsedEl = document.getElementById('result-energy-used');
        const resultExtraDamageEl = document.getElementById('result-extra-damage');
        const resultScientificEl = document.getElementById('result-scientific');
        const resultWordsEl = document.getElementById('result-words');
        const loadingDiv = document.getElementById('loading');
        const messageArea = document.getElementById('message-area');
        const dynamicModifiersContainer = document.getElementById('dynamic-modifiers-container');
        const addDynamicBoxBtn = document.getElementById('add-dynamic-box');

        // Input Fields (General)
        const baseDamageInput = document.getElementById('base-damage');
        const baseMultiplierInput = document.getElementById('base-multiplier');
        const formMultiplierInput = document.getElementById('form-multiplier');

        // --- Utility Functions ---

        // Safely parse float, returning 0 for invalid input, handling potential scientific notation
        function safeParseFloat(value, defaultValue = 0) {
            if (typeof value !== 'string' && typeof value !== 'number') return defaultValue;
            const num = parseFloat(String(value).replace(/,/g, '')); // Remove commas before parsing
            return isNaN(num) ? defaultValue : num;
        }

        // Format number for display
        function formatNumber(num) {
            if (typeof num !== 'number' || isNaN(num)) return '0';
            // Use toLocaleString for formatting, handle potential large/small numbers
             try {
                // Show more precision for smaller numbers, less for very large ones
                const options = (Math.abs(num) > 0 && Math.abs(num) < 0.01) || Math.abs(num) > 1e9
                    ? { notation: 'scientific', maximumFractionDigits: 2 }
                    : { maximumFractionDigits: 2 };
                return num.toLocaleString('en-US', options);
            } catch (e) {
                // Fallback for extremely large numbers that might break toLocaleString
                return num.toExponential(2);
            }
        }


        // Show messages (info, error, success)
        function showMessage(text, type = 'info') {
            messageArea.textContent = text;
            messageArea.className = 'mb-4 p-3 rounded-md text-sm'; // Reset classes
            messageArea.classList.remove('hidden');
            switch (type) {
                case 'error':
                    messageArea.classList.add('bg-error-light', 'text-error-dark', 'border', 'border-error');
                    break;
                case 'success':
                     messageArea.classList.add('bg-success-light', 'text-success-dark', 'border', 'border-success');
                    break;
                default: // info
                    messageArea.classList.add('bg-blue-100', 'text-blue-800', 'border', 'border-blue-300');
            }
            // Hide message after 5 seconds
            setTimeout(() => {
                messageArea.classList.add('hidden');
            }, 5000);
        }

        // Show/Hide Loading Indicator
        function showLoading(isLoading) {
            if (isLoading) {
                loadingDiv.classList.remove('hidden');
                resultDiv.classList.add('hidden'); // Hide old results
                calculateBtn.disabled = true;
                calculateBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                loadingDiv.classList.add('hidden');
                 calculateBtn.disabled = false;
                 calculateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // --- Energy Pool Logic ---

        function getEnergyElements(type) {
            return {
                maxEnergyEl: document.getElementById(`${type}-max-energy`),
                maxMultiplierEl: document.getElementById(`${type}-max-multiplier`),
                totalEnergyEl: document.getElementById(`${type}-total-energy`),
                currentEnergyEl: document.getElementById(`${type}-current-energy`),
                damagePerPowerEl: document.getElementById(`${type}-damage-per-power`),
                regenPercentEl: document.getElementById(`${type}-regen-percent`)
            };
        }

        // Calculate and update TOTAL energy for a type
        function calculateTotalEnergy(type) {
            const els = getEnergyElements(type);
            const maxEnergy = safeParseFloat(els.maxEnergyEl.value, 0);
            const multiplier = safeParseFloat(els.maxMultiplierEl.value, 1);
            const totalEnergy = maxEnergy * multiplier;

            els.totalEnergyEl.value = formatNumber(totalEnergy);

            // Initialize or update current energy if it's missing or exceeds new total
            let currentEnergy = safeParseFloat(els.currentEnergyEl.value, -1); // Use -1 to detect uninitialized
             if (currentEnergy === -1 || currentEnergy > totalEnergy) {
                 els.currentEnergyEl.value = formatNumber(totalEnergy);
             } else if (els.currentEnergyEl.value === '') { // Handle case where it was empty string
                 els.currentEnergyEl.value = formatNumber(totalEnergy);
             }
             // No change if current energy is valid and within bounds

            return totalEnergy;
        }

        // Regenerate CURRENT energy for a type
        function regenerateEnergy(type) {
            const els = getEnergyElements(type);
            const totalEnergy = safeParseFloat(els.totalEnergyEl.value.replace(/,/g, ''), 0); // Read calculated total
            let currentEnergy = safeParseFloat(els.currentEnergyEl.value.replace(/,/g, ''), 0);
            const regenPercent = safeParseFloat(els.regenPercentEl.value, 0);

            if (totalEnergy <= 0 || regenPercent <= 0) {
                showMessage('Cannot regenerate: Ensure Max Energy and Regen Rate are positive numbers.', 'error');
                return;
            }

            const regenAmount = totalEnergy * (regenPercent / 100);
            let newEnergy = currentEnergy + regenAmount;

            // Cap at total energy
            if (newEnergy > totalEnergy) {
                newEnergy = totalEnergy;
            }

            els.currentEnergyEl.value = formatNumber(newEnergy);
            showMessage(`${formatNumber(regenAmount)} energy regenerated for ${type.toUpperCase()}. Current: ${formatNumber(newEnergy)}`, 'success');
            updateSliderDisplay(); // Update slider display as current energy changed
            // No need to call updateDamageCalculations unless explicitly requested after regen
        }

        // Show only the selected energy pool
        function showSelectedEnergyPool() {
            const selectedType = energyTypeSelect.value;
            kiPoolDiv.style.display = selectedType === 'ki' ? 'block' : 'none';
            nenPoolDiv.style.display = selectedType === 'nen' ? 'block' : 'none';
            chakraPoolDiv.style.display = selectedType === 'chakra' ? 'block' : 'none';

            // Recalculate total/current for the selected pool if needed
            calculateTotalEnergy(selectedType);
            updateSliderDisplay(); // Update slider based on the newly selected pool's energy
        }

        // --- Dynamic Modifiers Logic ---
        let dynamicModifierCount = 0;

        function addDynamicModifier() {
            dynamicModifierCount++;
            const modifierId = `dynamic-modifier-${dynamicModifierCount}`;
            const newModifierDiv = document.createElement('div');
            newModifierDiv.className = 'dynamic-box additive p-4 mt-3 border rounded-md border-l-4 relative transition-all duration-300 ease-in-out bg-success-light border-success'; // Default to additive style
            newModifierDiv.id = modifierId;
            newModifierDiv.innerHTML = `
                <div class="absolute top-2 right-2">
                    <button class="remove-dynamic-box bg-error text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-error-dark focus:outline-none focus:ring-2 focus:ring-error focus:ring-offset-1" aria-label="Remove this modifier" data-target="${modifierId}">×</button>
                </div>
                <div class="modifier-type-selector flex gap-2 mb-3 border-b pb-2">
                    <div class="modifier-type-option additive active flex-1 p-2 text-center border rounded-md cursor-pointer transition-all duration-300 ease-in-out text-sm" data-value="additive" tabindex="0" role="radio" aria-checked="true">
                        <input type="radio" name="modifier-type-${modifierId}" value="additive" class="sr-only" checked>
                        Additive (+)
                    </div>
                    <div class="modifier-type-option multiplicative flex-1 p-2 text-center border rounded-md cursor-pointer transition-all duration-300 ease-in-out text-sm" data-value="multiplicative" tabindex="0" role="radio" aria-checked="false">
                        <input type="radio" name="modifier-type-${modifierId}" value="multiplicative" class="sr-only">
                        Multiplier (×)
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <div class="form-group">
                        <label for="modifier-name-${modifierId}" class="block mb-1 font-medium text-xs text-gray-600">Modifier Name:</label>
                        <input type="text" id="modifier-name-${modifierId}" placeholder="e.g., Buff" class="modifier-name-input w-full p-1.5 border border-gray-300 rounded-md focus:ring-1 focus:ring-success focus:border-transparent text-sm">
                    </div>
                    <div class="form-group">
                        <label for="modifier-value-${modifierId}" class="block mb-1 font-medium text-xs text-gray-600">Value:</label>
                        <input type="text" id="modifier-value-${modifierId}" placeholder="e.g., 50 or 1.2" value="0" class="modifier-value-input w-full p-1.5 border border-gray-300 rounded-md focus:ring-1 focus:ring-success focus:border-transparent text-sm">
                    </div>
                </div>
            `;
            dynamicModifiersContainer.appendChild(newModifierDiv);

            // Add event listeners for the new modifier box
            addListenersToModifierBox(newModifierDiv);
        }

        function addListenersToModifierBox(modifierDiv) {
            // Remove button listener
            modifierDiv.querySelector('.remove-dynamic-box').addEventListener('click', function() {
                document.getElementById(this.dataset.target)?.remove();
                // Optionally trigger recalculation: updateDamageCalculations();
            });

            // Type selector listener
            modifierDiv.querySelectorAll('.modifier-type-option').forEach(option => {
                option.addEventListener('click', function() {
                    const box = this.closest('.dynamic-box');
                    const value = this.dataset.value;
                    // Update radio state
                    box.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false);
                    this.querySelector('input[type="radio"]').checked = true;
                    // Update visual state
                    box.querySelectorAll('.modifier-type-option').forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                    // Update box style
                    box.classList.remove('additive', 'multiplicative', 'bg-success-light', 'border-success', 'bg-ki/10', 'border-ki');
                    if (value === 'additive') {
                        box.classList.add('additive', 'bg-success-light', 'border-success');
                    } else {
                        box.classList.add('multiplicative', 'bg-ki/10', 'border-ki');
                    }
                    // Optionally trigger recalculation: updateDamageCalculations();
                });
            });

             // Add input listeners to trigger calculation automatically (optional)
             modifierDiv.querySelectorAll('.modifier-name-input, .modifier-value-input').forEach(input => {
                 input.addEventListener('input', updateDamageCalculations);
             });
        }

        // --- Calculation Logic ---

        function updateSliderDisplay() {
            const sliderPercent = energySlider.value;
            const energyType = energyTypeSelect.value;
            const els = getEnergyElements(energyType);
            const currentEnergy = safeParseFloat(els.currentEnergyEl.value.replace(/,/g, ''), 0);
            const damagePerPower = safeParseFloat(els.damagePerPowerEl.value, 0);

            const energyUsed = currentEnergy * (sliderPercent / 100);
            const extraDamage = energyUsed * damagePerPower;

            energySliderValueDisplay.textContent = `${sliderPercent}% (Energy Used: ${formatNumber(energyUsed)}, Extra Damage: ${formatNumber(extraDamage)})`;
        }

        function performCalculation() {
            showLoading(true);

            // Use setTimeout to allow the loading spinner to render before heavy calculation
            setTimeout(() => {
                try {
                    const baseDamage = safeParseFloat(baseDamageInput.value, 0);
                    const baseMultiplier = safeParseFloat(baseMultiplierInput.value, 1);
                    const formMultiplier = safeParseFloat(formMultiplierInput.value, 1);
                    const energyType = energyTypeSelect.value;
                    const sliderPercent = safeParseFloat(energySlider.value, 0);

                    const els = getEnergyElements(energyType);
                    const currentEnergy = safeParseFloat(els.currentEnergyEl.value.replace(/,/g, ''), 0);
                    const damagePerPower = safeParseFloat(els.damagePerPowerEl.value, 0);

                    let finalDamage = baseDamage * baseMultiplier * formMultiplier;

                    // Apply dynamic modifiers
                    document.querySelectorAll('#dynamic-modifiers-container .dynamic-box').forEach(modifierDiv => {
                        const valueInput = modifierDiv.querySelector('.modifier-value-input');
                        const typeOption = modifierDiv.querySelector('.modifier-type-option.active');

                        if (valueInput && typeOption) {
                            const modifierValue = safeParseFloat(valueInput.value, 0);
                            const modifierType = typeOption.dataset.value;

                            if (modifierType === 'additive') {
                                finalDamage += modifierValue;
                            } else if (modifierType === 'multiplicative') {
                                // Ensure multiplier isn't zero unless intended
                                finalDamage *= (modifierValue === 0 && valueInput.value.trim() !== '0') ? 1 : modifierValue;
                            }
                        }
                    });

                    // Apply energy damage bonus
                    const energyUsed = currentEnergy * (sliderPercent / 100);
                    const extraDamage = energyUsed * damagePerPower;
                    finalDamage += extraDamage;

                    // Display results
                    resultValueEl.textContent = formatNumber(finalDamage);
                    resultEnergyUsedEl.textContent = formatNumber(energyUsed);
                    resultExtraDamageEl.textContent = formatNumber(extraDamage);
                    displayAllFormats(finalDamage); // Update scientific and words

                    resultDiv.classList.remove('hidden');
                    resultDiv.classList.remove('bg-error-light', 'border-error'); // Ensure correct styling
                    resultDiv.classList.add('bg-success-light', 'border-success');
                    showMessage('Calculation successful!', 'success');

                } catch (error) {
                    console.error("Calculation Error:", error);
                    resultValueEl.textContent = 'Error';
                    resultEnergyUsedEl.textContent = 'N/A';
                    resultExtraDamageEl.textContent = 'N/A';
                    resultScientificEl.textContent = 'N/A';
                    resultWordsEl.textContent = 'Error during calculation';
                    resultDiv.classList.remove('hidden');
                    resultDiv.classList.remove('bg-success-light', 'border-success'); // Ensure correct styling
                    resultDiv.classList.add('bg-error-light', 'border-error');
                    showMessage(`Calculation failed: ${error.message}`, 'error');
                } finally {
                    showLoading(false);
                }
            }, 50); // Small delay for UI update
        }

        // Update function called by various inputs
        function updateDamageCalculations() {
            // This can be used for real-time updates if desired,
            // or just call performCalculation() when the button is clicked.
            // For simplicity, we'll rely on the button click for the final result.
            updateSliderDisplay(); // Keep slider display updated
        }


        // --- Number Formatting (Scientific & Words) ---

        function displayAllFormats(damage) {
            try {
                // Scientific Notation
                 const scientificFormat = damage.toExponential(2).replace(/e\+?/, ' x 10^');
                 resultScientificEl.textContent = scientificFormat;
            } catch (e) {
                 resultScientificEl.textContent = "Invalid number";
            }

            try {
                // Words Format
                const wordsFormat = convertNumberToWords(damage);
                resultWordsEl.textContent = wordsFormat;
            } catch (e) {
                 resultWordsEl.textContent = "Error converting to words";
            }
        }

        function convertNumberToWords(number) {
            // Basic check for non-numeric or NaN/Infinity
            if (typeof number !== 'number' || !isFinite(number)) {
                return 'Invalid Number';
            }

            const numStr = String(number);
            const [integerPartStr, decimalPartStr] = numStr.split('.');
            let integerPart = BigInt(integerPartStr); // Use BigInt for large integers

            const units = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine', 'Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
            const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
            const scales = ['', 'Thousand', 'Million', 'Billion', 'Trillion', 'Quadrillion', 'Quintillion', 'Sextillion', 'Septillion', 'Octillion', 'Nonillion', 'Decillion']; // Simplified list, add more if needed

             if (integerPart === 0n && (!decimalPartStr || safeParseFloat('0.' + decimalPartStr) === 0)) {
                return 'Zero';
            }

            let words = '';
            let isNegative = false;

            if (integerPart < 0n) {
                isNegative = true;
                integerPart = -integerPart;
            }

            function convertHundreds(num) { // num is a number between 0 and 999
                let word = '';
                const hundred = Math.floor(num / 100);
                const remainder = num % 100;

                if (hundred > 0) {
                    word += units[hundred] + ' Hundred';
                }

                if (remainder > 0) {
                    if (word !== '') word += ' '; // Add space if hundred part exists
                    if (remainder < 20) {
                        word += units[remainder];
                    } else {
                        const tenDigit = Math.floor(remainder / 10);
                        const oneDigit = remainder % 10;
                        word += tens[tenDigit];
                        if (oneDigit > 0) {
                            word += '-' + units[oneDigit]; // e.g., Twenty-One
                        }
                    }
                }
                return word;
            }

            if (integerPart === 0n) {
                 words = ''; // Handle zero integer part later with decimals
            } else {
                let scaleIndex = 0;
                let tempWords = [];
                while (integerPart > 0n) {
                    if (scaleIndex >= scales.length) {
                        return "Number too large to represent in words";
                    }
                    const chunk = Number(integerPart % 1000n); // Convert chunk to Number for convertHundreds
                    if (chunk !== 0) {
                        const chunkWords = convertHundreds(chunk);
                        tempWords.push(chunkWords + (scaleIndex > 0 ? ' ' + scales[scaleIndex] : ''));
                    }
                    integerPart /= 1000n;
                    scaleIndex++;
                }
                 words = tempWords.reverse().join(', '); // Join scales with comma and space
            }


            // Handle Decimal Part
            if (decimalPartStr && safeParseFloat('0.' + decimalPartStr) !== 0) {
                 if (words !== '') words += ' Point'; // Add " point " if integer part exists
                 else words = 'Zero Point'; // If integer was zero

                 for (const digit of decimalPartStr) {
                     words += ' ' + units[parseInt(digit)] || 'Zero'; // Add each digit name
                 }
            }

             if (isNegative) {
                 words = 'Negative ' + words;
             }

            return words.trim() || 'Zero'; // Return trimmed or Zero if empty
        }


        // --- Event Listeners ---

        // Energy type change
        energyTypeSelect.addEventListener('change', showSelectedEnergyPool);

        // Slider input
        energySlider.addEventListener('input', updateSliderDisplay);

        // Calculate button click
        calculateBtn.addEventListener('click', performCalculation);

        // Add dynamic modifier button click
        addDynamicBoxBtn.addEventListener('click', addDynamicModifier);

        // Energy pool input changes (recalculate total energy and update slider)
        ['ki', 'nen', 'chakra'].forEach(type => {
            const els = getEnergyElements(type);
            els.maxEnergyEl.addEventListener('input', () => {
                calculateTotalEnergy(type);
                updateSliderDisplay();
            });
            els.maxMultiplierEl.addEventListener('input', () => {
                calculateTotalEnergy(type);
                updateSliderDisplay();
            });
             // Listen to damage per power changes for slider update
             els.damagePerPowerEl.addEventListener('input', updateSliderDisplay);
        });

        // Regeneration button clicks
        document.querySelectorAll('.regen-button').forEach(button => {
            button.addEventListener('click', function() {
                regenerateEnergy(this.dataset.type);
            });
        });

        // General damage modifier input changes (optional: trigger real-time calculation)
         baseDamageInput.addEventListener('input', updateDamageCalculations);
         baseMultiplierInput.addEventListener('input', updateDamageCalculations);
         formMultiplierInput.addEventListener('input', updateDamageCalculations);


        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            showSelectedEnergyPool(); // Show default pool (Ki) and calculate initial values
            updateSliderDisplay(); // Update slider display initially
        });

    </script>
</body>
</html>
