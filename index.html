<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Calculator - v7 (Full Result)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Energy types (matched with hex codes below)
                        ki: '#FF9800', nen: '#2196F3', chakra: '#9C27B0', magic: '#26a69a', cursed: '#dc2626',
                        reiatsu: '#475569', haki: '#1f2937', alchemy: '#f59e0b', nature: '#84cc16',
                        'ki-dark': '#e65100', 'nen-dark': '#0d47a1', 'chakra-dark': '#4a148c', 'magic-dark': '#00796b', 'cursed-dark': '#b91c1c',
                        'reiatsu-dark': '#1e293b', 'haki-dark': '#000000', 'alchemy-dark': '#b45309', 'nature-dark': '#4d7c0f',
                        // UI feedback
                        'success-light': '#e8f5e9', 'success': '#4CAF50', 'success-dark': '#2e7d32',
                        'error-light': '#ffebee', 'error': '#f44336', 'error-dark': '#c62828',
                        // Stats panel
                        'stats-border': '#60a5fa', 'stats-header': '#1e3a8a',
                        // Kaioken active state
                        'kaioken-border': '#f87171', 'kaioken-header': '#b91c1c', 'kaioken-focus': '#ef4444',
                        // Focus Rings per type (ensure these are used correctly in JS map)
                        'magic-focus': '#26a69a', 'cursed-focus': '#dc2626', 'reiatsu-focus': '#475569',
                        'haki-focus': '#1f2937', 'alchemy-focus': '#f59e0b', 'nature-focus': '#84cc16',
                        'ki-focus': '#FF9800', 'nen-focus': '#2196F3', 'chakra-focus': '#9C27B0' // Added matching focus rings
                    },
                    animation: {
                        spin: 'spin 1s linear infinite', shake: 'shake 0.5s ease-in-out', fadeIn: 'fadeIn 0.3s ease-in', pulse: 'pulse 1.5s infinite',
                        'pulse-additive': 'pulse-additive 0.5s', 'pulse-multiplicative': 'pulse-multiplicative 0.5s', 'pulse-result': 'pulse-result 0.3s ease-in-out',
                        'flash-red': 'flash-red-bg 0.5s ease-out', 'flash-green': 'flash-green-bg 0.5s ease-out', 'kaioken-glow': 'kaioken-glow 1.5s infinite ease-in-out',
                        // Dynamic glow animations linked in JS map
                        'animate-pulse-glow-ki': 'pulse-glow-ki 1.5s infinite ease-in-out',
                        'animate-pulse-glow-nen': 'pulse-glow-nen 1.5s infinite ease-in-out',
                        'animate-pulse-glow-chakra': 'pulse-glow-chakra 1.5s infinite ease-in-out',
                        'animate-pulse-glow-magic': 'pulse-glow-magic 1.5s infinite ease-in-out',
                        'animate-pulse-glow-cursed': 'pulse-glow-cursed 1.5s infinite ease-in-out',
                        'animate-pulse-glow-reiatsu': 'pulse-glow-reiatsu 1.5s infinite ease-in-out',
                        'animate-pulse-glow-haki': 'pulse-glow-haki 1.5s infinite ease-in-out',
                        'animate-pulse-glow-alchemy': 'pulse-glow-alchemy 1.5s infinite ease-in-out',
                        'animate-pulse-glow-nature': 'pulse-glow-nature 1.5s infinite ease-in-out',
                    },
                    keyframes: {
                        spin: { '0%': { transform: 'rotate(0deg)' }, '100%': { transform: 'rotate(360deg)' }, },
                        shake: { '0%, 100%': { transform: 'translateX(0)' }, '25%, 75%': { transform: 'translateX(-5px)' }, '50%': { transform: 'translateX(5px)' }, },
                        fadeIn: { from: { opacity: 0, transform: 'translateY(10px)' }, to: { opacity: 1, transform: 'translateY(0)' }, },
                        pulse: { '0%, 100%': { transform: 'scale(1)' }, '50%': { transform: 'scale(1.05)' }, },
                        'pulse-additive': { '0%, 100%': { color: '#558b2f' }, '50%': { color: '#8BC34A' }, },
                        'pulse-multiplicative': { '0%, 100%': { color: '#e65100' }, '50%': { color: '#FF9800' }, },
                        'pulse-result': { '0%, 100%': { transform: 'scale(1)' }, '50%': { transform: 'scale(1.05)' }, },
                        'flash-red-bg': { '50%': { backgroundColor: '#ffebee', borderColor: '#f44336' } },
                        'flash-green-bg': { '50%': { backgroundColor: '#e8f5e9', borderColor: '#4CAF50' } },
                        'kaioken-glow': { '0%, 100%': { boxShadow: `0 0 10px #f8717180` }, '50%': { boxShadow: `0 0 20px #f87171CC` } },
                        // Dynamic Glow Keyframes (ensure names match animation names)
                         'pulse-glow-ki': { '0%, 100%': { boxShadow: `0 0 8px #FF980066` }, '50%': { boxShadow: `0 0 16px #FF9800B3` } },
                         'pulse-glow-nen': { '0%, 100%': { boxShadow: `0 0 8px #2196F366` }, '50%': { boxShadow: `0 0 16px #2196F3B3` } },
                         'pulse-glow-chakra': { '0%, 100%': { boxShadow: `0 0 8px #9C27B066` }, '50%': { boxShadow: `0 0 16px #9C27B0B3` } },
                         'pulse-glow-magic': { '0%, 100%': { boxShadow: `0 0 8px #26a69a66` }, '50%': { boxShadow: `0 0 16px #26a69aB3` } },
                         'pulse-glow-cursed': { '0%, 100%': { boxShadow: `0 0 8px #dc262666` }, '50%': { boxShadow: `0 0 16px #dc2626B3` } },
                         'pulse-glow-reiatsu': { '0%, 100%': { boxShadow: `0 0 8px #47556966` }, '50%': { boxShadow: `0 0 16px #475569B3` } },
                         'pulse-glow-haki': { '0%, 100%': { boxShadow: `0 0 8px #1f293766` }, '50%': { boxShadow: `0 0 16px #1f2937B3` } },
                         'pulse-glow-alchemy': { '0%, 100%': { boxShadow: `0 0 8px #f59e0b66` }, '50%': { boxShadow: `0 0 16px #f59e0bB3` } },
                         'pulse-glow-nature': { '0%, 100%': { boxShadow: `0 0 8px #84cc1666` }, '50%': { boxShadow: `0 0 16px #84cc16B3` } },
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <style>
        /* Base Styles */
        body { font-family: 'Inter', sans-serif; background-color: #f9f9f9; color: #333; }
        .energy-pool { @apply p-5 mb-5 rounded-lg shadow-sm border-l-4; transition: box-shadow 0.3s ease-in-out, opacity 0.3s ease-in-out; }

        /* Dynamic Pool Styles */
        .energy-pool-ki { border-left-color: #FF9800; } .energy-pool-ki h3 { color: #e65100; }
        .energy-pool-nen { border-left-color: #2196F3; } .energy-pool-nen h3 { color: #0d47a1; }
        .energy-pool-chakra { border-left-color: #9C27B0; } .energy-pool-chakra h3 { color: #4a148c; }
        .energy-pool-magic { border-left-color: #26a69a; } .energy-pool-magic h3 { color: #00796b; }
        .energy-pool-cursed { border-left-color: #dc2626; } .energy-pool-cursed h3 { color: #b91c1c; }
        .energy-pool-reiatsu { border-left-color: #475569; } .energy-pool-reiatsu h3 { color: #1e293b; }
        .energy-pool-haki { border-left-color: #1f2937; } .energy-pool-haki h3 { color: #000000; }
        .energy-pool-alchemy { border-left-color: #f59e0b; } .energy-pool-alchemy h3 { color: #b45309; }
        .energy-pool-nature { border-left-color: #84cc16; } .energy-pool-nature h3 { color: #4d7c0f; }

        /* Base Slider Track */
        .energy-slider { @apply w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer; }
        /* Base Slider Thumb */
        .energy-slider::-webkit-slider-thumb { appearance: none; width: 20px; height: 20px; border-radius: 50%; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.2); transition: background 0.3s; border: none; }
        .energy-slider::-moz-range-thumb { width: 20px; height: 20px; border-radius: 50%; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.2); transition: background 0.3s; border: none; }

        /* Slider Thumb Colors (Using direct Hex Codes) */
        #ki-energy-slider::-webkit-slider-thumb { background: #FF9800; } #ki-energy-slider::-moz-range-thumb { background: #FF9800; }
        #nen-energy-slider::-webkit-slider-thumb { background: #2196F3; } #nen-energy-slider::-moz-range-thumb { background: #2196F3; }
        #chakra-energy-slider::-webkit-slider-thumb { background: #9C27B0; } #chakra-energy-slider::-moz-range-thumb { background: #9C27B0; }
        #magic-energy-slider::-webkit-slider-thumb { background: #26a69a; } #magic-energy-slider::-moz-range-thumb { background: #26a69a; }
        #cursed-energy-slider::-webkit-slider-thumb { background: #dc2626; } #cursed-energy-slider::-moz-range-thumb { background: #dc2626; }
        #reiatsu-energy-slider::-webkit-slider-thumb { background: #475569; } #reiatsu-energy-slider::-moz-range-thumb { background: #475569; }
        #haki-energy-slider::-webkit-slider-thumb { background: #1f2937; } #haki-energy-slider::-moz-range-thumb { background: #1f2937; }
        #alchemy-energy-slider::-webkit-slider-thumb { background: #f59e0b; } #alchemy-energy-slider::-moz-range-thumb { background: #f59e0b; }
        #nature-energy-slider::-webkit-slider-thumb { background: #84cc16; } #nature-energy-slider::-moz-range-thumb { background: #84cc16; }

        /* Slider Thumb Hover Colors (Using direct Hex Codes) */
        #ki-energy-slider:hover::-webkit-slider-thumb { background: #e65100; } #ki-energy-slider:hover::-moz-range-thumb { background: #e65100; }
        #nen-energy-slider:hover::-webkit-slider-thumb { background: #0d47a1; } #nen-energy-slider:hover::-moz-range-thumb { background: #0d47a1; }
        #chakra-energy-slider:hover::-webkit-slider-thumb { background: #4a148c; } #chakra-energy-slider:hover::-moz-range-thumb { background: #4a148c; }
        #magic-energy-slider:hover::-webkit-slider-thumb { background: #00796b; } #magic-energy-slider:hover::-moz-range-thumb { background: #00796b; }
        #cursed-energy-slider:hover::-webkit-slider-thumb { background: #b91c1c; } #cursed-energy-slider:hover::-moz-range-thumb { background: #b91c1c; }
        #reiatsu-energy-slider:hover::-webkit-slider-thumb { background: #1e293b; } #reiatsu-energy-slider:hover::-moz-range-thumb { background: #1e293b; }
        #haki-energy-slider:hover::-webkit-slider-thumb { background: #000000; } #haki-energy-slider:hover::-moz-range-thumb { background: #000000; }
        #alchemy-energy-slider:hover::-webkit-slider-thumb { background: #b45309; } #alchemy-energy-slider:hover::-moz-range-thumb { background: #b45309; }
        #nature-energy-slider:hover::-webkit-slider-thumb { background: #4d7c0f; } #nature-energy-slider:hover::-moz-range-thumb { background: #4d7c0f; }

        /* Other Styles */
        .modifier-type-option.additive { border-color: theme('colors.success'); color: theme('colors.success-dark'); }
        .modifier-type-option.additive.active { background-color: theme('colors.success-light'); box-shadow: 0 1px 5px rgba(76, 175, 80, 0.3); animation: pulse-additive 0.5s; color: theme('colors.success'); }
        .modifier-type-option.multiplicative { border-color: theme('colors.ki'); color: theme('colors.ki-dark'); }
        .modifier-type-option.multiplicative.active { background-color: theme('colors.ki / 0.1'); box-shadow: 0 1px 5px rgba(255, 152, 0, 0.3); animation: pulse-multiplicative 0.5s; color: theme('colors.ki'); }
        .animate-pulse-result { animation: pulse-result 0.3s ease-in-out; }
        .animate-flash-red { animation: flash-red-bg 0.5s ease-out; }
        .animate-flash-green { animation: flash-green-bg 0.5s ease-out; }
        .animate-kaioken-glow { animation: kaioken-glow 1.5s infinite ease-in-out; }
        /* Static Glow classes */
        .static-glow-ki { box-shadow: 0 0 10px #FF980080; } .static-glow-nen { box-shadow: 0 0 10px #2196F380; } .static-glow-chakra { box-shadow: 0 0 10px #9C27B080; } .static-glow-magic { box-shadow: 0 0 10px #26a69a80; } .static-glow-cursed { box-shadow: 0 0 10px #dc262680; } .static-glow-reiatsu { box-shadow: 0 0 10px #47556980; } .static-glow-haki { box-shadow: 0 0 10px #1f293780; } .static-glow-alchemy { box-shadow: 0 0 10px #f59e0b80; } .static-glow-nature { box-shadow: 0 0 10px #84cc1680; }

        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }
        .stats-panel { border-left-width: 4px; transition: border-color 0.3s ease-in-out, box-shadow 1.5s ease-in-out; }
        .stats-panel-header { transition: color 0.3s ease-in-out; }
        .lbl { @apply block mb-1 font-medium text-sm text-gray-600; }
        .inpt { @apply w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:border-transparent text-sm transition-colors duration-300; }
        /* .inpt-ro class is removed */
        .regen-btn { @apply px-3 py-2 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 transition-all duration-150 ease-in-out text-sm font-semibold shadow-sm active:scale-95; }
        .save-load-btn { @apply px-3 py-1 text-sm text-white rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-1 transition-all duration-150 ease-in-out active:scale-95; }

        /* Style for the new span elements replacing readonly inputs */
        .readonly-display {
            @apply inline-block font-medium text-gray-800 min-h-[42px] px-2 py-2 w-full bg-gray-50 rounded-md border border-gray-200; /* Mimic input height and padding, subtle background */
            line-height: 1.5; /* Adjust line height for vertical centering if needed */
            word-break: break-all; /* Allow long numbers without spaces to break */
        }

    </style>
</head>
<body class="p-4 md:p-6">

    <div class="mb-4 flex gap-2">
        <button id="save-state-btn" class="save-load-btn bg-blue-500 hover:bg-blue-600 focus:ring-blue-400">Save State</button>
        <button id="load-state-btn" class="save-load-btn bg-gray-500 hover:bg-gray-600 focus:ring-gray-400">Load State</button>
        <button id="clear-state-btn" class="save-load-btn bg-red-500 hover:bg-red-600 focus:ring-red-400">Clear Saved</button>
    </div>
    <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">Energy Calculator</h1>

    <div class="flex flex-col md:flex-row gap-6 max-w-7xl mx-auto">

        <div class="flex-grow md:w-3/4">

            <div id="message-area" class="mb-4 p-3 rounded-md text-sm hidden" role="alert"></div>

            <div class="energy-pool bg-white p-5 mb-5 rounded-lg shadow-sm border-l-4 border-gray-400">
                 <h3 class="text-xl font-semibold mb-4 flex items-center"> Damage Modifiers <span class="flex-grow h-px bg-gray-200 ml-3"></span> </h3>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                     <div><label for="base-damage" class="lbl">Base Damage:</label><input type="text" id="base-damage" placeholder="e.g., 100 or 1,000" aria-required="true" class="inpt focus:ring-success"></div>
                     <div><label for="attack-compression-points" class="lbl">Attack Compression Points:</label><input type="text" id="attack-compression-points" placeholder="e.g., 10 or 1,000" value="0" class="inpt focus:ring-red-500"></div>
                     <div><label for="base-multiplier" class="lbl">Base Multiplier:</label><input type="text" id="base-multiplier" placeholder="e.g., 1.5" value="1" class="inpt focus:ring-success"></div>
                     <div><label for="form-multiplier" class="lbl">Form Multiplier:</label><input type="text" id="form-multiplier" placeholder="e.g., 2" value="1" class="inpt focus:ring-success"></div>
                 </div>
                 <div id="dynamic-modifiers-container" class="mb-4"><h4 class="text-md font-semibold mb-2 text-gray-700">Additional Factors:</h4></div>
                 <button id="add-dynamic-box" aria-label="Add modifier factor" class="px-4 py-2 bg-chakra text-white rounded-md hover:bg-chakra-dark focus:outline-none focus:ring-2 focus:ring-chakra focus:ring-offset-2 transition-all duration-150 ease-in-out text-sm font-semibold shadow-sm active:scale-95"> Add Factor </button>
            </div>

            <div class="form-group mb-5">
                 <label for="energy-type" class="lbl">Energy Type:</label>
                 <select id="energy-type" aria-label="Select energy type" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-success focus:border-transparent text-sm bg-white">
                     <option value="ki">Ki Energy</option> <option value="nen">Nen Energy</option> <option value="chakra">Chakra Energy</option> <option value="magic">Magic Energy</option> <option value="cursed">Cursed Energy</option> <option value="reiatsu">Reiatsu</option> <option value="haki">Haki</option> <option value="alchemy">Alchemy</option> <option value="nature">Nature Energy</option>
                 </select>
            </div>

            <div id="energy-pools-container" class="mb-5">
                </div>

            <div id="all-sliders-container" class="bg-white p-5 mb-5 rounded-lg shadow-sm">
                <h3 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">Energy Usage Sliders</h3>
                <div id="sliders-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-4">
                    </div>
            </div>

            <button id="calculate-btn" aria-label="Calculate final damage value" class="w-full px-4 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-150 ease-in-out text-lg font-semibold shadow-md mb-5 active:scale-95"> Calculate Damage </button>
            <div id="loading" class="loading text-center p-5 hidden">
                <div class="loading-spinner inline-block w-8 h-8 border-4 border-t-success border-gray-200 rounded-full animate-spin" aria-hidden="true"></div>
                <div class="loading-text mt-2 text-gray-600">Calculating...</div><span class="sr-only">Loading, please wait</span>
             </div>
            <div id="result" class="result bg-success-light p-5 rounded-lg border-l-4 border-success shadow-sm hidden animate-fadeIn" aria-live="polite">
                <div class="result-title text-lg font-semibold mb-2 text-success-dark">Calculated Damage:</div>
                <div id="result-value" class="result-value text-3xl font-bold mb-3 break-words">0</div>
                <div id="result-details" class="result-details text-sm text-gray-700 mt-3 border-t border-success/30 pt-3">
                    <p><strong>Total Energy Used:</strong> <span id="result-total-energy-used">0</span></p>
                    <p><strong>Total Extra Damage from Energy:</strong> <span id="result-total-extra-damage">0.00</span></p>
                    <hr class="my-2 border-success/20">
                    <p><strong>Scientific Notation:</strong> <span id="result-scientific">0</span></p>
                    <p><strong>In Words:</strong> <span id="result-words">Zero</span></p>
                </div>
             </div>

        </div> <div id="stats-panel" class="stats-panel md:w-1/4 lg:w-1/5 p-5 bg-white rounded-lg shadow-sm self-start sticky top-6 border-stats-border">
             <h3 id="stats-panel-header" class="stats-panel-header text-xl font-semibold mb-4 flex items-center text-stats-header"> Stats <span class="flex-grow h-px bg-gray-200 ml-3"></span> </h3>
             <div class="space-y-3">
                 <p class="text-sm text-gray-600">Selected Current Energy: <span id="stat-current-energy" class="font-medium text-gray-800 break-words">0</span></p>
                 <hr class="border-gray-200">
                 <p class="text-sm text-gray-600">Total Damage Dealt: <span id="stat-total-damage" class="font-medium text-gray-800 break-words">0</span></p>
                 <p class="text-sm text-gray-600">Calculations Performed: <span id="stat-calculation-count" class="font-medium text-gray-800 break-words">0</span></p>
                 <p class="text-sm text-gray-600">Active Energy Type: <span id="stat-active-energy-type" class="font-medium text-gray-800 capitalize">N/A</span></p>
             </div>
        </div> </div> <script>
        // Minimal JS to demonstrate interaction placeholders
        document.addEventListener('DOMContentLoaded', () => {
            // --- Element References ---
            const energyTypeSelect = document.getElementById('energy-type');
            const statsPanel = document.getElementById('stats-panel');
            const statsPanelHeader = document.getElementById('stats-panel-header');
            const statActiveEnergyType = document.getElementById('stat-active-energy-type');
            const statCurrentEnergy = document.getElementById('stat-current-energy');
            const energyPoolsContainer = document.getElementById('energy-pools-container');
            const slidersGrid = document.getElementById('sliders-grid');
            const baseDamageInput = document.getElementById('base-damage');
            const resultDiv = document.getElementById('result');
            const resultValue = document.getElementById('result-value');
            const calculateBtn = document.getElementById('calculate-btn');
            const loadingDiv = document.getElementById('loading');
            const messageArea = document.getElementById('message-area'); // Added message area reference
            const addDynamicBoxBtn = document.getElementById('add-dynamic-box');
            const dynamicModifiersContainer = document.getElementById('dynamic-modifiers-container');

            // --- Energy Type Configuration ---
            const energyTypes = {
                ki: { name: 'Ki Energy', color: 'ki', focus: 'ki-focus', border: 'stats-border-ki', header: 'stats-header-ki', glow: 'animate-pulse-glow-ki', staticGlow: 'static-glow-ki' },
                nen: { name: 'Nen Energy', color: 'nen', focus: 'nen-focus', border: 'stats-border-nen', header: 'stats-header-nen', glow: 'animate-pulse-glow-nen', staticGlow: 'static-glow-nen' },
                chakra: { name: 'Chakra Energy', color: 'chakra', focus: 'chakra-focus', border: 'stats-border-chakra', header: 'stats-header-chakra', glow: 'animate-pulse-glow-chakra', staticGlow: 'static-glow-chakra' },
                magic: { name: 'Magic Energy', color: 'magic', focus: 'magic-focus', border: 'stats-border-magic', header: 'stats-header-magic', glow: 'animate-pulse-glow-magic', staticGlow: 'static-glow-magic' },
                cursed: { name: 'Cursed Energy', color: 'cursed', focus: 'cursed-focus', border: 'stats-border-cursed', header: 'stats-header-cursed', glow: 'animate-pulse-glow-cursed', staticGlow: 'static-glow-cursed' },
                reiatsu: { name: 'Reiatsu', color: 'reiatsu', focus: 'reiatsu-focus', border: 'stats-border-reiatsu', header: 'stats-header-reiatsu', glow: 'animate-pulse-glow-reiatsu', staticGlow: 'static-glow-reiatsu' },
                haki: { name: 'Haki', color: 'haki', focus: 'haki-focus', border: 'stats-border-haki', header: 'stats-header-haki', glow: 'animate-pulse-glow-haki', staticGlow: 'static-glow-haki' },
                alchemy: { name: 'Alchemy', color: 'alchemy', focus: 'alchemy-focus', border: 'stats-border-alchemy', header: 'stats-header-alchemy', glow: 'animate-pulse-glow-alchemy', staticGlow: 'static-glow-alchemy' },
                nature: { name: 'Nature Energy', color: 'nature', focus: 'nature-focus', border: 'stats-border-nature', header: 'stats-header-nature', glow: 'animate-pulse-glow-nature', staticGlow: 'static-glow-nature' }
            };

            let modifierCount = 0; // Counter for dynamic modifiers

            // --- Functions ---

            function updateStatsPanelStyle(type) {
                 const config = energyTypes[type];
                 if (!config || !statsPanel || !statsPanelHeader || !statActiveEnergyType) return; // Add null checks

                 // Robustly remove previous styles
                 const classesToRemove = Object.values(energyTypes).flatMap(e => [
                    `border-${e.color}`, `animate-${e.glow}`, e.staticGlow, `text-${e.color}-dark`
                 ]);
                 statsPanel.classList.remove(...classesToRemove.filter(c => c)); // Remove border, animation, glow
                 statsPanelHeader.classList.remove(...Object.values(energyTypes).map(e => `text-${e.color}-dark`).filter(c => c)); // Remove text color

                 // Add new styles
                 statsPanel.classList.add(`border-${config.color}`);
                 statsPanel.classList.add(config.staticGlow);
                 statsPanelHeader.classList.add(`text-${config.color}-dark`);
                 statActiveEnergyType.textContent = config.name;
                 statActiveEnergyType.className = `font-medium text-${config.color}-dark capitalize`;
            }

            function addEnergyPool(type) {
                 const config = energyTypes[type];
                 if (!config || document.getElementById(`${type}-energy-pool`)) return; // Don't add if exists

                 const poolDiv = document.createElement('div');
                 poolDiv.id = `${type}-energy-pool`;
                 poolDiv.className = `energy-pool energy-pool-${type} bg-white`;
                 poolDiv.innerHTML = `
                     <h3 class="text-xl font-semibold mb-4 flex items-center">${config.name} Pool<span class="flex-grow h-px bg-gray-200 ml-3"></span></h3>
                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                         <div><label for="${type}-current-energy" class="lbl">Current Energy:</label><input type="text" id="${type}-current-energy" value="1000" placeholder="e.g., 1,000" class="inpt focus:ring-${config.focus}"></div>
                         <div><label for="${type}-max-energy" class="lbl">Max Energy:</label><span id="${type}-max-energy-display" class="readonly-display">1000</span></div>
                         <div><label for="${type}-regen-rate" class="lbl">Regen Rate (/sec):</label><input type="text" id="${type}-regen-rate" value="10" placeholder="e.g., 10" class="inpt focus:ring-${config.focus}"></div>
                         <div><label for="${type}-conversion-ratio" class="lbl">Damage Conversion Ratio:</label><input type="text" id="${type}-conversion-ratio" value="0.1" placeholder="e.g., 0.1" class="inpt focus:ring-${config.focus}"></div>
                     </div>
                     <button id="regen-${type}-btn" class="regen-btn bg-${config.color} hover:bg-${config.color}-dark focus:ring-${config.focus} mt-4">Regenerate</button>
                 `;
                 energyPoolsContainer.appendChild(poolDiv);

                 const currentEnergyInput = poolDiv.querySelector(`#${type}-current-energy`);
                 if (currentEnergyInput && statCurrentEnergy) {
                    currentEnergyInput.addEventListener('input', () => {
                        if (type === energyTypeSelect.value) {
                            // Update stat panel, removing commas for internal consistency if needed, but display might keep them
                             statCurrentEnergy.textContent = currentEnergyInput.value || '0';
                        }
                        // Maybe update max energy display too if it's linked
                        const maxDisplay = document.getElementById(`${type}-max-energy-display`);
                        if(maxDisplay) maxDisplay.textContent = currentEnergyInput.value || '1000'; // Example: Link max to current for simplicity
                    });
                     if (type === energyTypeSelect.value) {
                        statCurrentEnergy.textContent = currentEnergyInput.value || '0';
                    }
                 }

                 const regenBtn = poolDiv.querySelector(`#regen-${type}-btn`);
                 if(regenBtn) {
                     regenBtn.addEventListener('click', () => {
                         console.log(`Regenerating ${config.name}...`);
                         // Add actual regeneration logic here (e.g., increment current energy input value)
                         showMessage(`${config.name} regeneration triggered (simulation).`, 'info');
                     });
                 }
            }

            function addEnergySlider(type) {
                const config = energyTypes[type];
                 if (!config || document.getElementById(`${type}-slider-container`)) return; // Don't add if exists

                const sliderContainer = document.createElement('div');
                sliderContainer.id = `${type}-slider-container`;
                sliderContainer.className = 'mb-2';
                sliderContainer.innerHTML = `
                    <label for="${type}-energy-slider" class="lbl text-sm mb-1">${config.name} Usage (<span id="${type}-slider-value">0</span>%):</label>
                    <input type="range" id="${type}-energy-slider" name="${type}-energy-slider" min="0" max="100" value="0" class="energy-slider">
                `;
                slidersGrid.appendChild(sliderContainer);

                const slider = sliderContainer.querySelector(`#${type}-energy-slider`);
                const valueDisplay = sliderContainer.querySelector(`#${type}-slider-value`);
                if(slider && valueDisplay) {
                    slider.addEventListener('input', (e) => {
                        valueDisplay.textContent = e.target.value;
                    });
                }
            }

            function setupInitialState() {
                 // Example: Initially add a few pools/sliders or load from saved state
                 ['ki', 'nen', 'chakra'].forEach(type => {
                     addEnergyPool(type);
                     addEnergySlider(type);
                 });
                 updateStatsPanelStyle(energyTypeSelect.value);
                 // Trigger update for the initially selected energy type's current value stat
                 const initialType = energyTypeSelect.value;
                 const initialCurrentInput = document.getElementById(`${initialType}-current-energy`);
                 if (initialCurrentInput && statCurrentEnergy) {
                     statCurrentEnergy.textContent = initialCurrentInput.value || '0';
                 }
            }

            // Helper to show messages
            function showMessage(message, type = 'info') {
                if (!messageArea) return;
                messageArea.textContent = message;
                let bgColor = 'bg-blue-100';
                let textColor = 'text-blue-800';
                let borderColor = 'border-blue-300';

                if (type === 'success') {
                    bgColor = 'bg-success-light'; textColor = 'text-success-dark'; borderColor = 'border-success';
                } else if (type === 'error') {
                    bgColor = 'bg-error-light'; textColor = 'text-error-dark'; borderColor = 'border-error';
                } // Keep 'info' as default blue

                messageArea.className = `mb-4 p-3 rounded-md text-sm ${bgColor} ${textColor} border ${borderColor}`;
                messageArea.classList.remove('hidden');

                setTimeout(() => {
                    messageArea.classList.add('hidden');
                }, 4000);
            }


            // --- Event Listeners ---

            // Main energy type dropdown
            energyTypeSelect.addEventListener('change', (e) => {
                const selectedType = e.target.value;
                updateStatsPanelStyle(selectedType);

                const currentEnergyInput = document.getElementById(`${selectedType}-current-energy`);
                 if (currentEnergyInput && statCurrentEnergy) {
                     statCurrentEnergy.textContent = currentEnergyInput.value || '0';
                 } else {
                     statCurrentEnergy.textContent = 'N/A';
                     // Optionally add the pool/slider if they don't exist on selection
                     if (!document.getElementById(`${selectedType}-energy-pool`)) addEnergyPool(selectedType);
                     if (!document.getElementById(`${selectedType}-slider-container`)) addEnergySlider(selectedType);
                     // Re-check for input after adding
                      const newlyAddedInput = document.getElementById(`${selectedType}-current-energy`);
                      if(newlyAddedInput) statCurrentEnergy.textContent = newlyAddedInput.value || '0';

                 }
            });

             // Calculate button
             calculateBtn.addEventListener('click', () => {
                 // Basic validation for Base Damage
                 const baseDamageValue = baseDamageInput.value.replace(/,/g, ''); // Clean commas for validation too
                 if (!baseDamageValue || isNaN(parseFloat(baseDamageValue))) {
                     showMessage('Please enter a valid numeric Base Damage.', 'error');
                     baseDamageInput.focus();
                     baseDamageInput.classList.add('animate-flash-red');
                     setTimeout(()=> baseDamageInput.classList.remove('animate-flash-red'), 500);
                     return;
                 }

                 loadingDiv.classList.remove('hidden');
                 resultDiv.classList.add('hidden');
                 messageArea.classList.add('hidden'); // Hide previous messages

                 // Simulate calculation delay
                 setTimeout(() => {
                     try {
                         // --- Calculation Logic with Comma Handling ---
                         let baseDamage = parseFloat(baseDamageInput.value.replace(/,/g, '')) || 0;
                         let baseMultiplier = parseFloat(document.getElementById('base-multiplier').value.replace(/,/g, '')) || 1;
                         let formMultiplier = parseFloat(document.getElementById('form-multiplier').value.replace(/,/g, '')) || 1;
                         let attackCompressionPoints = parseFloat(document.getElementById('attack-compression-points').value.replace(/,/g, '')) || 0;
                         let totalEnergyUsed = 0;
                         let totalExtraDamage = 0;

                         // Process dynamic modifiers (handle commas)
                         document.querySelectorAll('.dynamic-modifier-value').forEach(input => {
                            let value = parseFloat(input.value.replace(/,/g, '')) || 0; // Assuming default 0, adjust if multiplicative logic added
                            // Current simple logic: multiplies into baseMultiplier
                            if (value !== 0) baseMultiplier *= value; // Be cautious if multiplier is intended and value is 0
                         });


                         // Sum energy usage and calculate extra damage (handle commas)
                         Object.keys(energyTypes).forEach(type => {
                             const slider = document.getElementById(`${type}-energy-slider`);
                             const currentEnergyInput = document.getElementById(`${type}-current-energy`);
                             const conversionRatioInput = document.getElementById(`${type}-conversion-ratio`);

                             if (slider && currentEnergyInput && conversionRatioInput) {
                                 const percentage = parseFloat(slider.value) || 0; // Range slider value is typically safe
                                 const currentEnergy = parseFloat(currentEnergyInput.value.replace(/,/g, '')) || 0;
                                 const conversionRatio = parseFloat(conversionRatioInput.value.replace(/,/g, '')) || 0;

                                  // Add safety check for NaN values after parsing
                                  if (!isNaN(percentage) && !isNaN(currentEnergy) && !isNaN(conversionRatio)) {
                                     const energyToUse = (currentEnergy * percentage) / 100;
                                     totalEnergyUsed += energyToUse;
                                     totalExtraDamage += energyToUse * conversionRatio;

                                     // TODO: Implement energy deduction from the input field if desired
                                     // Example: currentEnergyInput.value = (currentEnergy - energyToUse).toString();
                                     // Need to handle formatting (adding commas back?) if updating input visually
                                  } else {
                                      console.warn(`Invalid number input for energy type ${type}. Skipping its contribution.`);
                                      // Optionally, notify the user which input is bad
                                      // showMessage(`Invalid number for ${energyTypes[type].name} inputs.`, 'error');
                                  }
                             }
                         });

                         // --- Final Damage Calculation ---
                         // Choose ONE of these lines based on how Attack Compression should work:
                         // 1. Original (Compression ignored):
                         // let finalDamage = (baseDamage + totalExtraDamage) * baseMultiplier * formMultiplier;
                         // 2. Compression adds to base damage:
                         let finalDamage = (baseDamage + attackCompressionPoints + totalExtraDamage) * baseMultiplier * formMultiplier;
                         // 3. Compression is multiplicative (ensure default isn't 0 if unused):
                         // let finalDamage = (baseDamage + totalExtraDamage) * baseMultiplier * formMultiplier * (attackCompressionPoints || 1); // Example default 1


                         // --- Display Results ---
                         resultValue.textContent = finalDamage.toLocaleString();
                         document.getElementById('result-total-energy-used').textContent = totalEnergyUsed.toLocaleString();
                         document.getElementById('result-total-extra-damage').textContent = totalExtraDamage.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                         document.getElementById('result-scientific').textContent = finalDamage.toExponential(2);
                         document.getElementById('result-words').textContent = "Number to words conversion not implemented"; // Placeholder

                         loadingDiv.classList.add('hidden');
                         resultDiv.classList.remove('hidden');
                         resultDiv.classList.add('animate-pulse-result');
                         setTimeout(() => resultDiv.classList.remove('animate-pulse-result'), 300);

                         // --- Update Stats Panel ---
                         const totalDamageStat = document.getElementById('stat-total-damage');
                         const calcCountStat = document.getElementById('stat-calculation-count');
                          // Format stats with commas too for consistency
                          let currentTotalDamage = parseFloat(totalDamageStat.textContent.replace(/,/g, '')) || 0;
                          totalDamageStat.textContent = (currentTotalDamage + finalDamage).toLocaleString();
                          calcCountStat.textContent = (parseInt(calcCountStat.textContent.replace(/,/g, '')) || 0) + 1;

                     } catch (error) {
                         console.error("Calculation error:", error);
                         loadingDiv.classList.add('hidden');
                         showMessage(`Calculation failed: ${error.message}`, 'error');
                     }

                 }, 500); // Slightly reduced delay
             });


             // Add Dynamic Modifier Box Functionality
             addDynamicBoxBtn.addEventListener('click', () => {
                 modifierCount++;
                 const modifierDiv = document.createElement('div');
                 modifierDiv.className = 'dynamic-modifier-box flex items-center gap-2 mb-2 animate-fadeIn';
                 modifierDiv.innerHTML = `
                     <input type="text" placeholder="Factor Name ${modifierCount}" class="inpt flex-grow focus:ring-chakra">
                     <input type="text" placeholder="Value (e.g., 1.2 or 1,000)" class="inpt w-1/3 dynamic-modifier-value focus:ring-chakra">
                     <button class="remove-modifier-btn px-2 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600 active:scale-95" aria-label="Remove factor ${modifierCount}">X</button>
                 `;
                 dynamicModifiersContainer.appendChild(modifierDiv);

                 modifierDiv.querySelector('.remove-modifier-btn').addEventListener('click', () => {
                     modifierDiv.remove();
                     // Optional: Renumber remaining factors if needed for labels
                 });
             });


            // --- Save/Load/Clear Functionality ---
            document.getElementById('save-state-btn')?.addEventListener('click', () => {
                 try {
                     const state = {
                         baseDamage: document.getElementById('base-damage')?.value,
                         baseMultiplier: document.getElementById('base-multiplier')?.value,
                         formMultiplier: document.getElementById('form-multiplier')?.value,
                         attackCompression: document.getElementById('attack-compression-points')?.value,
                         selectedEnergyType: document.getElementById('energy-type')?.value,
                         energyPools: {},
                         energySliders: {},
                         dynamicModifiers: []
                     };

                     // Save energy pool data (saves values as they are in inputs, commas included)
                     document.querySelectorAll('[id$="-energy-pool"]').forEach(pool => {
                         const type = pool.id.replace('-energy-pool', '');
                         state.energyPools[type] = {
                             current: document.getElementById(`${type}-current-energy`)?.value,
                             regen: document.getElementById(`${type}-regen-rate`)?.value,
                             ratio: document.getElementById(`${type}-conversion-ratio`)?.value
                             // Max energy isn't saved, assumed linked to current or fixed
                         };
                     });

                     // Save slider data
                     document.querySelectorAll('.energy-slider').forEach(slider => {
                          const type = slider.id.replace('-energy-slider', '');
                          state.energySliders[type] = slider.value;
                      });

                     // Save dynamic modifiers
                     document.querySelectorAll('.dynamic-modifier-box').forEach(box => {
                         const nameInput = box.querySelector('input[type="text"]:first-of-type');
                         const valueInput = box.querySelector('.dynamic-modifier-value');
                         if (nameInput && valueInput) {
                             state.dynamicModifiers.push({ name: nameInput.value, value: valueInput.value });
                         }
                     });

                     localStorage.setItem('energyCalculatorStateV7', JSON.stringify(state));
                     showMessage('State saved successfully!', 'success');
                 } catch (e) {
                     console.error("Error saving state:", e);
                     showMessage('Error saving state.', 'error');
                 }
            });

            document.getElementById('load-state-btn')?.addEventListener('click', () => {
                 const savedState = localStorage.getItem('energyCalculatorStateV7');
                 if (savedState) {
                     try {
                         const state = JSON.parse(savedState);

                         // Clear existing dynamic elements before loading
                         energyPoolsContainer.innerHTML = '';
                         slidersGrid.innerHTML = '';
                         dynamicModifiersContainer.innerHTML = '<h4 class="text-md font-semibold mb-2 text-gray-700">Additional Factors:</h4>';
                         modifierCount = 0; // Reset counter

                         // Restore basic inputs
                         document.getElementById('base-damage').value = state.baseDamage || '';
                         document.getElementById('base-multiplier').value = state.baseMultiplier || '1';
                         document.getElementById('form-multiplier').value = state.formMultiplier || '1';
                         document.getElementById('attack-compression-points').value = state.attackCompression || '0';
                         document.getElementById('energy-type').value = state.selectedEnergyType || 'ki';

                         // Restore energy pools (calls addEnergyPool which sets up inputs)
                         if (state.energyPools) {
                             Object.keys(state.energyPools).forEach(type => {
                                 addEnergyPool(type); // Create the structure
                                 const poolData = state.energyPools[type];
                                 // Now populate the created inputs
                                 const currentInput = document.getElementById(`${type}-current-energy`);
                                 const regenInput = document.getElementById(`${type}-regen-rate`);
                                 const ratioInput = document.getElementById(`${type}-conversion-ratio`);
                                 const maxDisplay = document.getElementById(`${type}-max-energy-display`);

                                 if(currentInput) currentInput.value = poolData.current || '1000';
                                 if(regenInput) regenInput.value = poolData.regen || '10';
                                 if(ratioInput) ratioInput.value = poolData.ratio || '0.1';
                                 if(maxDisplay && currentInput) maxDisplay.textContent = currentInput.value || '1000'; // Keep max display linked

                             });
                         }

                         // Restore sliders (calls addEnergySlider which sets up inputs)
                         if (state.energySliders) {
                               Object.keys(state.energySliders).forEach(type => {
                                   addEnergySlider(type); // Create the structure
                                   const slider = document.getElementById(`${type}-energy-slider`);
                                   const valueDisplay = document.getElementById(`${type}-slider-value`);
                                   if (slider) slider.value = state.energySliders[type] || '0';
                                   if (valueDisplay && slider) valueDisplay.textContent = slider.value; // Update display
                               });
                           }

                         // Restore dynamic modifiers
                         if (state.dynamicModifiers && Array.isArray(state.dynamicModifiers)) {
                             state.dynamicModifiers.forEach(mod => {
                                  modifierCount++;
                                  const modifierDiv = document.createElement('div');
                                  modifierDiv.className = 'dynamic-modifier-box flex items-center gap-2 mb-2'; // No animation on load
                                  modifierDiv.innerHTML = `
                                      <input type="text" placeholder="Factor Name ${modifierCount}" value="${mod.name || ''}" class="inpt flex-grow focus:ring-chakra">
                                      <input type="text" placeholder="Value (e.g., 1.2 or 1,000)" value="${mod.value || ''}" class="inpt w-1/3 dynamic-modifier-value focus:ring-chakra">
                                      <button class="remove-modifier-btn px-2 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600 active:scale-95" aria-label="Remove factor ${modifierCount}">X</button>
                                  `;
                                  dynamicModifiersContainer.appendChild(modifierDiv);

                                  modifierDiv.querySelector('.remove-modifier-btn').addEventListener('click', () => {
                                      modifierDiv.remove();
                                  });
                             });
                         }

                         // Trigger updates after loading
                         energyTypeSelect.dispatchEvent(new Event('change')); // Update stats panel style and current energy stat

                         showMessage('State loaded successfully!', 'success');
                     } catch (e) {
                         console.error("Error loading state:", e);
                         localStorage.removeItem('energyCalculatorStateV7');
                         showMessage('Error loading state. Saved data might be corrupted and has been cleared.', 'error');
                     }
                 } else {
                     showMessage('No saved state found.', 'info');
                 }
            });

            document.getElementById('clear-state-btn')?.addEventListener('click', () => {
                 if (confirm('Are you sure you want to clear the saved state? This cannot be undone.')) {
                     localStorage.removeItem('energyCalculatorStateV7');
                     showMessage('Saved state cleared.', 'success');
                     // Optional: Reset the form to default values here?
                     // location.reload(); // Easiest way to reset form
                 }
            });

            // --- Initial Setup ---
            setupInitialState(); // Add initial pools/sliders and set styles

        }); // End DOMContentLoaded
    </script>

</body>
</html>
