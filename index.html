<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Calculator - v7 (Full Result)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Energy types (matched with hex codes below)
                        ki: '#FF9800', nen: '#2196F3', chakra: '#9C27B0', magic: '#26a69a', cursed: '#dc2626',
                        reiatsu: '#475569', haki: '#1f2937', alchemy: '#f59e0b', nature: '#84cc16',
                        'ki-dark': '#e65100', 'nen-dark': '#0d47a1', 'chakra-dark': '#4a148c', 'magic-dark': '#00796b', 'cursed-dark': '#b91c1c',
                        'reiatsu-dark': '#1e293b', 'haki-dark': '#000000', 'alchemy-dark': '#b45309', 'nature-dark': '#4d7c0f',
                        // UI feedback
                        'success-light': '#e8f5e9', 'success': '#4CAF50', 'success-dark': '#2e7d32',
                        'error-light': '#ffebee', 'error': '#f44336', 'error-dark': '#c62828',
                        // Stats panel
                        'stats-border': '#60a5fa', 'stats-header': '#1e3a8a',
                        // Kaioken active state
                        'kaioken-border': '#f87171', 'kaioken-header': '#b91c1c', 'kaioken-focus': '#ef4444',
                        // Focus Rings per type (ensure these are used correctly in JS map)
                        'magic-focus': '#26a69a', 'cursed-focus': '#dc2626', 'reiatsu-focus': '#475569',
                        'haki-focus': '#1f2937', 'alchemy-focus': '#f59e0b', 'nature-focus': '#84cc16',
                        'ki-focus': '#FF9800', 'nen-focus': '#2196F3', 'chakra-focus': '#9C27B0' // Added matching focus rings
                    },
                    animation: {
                        spin: 'spin 1s linear infinite', shake: 'shake 0.5s ease-in-out', fadeIn: 'fadeIn 0.3s ease-in', pulse: 'pulse 1.5s infinite',
                        'pulse-additive': 'pulse-additive 0.5s', 'pulse-multiplicative': 'pulse-multiplicative 0.5s', 'pulse-result': 'pulse-result 0.3s ease-in-out',
                        'flash-red': 'flash-red-bg 0.5s ease-out', 'flash-green': 'flash-green-bg 0.5s ease-out', 'kaioken-glow': 'kaioken-glow 1.5s infinite ease-in-out',
                        // Dynamic glow animations linked in JS map
                        'animate-pulse-glow-ki': 'pulse-glow-ki 1.5s infinite ease-in-out',
                        'animate-pulse-glow-nen': 'pulse-glow-nen 1.5s infinite ease-in-out',
                        'animate-pulse-glow-chakra': 'pulse-glow-chakra 1.5s infinite ease-in-out',
                        'animate-pulse-glow-magic': 'pulse-glow-magic 1.5s infinite ease-in-out',
                        'animate-pulse-glow-cursed': 'pulse-glow-cursed 1.5s infinite ease-in-out',
                        'animate-pulse-glow-reiatsu': 'pulse-glow-reiatsu 1.5s infinite ease-in-out',
                        'animate-pulse-glow-haki': 'pulse-glow-haki 1.5s infinite ease-in-out',
                        'animate-pulse-glow-alchemy': 'pulse-glow-alchemy 1.5s infinite ease-in-out',
                        'animate-pulse-glow-nature': 'pulse-glow-nature 1.5s infinite ease-in-out',
                    },
                    keyframes: {
                        spin: { '0%': { transform: 'rotate(0deg)' }, '100%': { transform: 'rotate(360deg)' }, },
                        shake: { '0%, 100%': { transform: 'translateX(0)' }, '25%, 75%': { transform: 'translateX(-5px)' }, '50%': { transform: 'translateX(5px)' }, },
                        fadeIn: { from: { opacity: 0, transform: 'translateY(10px)' }, to: { opacity: 1, transform: 'translateY(0)' }, },
                        pulse: { '0%, 100%': { transform: 'scale(1)' }, '50%': { transform: 'scale(1.05)' }, },
                        'pulse-additive': { '0%, 100%': { color: '#558b2f' }, '50%': { color: '#8BC34A' }, },
                        'pulse-multiplicative': { '0%, 100%': { color: '#e65100' }, '50%': { color: '#FF9800' }, },
                        'pulse-result': { '0%, 100%': { transform: 'scale(1)' }, '50%': { transform: 'scale(1.05)' }, },
                        'flash-red-bg': { '50%': { backgroundColor: '#ffebee', borderColor: '#f44336' } },
                        'flash-green-bg': { '50%': { backgroundColor: '#e8f5e9', borderColor: '#4CAF50' } },
                        'kaioken-glow': { '0%, 100%': { boxShadow: `0 0 10px #f8717180` }, '50%': { boxShadow: `0 0 20px #f87171CC` } },
                        // Dynamic Glow Keyframes (ensure names match animation names)
                         'pulse-glow-ki': { '0%, 100%': { boxShadow: `0 0 8px #FF980066` }, '50%': { boxShadow: `0 0 16px #FF9800B3` } },
                         'pulse-glow-nen': { '0%, 100%': { boxShadow: `0 0 8px #2196F366` }, '50%': { boxShadow: `0 0 16px #2196F3B3` } },
                         'pulse-glow-chakra': { '0%, 100%': { boxShadow: `0 0 8px #9C27B066` }, '50%': { boxShadow: `0 0 16px #9C27B0B3` } },
                         'pulse-glow-magic': { '0%, 100%': { boxShadow: `0 0 8px #26a69a66` }, '50%': { boxShadow: `0 0 16px #26a69aB3` } },
                         'pulse-glow-cursed': { '0%, 100%': { boxShadow: `0 0 8px #dc262666` }, '50%': { boxShadow: `0 0 16px #dc2626B3` } },
                         'pulse-glow-reiatsu': { '0%, 100%': { boxShadow: `0 0 8px #47556966` }, '50%': { boxShadow: `0 0 16px #475569B3` } },
                         'pulse-glow-haki': { '0%, 100%': { boxShadow: `0 0 8px #1f293766` }, '50%': { boxShadow: `0 0 16px #1f2937B3` } },
                         'pulse-glow-alchemy': { '0%, 100%': { boxShadow: `0 0 8px #f59e0b66` }, '50%': { boxShadow: `0 0 16px #f59e0bB3` } },
                         'pulse-glow-nature': { '0%, 100%': { boxShadow: `0 0 8px #84cc1666` }, '50%': { boxShadow: `0 0 16px #84cc16B3` } },
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <style>
        /* Base Styles */
        body { font-family: 'Inter', sans-serif; background-color: #f9f9f9; color: #333; }
        .energy-pool { @apply p-5 mb-5 rounded-lg shadow-sm border-l-4; transition: box-shadow 0.3s ease-in-out, opacity 0.3s ease-in-out; }

        /* Dynamic Pool Styles */
        .energy-pool-ki { border-left-color: #FF9800; } .energy-pool-ki h3 { color: #e65100; }
        .energy-pool-nen { border-left-color: #2196F3; } .energy-pool-nen h3 { color: #0d47a1; }
        .energy-pool-chakra { border-left-color: #9C27B0; } .energy-pool-chakra h3 { color: #4a148c; }
        .energy-pool-magic { border-left-color: #26a69a; } .energy-pool-magic h3 { color: #00796b; }
        .energy-pool-cursed { border-left-color: #dc2626; } .energy-pool-cursed h3 { color: #b91c1c; }
        .energy-pool-reiatsu { border-left-color: #475569; } .energy-pool-reiatsu h3 { color: #1e293b; }
        .energy-pool-haki { border-left-color: #1f2937; } .energy-pool-haki h3 { color: #000000; }
        .energy-pool-alchemy { border-left-color: #f59e0b; } .energy-pool-alchemy h3 { color: #b45309; }
        .energy-pool-nature { border-left-color: #84cc16; } .energy-pool-nature h3 { color: #4d7c0f; }

        /* Base Slider Track */
        .energy-slider { @apply w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer; }
        /* Base Slider Thumb */
        .energy-slider::-webkit-slider-thumb { appearance: none; width: 20px; height: 20px; border-radius: 50%; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.2); transition: background 0.3s; border: none; }
        .energy-slider::-moz-range-thumb { width: 20px; height: 20px; border-radius: 50%; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.2); transition: background 0.3s; border: none; }

        /* Slider Thumb Colors (Using direct Hex Codes) */
        #ki-energy-slider::-webkit-slider-thumb { background: #FF9800; } #ki-energy-slider::-moz-range-thumb { background: #FF9800; }
        #nen-energy-slider::-webkit-slider-thumb { background: #2196F3; } #nen-energy-slider::-moz-range-thumb { background: #2196F3; }
        #chakra-energy-slider::-webkit-slider-thumb { background: #9C27B0; } #chakra-energy-slider::-moz-range-thumb { background: #9C27B0; }
        #magic-energy-slider::-webkit-slider-thumb { background: #26a69a; } #magic-energy-slider::-moz-range-thumb { background: #26a69a; }
        #cursed-energy-slider::-webkit-slider-thumb { background: #dc2626; } #cursed-energy-slider::-moz-range-thumb { background: #dc2626; }
        #reiatsu-energy-slider::-webkit-slider-thumb { background: #475569; } #reiatsu-energy-slider::-moz-range-thumb { background: #475569; }
        #haki-energy-slider::-webkit-slider-thumb { background: #1f2937; } #haki-energy-slider::-moz-range-thumb { background: #1f2937; }
        #alchemy-energy-slider::-webkit-slider-thumb { background: #f59e0b; } #alchemy-energy-slider::-moz-range-thumb { background: #f59e0b; }
        #nature-energy-slider::-webkit-slider-thumb { background: #84cc16; } #nature-energy-slider::-moz-range-thumb { background: #84cc16; }

        /* Slider Thumb Hover Colors (Using direct Hex Codes) */
        #ki-energy-slider:hover::-webkit-slider-thumb { background: #e65100; } #ki-energy-slider:hover::-moz-range-thumb { background: #e65100; }
        #nen-energy-slider:hover::-webkit-slider-thumb { background: #0d47a1; } #nen-energy-slider:hover::-moz-range-thumb { background: #0d47a1; }
        #chakra-energy-slider:hover::-webkit-slider-thumb { background: #4a148c; } #chakra-energy-slider:hover::-moz-range-thumb { background: #4a148c; }
        #magic-energy-slider:hover::-webkit-slider-thumb { background: #00796b; } #magic-energy-slider:hover::-moz-range-thumb { background: #00796b; }
        #cursed-energy-slider:hover::-webkit-slider-thumb { background: #b91c1c; } #cursed-energy-slider:hover::-moz-range-thumb { background: #b91c1c; }
        #reiatsu-energy-slider:hover::-webkit-slider-thumb { background: #1e293b; } #reiatsu-energy-slider:hover::-moz-range-thumb { background: #1e293b; }
        #haki-energy-slider:hover::-webkit-slider-thumb { background: #000000; } #haki-energy-slider:hover::-moz-range-thumb { background: #000000; }
        #alchemy-energy-slider:hover::-webkit-slider-thumb { background: #b45309; } #alchemy-energy-slider:hover::-moz-range-thumb { background: #b45309; }
        #nature-energy-slider:hover::-webkit-slider-thumb { background: #4d7c0f; } #nature-energy-slider:hover::-moz-range-thumb { background: #4d7c0f; }

        /* Other Styles */
        .modifier-type-option.additive { border-color: theme('colors.success'); color: theme('colors.success-dark'); }
        .modifier-type-option.additive.active { background-color: theme('colors.success-light'); box-shadow: 0 1px 5px rgba(76, 175, 80, 0.3); animation: pulse-additive 0.5s; color: theme('colors.success'); }
        .modifier-type-option.multiplicative { border-color: theme('colors.ki'); color: theme('colors.ki-dark'); }
        .modifier-type-option.multiplicative.active { background-color: theme('colors.ki / 0.1'); box-shadow: 0 1px 5px rgba(255, 152, 0, 0.3); animation: pulse-multiplicative 0.5s; color: theme('colors.ki'); }
        .animate-pulse-result { animation: pulse-result 0.3s ease-in-out; }
        .animate-flash-red { animation: flash-red-bg 0.5s ease-out; }
        .animate-flash-green { animation: flash-green-bg 0.5s ease-out; }
        .animate-kaioken-glow { animation: kaioken-glow 1.5s infinite ease-in-out; }
        /* Static Glow classes */
        .static-glow-ki { box-shadow: 0 0 10px #FF980080; } .static-glow-nen { box-shadow: 0 0 10px #2196F380; } .static-glow-chakra { box-shadow: 0 0 10px #9C27B080; } .static-glow-magic { box-shadow: 0 0 10px #26a69a80; } .static-glow-cursed { box-shadow: 0 0 10px #dc262680; } .static-glow-reiatsu { box-shadow: 0 0 10px #47556980; } .static-glow-haki { box-shadow: 0 0 10px #1f293780; } .static-glow-alchemy { box-shadow: 0 0 10px #f59e0b80; } .static-glow-nature { box-shadow: 0 0 10px #84cc1680; }

        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }
        .stats-panel { border-left-width: 4px; transition: border-color 0.3s ease-in-out, box-shadow 1.5s ease-in-out; }
        .stats-panel-header { transition: color 0.3s ease-in-out; }
        .lbl { @apply block mb-1 font-medium text-sm text-gray-600; }
        .inpt { @apply w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:border-transparent text-sm transition-colors duration-300; }
        /* .inpt-ro class is removed */
        .regen-btn { @apply px-3 py-2 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 transition-all duration-150 ease-in-out text-sm font-semibold shadow-sm active:scale-95; }
        .save-load-btn { @apply px-3 py-1 text-sm text-white rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-1 transition-all duration-150 ease-in-out active:scale-95; }

        /* Style for the new span elements replacing readonly inputs */
        .readonly-display {
            @apply inline-block font-medium text-gray-800 min-h-[42px] px-2 py-2 w-full bg-gray-50 rounded-md border border-gray-200; /* Mimic input height and padding, subtle background */
            line-height: 1.5; /* Adjust line height for vertical centering if needed */
            word-break: break-all; /* Allow long numbers without spaces to break */
        }

    </style>
</head>
<body class="p-4 md:p-6">

    <div class="mb-4 flex gap-2">
        <button id="save-state-btn" class="save-load-btn bg-blue-500 hover:bg-blue-600 focus:ring-blue-400">Save State</button>
        <button id="load-state-btn" class="save-load-btn bg-gray-500 hover:bg-gray-600 focus:ring-gray-400">Load State</button>
        <button id="clear-state-btn" class="save-load-btn bg-red-500 hover:bg-red-600 focus:ring-red-400">Clear Saved</button>
    </div>
    <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">Energy Calculator</h1>

    <div class="flex flex-col md:flex-row gap-6 max-w-7xl mx-auto">

        <div class="flex-grow md:w-3/4">

            <div id="message-area" class="mb-4 p-3 rounded-md text-sm hidden" role="alert"></div>

            <div class="energy-pool bg-white p-5 mb-5 rounded-lg shadow-sm border-l-4 border-gray-400">
                 <h3 class="text-xl font-semibold mb-4 flex items-center"> Damage Modifiers <span class="flex-grow h-px bg-gray-200 ml-3"></span> </h3>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                     <div><label for="base-damage" class="lbl">Base Damage:</label><input type="text" id="base-damage" placeholder="e.g., 100" aria-required="true" class="inpt focus:ring-success"></div>
                     <div><label for="attack-compression-points" class="lbl">Attack Compression Points:</label><input type="text" id="attack-compression-points" placeholder="e.g., 10" value="0" class="inpt focus:ring-red-500"></div>
                     <div><label for="base-multiplier" class="lbl">Base Multiplier:</label><input type="text" id="base-multiplier" placeholder="e.g., 1.5" value="1" class="inpt focus:ring-success"></div>
                     <div><label for="form-multiplier" class="lbl">Form Multiplier:</label><input type="text" id="form-multiplier" placeholder="e.g., 2" value="1" class="inpt focus:ring-success"></div>
                 </div>
                 <div id="dynamic-modifiers-container" class="mb-4"><h4 class="text-md font-semibold mb-2 text-gray-700">Additional Factors:</h4></div>
                 <button id="add-dynamic-box" aria-label="Add modifier factor" class="px-4 py-2 bg-chakra text-white rounded-md hover:bg-chakra-dark focus:outline-none focus:ring-2 focus:ring-chakra focus:ring-offset-2 transition-all duration-150 ease-in-out text-sm font-semibold shadow-sm active:scale-95"> Add Factor </button>
            </div>

            <div class="form-group mb-5">
                 <label for="energy-type" class="lbl">Energy Type:</label>
                 <select id="energy-type" aria-label="Select energy type" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-success focus:border-transparent text-sm bg-white">
                     <option value="ki">Ki Energy</option> <option value="nen">Nen Energy</option> <option value="chakra">Chakra Energy</option> <option value="magic">Magic Energy</option> <option value="cursed">Cursed Energy</option> <option value="reiatsu">Reiatsu</option> <option value="haki">Haki</option> <option value="alchemy">Alchemy</option> <option value="nature">Nature Energy</option>
                 </select>
            </div>

            <div id="energy-pools-container" class="mb-5">
                </div>

            <div id="all-sliders-container" class="bg-white p-5 mb-5 rounded-lg shadow-sm">
                <h3 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">Energy Usage Sliders</h3>
                <div id="sliders-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-4">
                    </div>
            </div>

            <button id="calculate-btn" aria-label="Calculate final damage value" class="w-full px-4 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-150 ease-in-out text-lg font-semibold shadow-md mb-5 active:scale-95"> Calculate Damage </button>
            <div id="loading" class="loading text-center p-5 hidden">
                <div class="loading-spinner inline-block w-8 h-8 border-4 border-t-success border-gray-200 rounded-full animate-spin" aria-hidden="true"></div>
                <div class="loading-text mt-2 text-gray-600">Calculating...</div><span class="sr-only">Loading, please wait</span>
             </div>
            <div id="result" class="result bg-success-light p-5 rounded-lg border-l-4 border-success shadow-sm hidden animate-fadeIn" aria-live="polite">
                <div class="result-title text-lg font-semibold mb-2 text-success-dark">Calculated Damage:</div>
                <div id="result-value" class="result-value text-3xl font-bold mb-3 break-words">0</div>
                <div id="result-details" class="result-details text-sm text-gray-700 mt-3 border-t border-success/30 pt-3">
                    <p><strong>Total Energy Used:</strong> <span id="result-total-energy-used">0</span></p>
                    <p><strong>Total Extra Damage from Energy:</strong> <span id="result-total-extra-damage">0.00</span></p>
                    <hr class="my-2 border-success/20">
                    <p><strong>Scientific Notation:</strong> <span id="result-scientific">0</span></p>
                    <p><strong>In Words:</strong> <span id="result-words">Zero</span></p>
                </div>
             </div>

        </div> <div id="stats-panel" class="stats-panel md:w-1/4 lg:w-1/5 p-5 bg-white rounded-lg shadow-sm self-start sticky top-6 border-stats-border">
             <h3 id="stats-panel-header" class="stats-panel-header text-xl font-semibold mb-4 flex items-center text-stats-header"> Stats <span class="flex-grow h-px bg-gray-200 ml-3"></span> </h3>
             <div class="space-y-3">
                 <p class="text-sm text-gray-600">Selected Current Energy: <span id="stat-current-energy" class="font-medium text-gray-800 break-words">0</span></p>
                 <hr class="border-gray-200">
                 <p class="text-sm text-gray-600">Total Damage Dealt: <span id="stat-total-damage" class="font-medium text-gray-800 break-words">0</span></p>
                 <p class="text-sm text-gray-600">Calculations Performed: <span id="stat-calculation-count" class="font-medium text-gray-800 break-words">0</span></p>
                 <p class="text-sm text-gray-600">Active Energy Type: <span id="stat-active-energy-type" class="font-medium text-gray-800 capitalize">N/A</span></p>
             </div>
        </div> </div> <script>
        // Minimal JS to demonstrate interaction placeholders
        document.addEventListener('DOMContentLoaded', () => {
            const energyTypeSelect = document.getElementById('energy-type');
            const statsPanel = document.getElementById('stats-panel');
            const statsPanelHeader = document.getElementById('stats-panel-header');
            const statActiveEnergyType = document.getElementById('stat-active-energy-type');
            const statCurrentEnergy = document.getElementById('stat-current-energy'); // Assuming you have this element
            const energyPoolsContainer = document.getElementById('energy-pools-container');
            const slidersGrid = document.getElementById('sliders-grid');
            const baseDamageInput = document.getElementById('base-damage');
            const resultDiv = document.getElementById('result');
            const resultValue = document.getElementById('result-value');
            const calculateBtn = document.getElementById('calculate-btn');
            const loadingDiv = document.getElementById('loading');

            const energyTypes = {
                ki: { name: 'Ki Energy', color: 'ki', focus: 'ki-focus', border: 'stats-border-ki', header: 'stats-header-ki', glow: 'animate-pulse-glow-ki', staticGlow: 'static-glow-ki' },
                nen: { name: 'Nen Energy', color: 'nen', focus: 'nen-focus', border: 'stats-border-nen', header: 'stats-header-nen', glow: 'animate-pulse-glow-nen', staticGlow: 'static-glow-nen' },
                chakra: { name: 'Chakra Energy', color: 'chakra', focus: 'chakra-focus', border: 'stats-border-chakra', header: 'stats-header-chakra', glow: 'animate-pulse-glow-chakra', staticGlow: 'static-glow-chakra' },
                magic: { name: 'Magic Energy', color: 'magic', focus: 'magic-focus', border: 'stats-border-magic', header: 'stats-header-magic', glow: 'animate-pulse-glow-magic', staticGlow: 'static-glow-magic' },
                cursed: { name: 'Cursed Energy', color: 'cursed', focus: 'cursed-focus', border: 'stats-border-cursed', header: 'stats-header-cursed', glow: 'animate-pulse-glow-cursed', staticGlow: 'static-glow-cursed' },
                reiatsu: { name: 'Reiatsu', color: 'reiatsu', focus: 'reiatsu-focus', border: 'stats-border-reiatsu', header: 'stats-header-reiatsu', glow: 'animate-pulse-glow-reiatsu', staticGlow: 'static-glow-reiatsu' },
                haki: { name: 'Haki', color: 'haki', focus: 'haki-focus', border: 'stats-border-haki', header: 'stats-header-haki', glow: 'animate-pulse-glow-haki', staticGlow: 'static-glow-haki' },
                alchemy: { name: 'Alchemy', color: 'alchemy', focus: 'alchemy-focus', border: 'stats-border-alchemy', header: 'stats-header-alchemy', glow: 'animate-pulse-glow-alchemy', staticGlow: 'static-glow-alchemy' },
                nature: { name: 'Nature Energy', color: 'nature', focus: 'nature-focus', border: 'stats-border-nature', header: 'stats-header-nature', glow: 'animate-pulse-glow-nature', staticGlow: 'static-glow-nature' }
            };

            function updateStatsPanelStyle(type) {
                 const config = energyTypes[type];
                 if (!config) return;

                 // Remove previous styles - Use a more robust method in production
                 statsPanel.classList.remove(...Object.values(energyTypes).map(e => `border-${e.color}`));
                 statsPanel.classList.remove(...Object.values(energyTypes).map(e => `animate-${e.glow}`));
                 statsPanel.classList.remove(...Object.values(energyTypes).map(e => e.staticGlow)); // Remove static glows
                 statsPanelHeader.classList.remove(...Object.values(energyTypes).map(e => `text-${e.color}-dark`)); // Assuming dark text variant exists

                 // Add new styles
                 statsPanel.classList.add(`border-${config.color}`); // Use the border color defined in Tailwind config
                 statsPanel.classList.add(config.staticGlow); // Add static glow class
                 statsPanelHeader.classList.add(`text-${config.color}-dark`); // Use dark color variant for header
                 statActiveEnergyType.textContent = config.name;
                 statActiveEnergyType.className = `font-medium text-${config.color}-dark capitalize`; // Style the text itself
             }

            function setupInitialState() {
                 // Initial setup: Add pools and sliders for all energy types (or based on saved state)
                 // For demonstration, let's add Ki, Nen, Chakra initially
                 ['ki', 'nen', 'chakra'].forEach(type => {
                     addEnergyPool(type);
                     addEnergySlider(type);
                 });
                 // Set initial style based on dropdown
                 updateStatsPanelStyle(energyTypeSelect.value);
            }

            function addEnergyPool(type) {
                 const config = energyTypes[type];
                 if (!config) return;

                 const poolDiv = document.createElement('div');
                 poolDiv.id = `${type}-energy-pool`;
                 poolDiv.className = `energy-pool energy-pool-${type} bg-white`; // Added bg-white here
                 poolDiv.innerHTML = `
                     <h3 class="text-xl font-semibold mb-4 flex items-center">${config.name} Pool<span class="flex-grow h-px bg-gray-200 ml-3"></span></h3>
                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                         <div><label for="${type}-current-energy" class="lbl">Current Energy:</label><input type="text" id="${type}-current-energy" value="1000" class="inpt focus:ring-${config.focus}"></div>
                         <div><label for="${type}-max-energy" class="lbl">Max Energy:</label><span id="${type}-max-energy-display" class="readonly-display">1000</span></div>
                         <div><label for="${type}-regen-rate" class="lbl">Regen Rate (/sec):</label><input type="text" id="${type}-regen-rate" value="10" class="inpt focus:ring-${config.focus}"></div>
                         <div><label for="${type}-conversion-ratio" class="lbl">Damage Conversion Ratio:</label><input type="text" id="${type}-conversion-ratio" value="0.1" class="inpt focus:ring-${config.focus}"></div>
                     </div>
                     <button id="regen-${type}-btn" class="regen-btn bg-${config.color} hover:bg-${config.color}-dark focus:ring-${config.focus} mt-4">Regenerate</button>
                 `;
                 energyPoolsContainer.appendChild(poolDiv);

                 // Add event listener for input to update display if needed (e.g., max energy)
                 const currentEnergyInput = poolDiv.querySelector(`#${type}-current-energy`);
                 if (currentEnergyInput && statCurrentEnergy && type === energyTypeSelect.value) {
                    currentEnergyInput.addEventListener('input', () => {
                        if (type === energyTypeSelect.value) {
                            statCurrentEnergy.textContent = currentEnergyInput.value || '0';
                        }
                    });
                    // Initialize stat panel display
                     statCurrentEnergy.textContent = currentEnergyInput.value || '0';
                 }

                 // Example: Simulate regeneration on button click
                 const regenBtn = poolDiv.querySelector(`#regen-${type}-btn`);
                 if(regenBtn) {
                     regenBtn.addEventListener('click', () => {
                         console.log(`Regenerating ${config.name}...`);
                         // Add actual regeneration logic here
                     });
                 }
            }

            function addEnergySlider(type) {
                const config = energyTypes[type];
                if (!config) return;

                const sliderContainer = document.createElement('div');
                sliderContainer.id = `${type}-slider-container`;
                sliderContainer.className = 'mb-2'; // Add some bottom margin
                sliderContainer.innerHTML = `
                    <label for="${type}-energy-slider" class="lbl text-sm mb-1">${config.name} Usage (<span id="${type}-slider-value">0</span>%):</label>
                    <input type="range" id="${type}-energy-slider" name="${type}-energy-slider" min="0" max="100" value="0" class="energy-slider">
                `;
                slidersGrid.appendChild(sliderContainer);

                // Add event listener to update the percentage display
                const slider = sliderContainer.querySelector(`#${type}-energy-slider`);
                const valueDisplay = sliderContainer.querySelector(`#${type}-slider-value`);
                if(slider && valueDisplay) {
                    slider.addEventListener('input', (e) => {
                        valueDisplay.textContent = e.target.value;
                    });
                }
            }


            // Event listener for the main energy type dropdown
            energyTypeSelect.addEventListener('change', (e) => {
                const selectedType = e.target.value;
                updateStatsPanelStyle(selectedType);

                // Update current energy stat display
                const currentEnergyInput = document.getElementById(`${selectedType}-current-energy`);
                 if (currentEnergyInput && statCurrentEnergy) {
                     statCurrentEnergy.textContent = currentEnergyInput.value || '0';
                 } else {
                     statCurrentEnergy.textContent = 'N/A'; // Handle case where pool doesn't exist yet
                 }

                // Optional: Logic to dynamically add/remove or highlight the selected energy pool/slider
                console.log(`Selected energy type: ${selectedType}`);

                // Example: Ensure the selected energy pool and slider exist
                 if (!document.getElementById(`${selectedType}-energy-pool`)) {
                     addEnergyPool(selectedType);
                 }
                 if (!document.getElementById(`${selectedType}-slider-container`)) {
                     addEnergySlider(selectedType);
                 }
            });

             // Event listener for Calculate button
             calculateBtn.addEventListener('click', () => {
                 // Basic validation
                 if (!baseDamageInput.value || isNaN(parseFloat(baseDamageInput.value))) {
                     alert('Please enter a valid Base Damage.');
                     baseDamageInput.focus();
                     return;
                 }

                 loadingDiv.classList.remove('hidden');
                 resultDiv.classList.add('hidden');

                 // Simulate calculation delay
                 setTimeout(() => {
                     try {
                         // --- Placeholder Calculation Logic ---
                         let baseDamage = parseFloat(baseDamageInput.value) || 0;
                         let baseMultiplier = parseFloat(document.getElementById('base-multiplier').value) || 1;
                         let formMultiplier = parseFloat(document.getElementById('form-multiplier').value) || 1;
                         let totalEnergyUsed = 0;
                         let totalExtraDamage = 0;

                         // Include dynamic modifiers (simplified example)
                         document.querySelectorAll('.dynamic-modifier-value').forEach(input => {
                            let value = parseFloat(input.value) || 0; // Default to 0 if not a number
                            // Assume multiplicative for simplicity here, needs type handling
                            if(value !== 0) baseMultiplier *= value;
                         });


                         // Sum energy usage and calculate extra damage (very basic example)
                         Object.keys(energyTypes).forEach(type => {
                             const slider = document.getElementById(`${type}-energy-slider`);
                             const currentEnergyInput = document.getElementById(`${type}-current-energy`);
                             const conversionRatioInput = document.getElementById(`${type}-conversion-ratio`);

                             if (slider && currentEnergyInput && conversionRatioInput) {
                                 const percentage = parseFloat(slider.value) || 0;
                                 const currentEnergy = parseFloat(currentEnergyInput.value) || 0;
                                 const conversionRatio = parseFloat(conversionRatioInput.value) || 0;

                                 const energyToUse = (currentEnergy * percentage) / 100;
                                 totalEnergyUsed += energyToUse;
                                 totalExtraDamage += energyToUse * conversionRatio;

                                 // TODO: Deduct energy used from current pool
                             }
                         });

                         let finalDamage = (baseDamage + totalExtraDamage) * baseMultiplier * formMultiplier;
                         // --- End Placeholder Calculation ---

                         resultValue.textContent = finalDamage.toLocaleString(); // Format with commas
                         document.getElementById('result-total-energy-used').textContent = totalEnergyUsed.toLocaleString();
                         document.getElementById('result-total-extra-damage').textContent = totalExtraDamage.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                         document.getElementById('result-scientific').textContent = finalDamage.toExponential(2);
                         document.getElementById('result-words').textContent = "Number to words conversion not implemented"; // Placeholder

                         loadingDiv.classList.add('hidden');
                         resultDiv.classList.remove('hidden');
                         resultDiv.classList.add('animate-pulse-result');
                         setTimeout(() => resultDiv.classList.remove('animate-pulse-result'), 300);

                         // Update stats panel (example)
                         const totalDamageStat = document.getElementById('stat-total-damage');
                         const calcCountStat = document.getElementById('stat-calculation-count');
                         totalDamageStat.textContent = (parseFloat(totalDamageStat.textContent.replace(/,/g, '')) || 0) + finalDamage; // Accumulate total damage
                         calcCountStat.textContent = (parseInt(calcCountStat.textContent) || 0) + 1; // Increment calc count

                     } catch (error) {
                         console.error("Calculation error:", error);
                         loadingDiv.classList.add('hidden');
                         // Display error message to user
                         const messageArea = document.getElementById('message-area');
                         messageArea.textContent = `Calculation failed: ${error.message}`;
                         messageArea.className = 'mb-4 p-3 rounded-md text-sm bg-error-light text-error-dark border border-error'; // Error styling
                         messageArea.classList.remove('hidden');
                     }

                 }, 750); // Simulate network/compute time
             });


             // Add Dynamic Modifier Box Functionality
             const addDynamicBoxBtn = document.getElementById('add-dynamic-box');
             const dynamicModifiersContainer = document.getElementById('dynamic-modifiers-container');
             let modifierCount = 0;

             addDynamicBoxBtn.addEventListener('click', () => {
                 modifierCount++;
                 const modifierDiv = document.createElement('div');
                 modifierDiv.className = 'dynamic-modifier-box flex items-center gap-2 mb-2 animate-fadeIn';
                 modifierDiv.innerHTML = `
                     <input type="text" placeholder="Factor Name ${modifierCount}" class="inpt flex-grow focus:ring-chakra">
                     <input type="text" placeholder="Value (e.g., 1.2)" class="inpt w-1/3 dynamic-modifier-value focus:ring-chakra">
                     <button class="remove-modifier-btn px-2 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600 active:scale-95" aria-label="Remove factor ${modifierCount}">X</button>
                 `;
                 dynamicModifiersContainer.appendChild(modifierDiv);

                 modifierDiv.querySelector('.remove-modifier-btn').addEventListener('click', () => {
                     modifierDiv.remove();
                     // Optional: Renumber remaining factors if needed
                 });
             });


             // Initial Setup Call
             setupInitialState();
        });

        // Add Save/Load/Clear functionality (using localStorage example)
        document.getElementById('save-state-btn')?.addEventListener('click', () => {
             try {
                 const state = {
                     baseDamage: document.getElementById('base-damage')?.value,
                     baseMultiplier: document.getElementById('base-multiplier')?.value,
                     formMultiplier: document.getElementById('form-multiplier')?.value,
                     attackCompression: document.getElementById('attack-compression-points')?.value,
                     selectedEnergyType: document.getElementById('energy-type')?.value,
                     energyPools: {},
                     energySliders: {},
                     dynamicModifiers: []
                 };

                 // Save energy pool data
                 document.querySelectorAll('[id$="-energy-pool"]').forEach(pool => {
                     const type = pool.id.replace('-energy-pool', '');
                     state.energyPools[type] = {
                         current: document.getElementById(`${type}-current-energy`)?.value,
                         // Max energy is derived or fixed? Assuming fixed for now based on readonly span.
                         regen: document.getElementById(`${type}-regen-rate`)?.value,
                         ratio: document.getElementById(`${type}-conversion-ratio`)?.value
                     };
                 });

                 // Save slider data
                 document.querySelectorAll('.energy-slider').forEach(slider => {
                      const type = slider.id.replace('-energy-slider', '');
                      state.energySliders[type] = slider.value;
                  });

                 // Save dynamic modifiers
                 document.querySelectorAll('.dynamic-modifier-box').forEach(box => {
                     const nameInput = box.querySelector('input[type="text"]:first-of-type');
                     const valueInput = box.querySelector('.dynamic-modifier-value');
                     if (nameInput && valueInput) {
                         state.dynamicModifiers.push({ name: nameInput.value, value: valueInput.value });
                     }
                 });


                 localStorage.setItem('energyCalculatorStateV7', JSON.stringify(state));
                 showMessage('State saved successfully!', 'success');
             } catch (e) {
                 console.error("Error saving state:", e);
                 showMessage('Error saving state.', 'error');
             }
         });

         document.getElementById('load-state-btn')?.addEventListener('click', () => {
             const savedState = localStorage.getItem('energyCalculatorStateV7');
             if (savedState) {
                 try {
                     const state = JSON.parse(savedState);

                     // --- Clear existing dynamic elements ---
                     document.getElementById('energy-pools-container').innerHTML = '';
                     document.getElementById('sliders-grid').innerHTML = '';
                     document.getElementById('dynamic-modifiers-container').innerHTML = '<h4 class="text-md font-semibold mb-2 text-gray-700">Additional Factors:</h4>'; // Reset dynamic modifiers header


                     // --- Restore basic inputs ---
                     document.getElementById('base-damage').value = state.baseDamage || '';
                     document.getElementById('base-multiplier').value = state.baseMultiplier || '1';
                     document.getElementById('form-multiplier').value = state.formMultiplier || '1';
                     document.getElementById('attack-compression-points').value = state.attackCompression || '0';
                     document.getElementById('energy-type').value = state.selectedEnergyType || 'ki';


                      // --- Restore energy pools and sliders ---
                     // Need to call addEnergyPool and addEnergySlider first based on saved data
                     if (state.energyPools) {
                         Object.keys(state.energyPools).forEach(type => {
                             if (!document.getElementById(`${type}-energy-pool`)) {
                                 addEnergyPool(type); // Assumes addEnergyPool exists and works
                             }
                             const poolData = state.energyPools[type];
                             document.getElementById(`${type}-current-energy`).value = poolData.current || '1000';
                             document.getElementById(`${type}-regen-rate`).value = poolData.regen || '10';
                             document.getElementById(`${type}-conversion-ratio`).value = poolData.ratio || '0.1';
                             // Update max energy display if needed
                         });
                     }

                     if (state.energySliders) {
                           Object.keys(state.energySliders).forEach(type => {
                               if (!document.getElementById(`${type}-slider-container`)) {
                                   addEnergySlider(type); // Assumes addEnergySlider exists and works
                               }
                               const slider = document.getElementById(`${type}-energy-slider`);
                               const valueDisplay = document.getElementById(`${type}-slider-value`);
                               if (slider) slider.value = state.energySliders[type] || '0';
                               if (valueDisplay) valueDisplay.textContent = slider.value; // Update display
                           });
                       }

                      // --- Restore dynamic modifiers ---
                     const dynamicModifiersContainer = document.getElementById('dynamic-modifiers-container');
                     let modifierCount = 0; // Reset counter for IDs/labels if needed
                     if (state.dynamicModifiers && Array.isArray(state.dynamicModifiers)) {
                         state.dynamicModifiers.forEach(mod => {
                              modifierCount++;
                              const modifierDiv = document.createElement('div');
                              modifierDiv.className = 'dynamic-modifier-box flex items-center gap-2 mb-2 animate-fadeIn'; // No animation on load?
                              modifierDiv.innerHTML = `
                                  <input type="text" placeholder="Factor Name ${modifierCount}" value="${mod.name || ''}" class="inpt flex-grow focus:ring-chakra">
                                  <input type="text" placeholder="Value (e.g., 1.2)" value="${mod.value || ''}" class="inpt w-1/3 dynamic-modifier-value focus:ring-chakra">
                                  <button class="remove-modifier-btn px-2 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600 active:scale-95" aria-label="Remove factor ${modifierCount}">X</button>
                              `;
                              dynamicModifiersContainer.appendChild(modifierDiv);

                              modifierDiv.querySelector('.remove-modifier-btn').addEventListener('click', () => {
                                  modifierDiv.remove();
                              });
                         });
                     }


                     // --- Trigger updates ---
                     // Manually trigger change event on select to update styles etc.
                     document.getElementById('energy-type').dispatchEvent(new Event('change'));
                     // Update stat panel's current energy display
                     const currentEnergyInput = document.getElementById(`${state.selectedEnergyType}-current-energy`);
                     const statCurrentEnergy = document.getElementById('stat-current-energy');
                     if(currentEnergyInput && statCurrentEnergy) {
                        statCurrentEnergy.textContent = currentEnergyInput.value || '0';
                     }


                     showMessage('State loaded successfully!', 'success');
                 } catch (e) {
                     console.error("Error loading state:", e);
                     localStorage.removeItem('energyCalculatorStateV7'); // Clear corrupted state
                     showMessage('Error loading state. Saved data might be corrupted and has been cleared.', 'error');
                 }
             } else {
                 showMessage('No saved state found.', 'info'); // Use info style or similar
             }
         });

         document.getElementById('clear-state-btn')?.addEventListener('click', () => {
             if (confirm('Are you sure you want to clear the saved state? This cannot be undone.')) {
                 localStorage.removeItem('energyCalculatorStateV7');
                 showMessage('Saved state cleared.', 'success');
             }
         });

         // Helper to show messages
         function showMessage(message, type = 'info') {
             const area = document.getElementById('message-area');
             area.textContent = message;
             let bgColor = 'bg-blue-100';
             let textColor = 'text-blue-800';
             let borderColor = 'border-blue-300';

             if (type === 'success') {
                 bgColor = 'bg-success-light'; textColor = 'text-success-dark'; borderColor = 'border-success';
             } else if (type === 'error') {
                 bgColor = 'bg-error-light'; textColor = 'text-error-dark'; borderColor = 'border-error';
             }

             area.className = `mb-4 p-3 rounded-md text-sm ${bgColor} ${textColor} border ${borderColor}`;
             area.classList.remove('hidden');

             // Optional: Hide message after a few seconds
             setTimeout(() => {
                 area.classList.add('hidden');
             }, 4000);
         }

    </script>

</body>
</html>
