<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Calculator with Stats</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind Custom Configuration
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Energy types
                        ki: '#FF9800', nen: '#2196F3', chakra: '#9C27B0', magic: '#26a69a', cursed: '#dc2626',
                        'ki-dark': '#e65100', 'nen-dark': '#0d47a1', 'chakra-dark': '#4a148c', 'magic-dark': '#00796b', 'cursed-dark': '#b91c1c',
                        // UI feedback
                        'success-light': '#e8f5e9', 'success': '#4CAF50', 'success-dark': '#2e7d32',
                        'error-light': '#ffebee', 'error': '#f44336', 'error-dark': '#c62828',
                        // Stats panel
                        'stats-border': '#60a5fa', 'stats-header': '#1e3a8a',
                        // Kaioken active state
                        'kaioken-border': '#f87171', 'kaioken-header': '#b91c1c', 'kaioken-focus': '#ef4444',
                        // Focus Rings per type
                        'magic-focus': '#26a69a', 'cursed-focus': '#dc2626',
                    },
                    animation: { /* ... animations ... */ spin: 'spin 1s linear infinite', shake: 'shake 0.5s ease-in-out', fadeIn: 'fadeIn 0.3s ease-in', pulse: 'pulse 1.5s infinite', 'pulse-additive': 'pulse-additive 0.5s', 'pulse-multiplicative': 'pulse-multiplicative 0.5s', },
                    keyframes: { /* ... keyframes ... */ spin: { '0%': { transform: 'rotate(0deg)' }, '100%': { transform: 'rotate(360deg)' }, }, shake: { '0%, 100%': { transform: 'translateX(0)' }, '25%, 75%': { transform: 'translateX(-5px)' }, '50%': { transform: 'translateX(5px)' }, }, fadeIn: { from: { opacity: 0, transform: 'translateY(10px)' }, to: { opacity: 1, transform: 'translateY(0)' }, }, pulse: { '0%, 100%': { transform: 'scale(1)' }, '50%': { transform: 'scale(1.05)' }, }, 'pulse-additive': { '0%, 100%': { color: '#558b2f' }, '50%': { color: '#8BC34A' }, }, 'pulse-multiplicative': { '0%, 100%': { color: '#e65100' }, '50%': { color: '#FF9800' }, }, }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f9f9f9; color: #333; }
        /* Energy Pool Specific Styles */
        .energy-pool-ki { border-left-color: theme('colors.ki'); } .energy-pool-ki h3 { color: theme('colors.ki-dark'); }
        .energy-pool-nen { border-left-color: theme('colors.nen'); } .energy-pool-nen h3 { color: theme('colors.nen-dark'); }
        .energy-pool-chakra { border-left-color: theme('colors.chakra'); } .energy-pool-chakra h3 { color: theme('colors.chakra-dark'); }
        .energy-pool-magic { border-left-color: theme('colors.magic'); } .energy-pool-magic h3 { color: theme('colors.magic-dark'); }
        .energy-pool-cursed { border-left-color: theme('colors.cursed'); } .energy-pool-cursed h3 { color: theme('colors.cursed-dark'); }
        /* Slider Styles */
        .energy-slider::-webkit-slider-thumb { appearance: none; width: 22px; height: 22px; border-radius: 50%; background: theme('colors.success'); cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: background 0.3s; }
        .energy-slider::-moz-range-thumb { width: 22px; height: 22px; border-radius: 50%; background: theme('colors.success'); cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: background 0.3s; border: none; }
        .energy-slider::-webkit-slider-thumb:hover { background: theme('colors.success-dark'); } .energy-slider::-moz-range-thumb:hover { background: theme('colors.success-dark'); }
        /* Modifier Styles */
        .modifier-type-option.additive { border-color: theme('colors.success'); color: theme('colors.success-dark'); }
        .modifier-type-option.additive.active { background-color: theme('colors.success-light'); box-shadow: 0 1px 5px rgba(76, 175, 80, 0.3); animation: pulse-additive 0.5s; color: theme('colors.success'); }
        .modifier-type-option.multiplicative { border-color: theme('colors.ki'); color: theme('colors.ki-dark'); }
        .modifier-type-option.multiplicative.active { background-color: theme('colors.ki / 0.1'); box-shadow: 0 1px 5px rgba(255, 152, 0, 0.3); animation: pulse-multiplicative 0.5s; color: theme('colors.ki'); }
        /* Animation Helpers */
        .animate-pulse-additive { animation: pulse-additive 0.5s; } .animate-pulse-multiplicative { animation: pulse-multiplicative 0.5s; }
        /* Accessibility */
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }
        /* Stats Panel Base Style */
        .stats-panel { border-left-width: 4px; transition: border-color 0.3s ease-in-out; }
        .stats-panel-header { transition: color 0.3s ease-in-out; }
        /* Utility classes */
        .lbl { @apply block mb-1 font-medium text-sm text-gray-600; }
        .inpt { @apply w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:border-transparent text-sm; }
        .inpt-ro { @apply w-full p-2 border border-gray-300 rounded-md bg-gray-100 text-sm cursor-not-allowed; }
        .regen-btn { @apply px-3 py-2 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 transition duration-150 ease-in-out text-sm font-semibold shadow-sm; }
        /* Focus Ring Specifics */
        .inpt-kaioken { @apply focus:ring-kaioken-focus; }
        .inpt-magic { @apply focus:ring-magic-focus; }
        .inpt-cursed { @apply focus:ring-cursed-focus; }
    </style>
</head>
<body class="p-4 md:p-6">

    <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">Energy Calculator</h1>

    <div class="flex flex-col md:flex-row gap-6 max-w-7xl mx-auto">

        <div class="flex-grow md:w-3/4">

            <div id="message-area" class="mb-4 p-3 rounded-md text-sm hidden" role="alert"></div>

            <div class="energy-pool bg-white p-5 mb-5 rounded-lg shadow-sm border-l-4 border-gray-400">
                <h3 class="text-xl font-semibold mb-4 flex items-center"> Damage Modifiers <span class="flex-grow h-px bg-gray-200 ml-3"></span> </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div><label for="base-damage" class="lbl">Base Damage:</label><input type="text" id="base-damage" placeholder="e.g., 100" aria-required="true" class="inpt focus:ring-success"></div>
                    <div><label for="base-multiplier" class="lbl">Base Multiplier:</label><input type="text" id="base-multiplier" placeholder="e.g., 1.5" value="1" class="inpt focus:ring-success"></div>
                    <div><label for="form-multiplier" class="lbl">Form Multiplier:</label><input type="text" id="form-multiplier" placeholder="e.g., 2" value="1" class="inpt focus:ring-success"></div>
                </div>
                <div id="dynamic-modifiers-container" class="mb-4"><h4 class="text-md font-semibold mb-2 text-gray-700">Additional Factors:</h4></div>
                <button id="add-dynamic-box" aria-label="Add modifier factor" class="px-4 py-2 bg-chakra text-white rounded-md hover:bg-chakra-dark focus:outline-none focus:ring-2 focus:ring-chakra focus:ring-offset-2 transition duration-150 ease-in-out text-sm font-semibold shadow-sm"> Add Factor </button>
            </div>

            <div class="form-group mb-5">
                <label for="energy-type" class="lbl">Energy Type:</label>
                <select id="energy-type" aria-label="Select energy type" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-success focus:border-transparent text-sm bg-white">
                    <option value="ki">Ki Energy</option>
                    <option value="nen">Nen Energy</option>
                    <option value="chakra">Chakra Energy</option>
                    <option value="magic">Magic Energy</option>
                    <option value="cursed">Cursed Energy</option> </select>
            </div>

            <div id="ki-pool" class="energy-pool energy-pool-ki p-5 mb-5 rounded-lg shadow-sm border-l-4 bg-gradient-to-br from-white to-orange-100">
                <h3 class="text-xl font-semibold mb-4 flex items-center">Ki Energy Pool <span class="flex-grow h-px bg-gray-200 ml-3"></span></h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label for="ki-max-energy" class="lbl">Max Energy:</label><input type="text" id="ki-max-energy" placeholder="Enter maximum" value="1000" class="inpt focus:ring-ki"></div>
                    <div><label for="ki-max-multiplier" class="lbl">Max Energy Multiplier:</label><input type="text" id="ki-max-multiplier" placeholder="e.g., 1" value="1" class="inpt focus:ring-ki"></div>
                    <div><label for="ki-total-energy" class="lbl">Total Energy (Calculated):</label><input type="text" id="ki-total-energy" readonly class="inpt-ro"></div>
                    <div><label for="ki-current-energy" class="lbl">Current Energy:</label><input type="text" id="ki-current-energy" readonly class="inpt-ro"></div>
                    <div><label for="ki-damage-per-power" class="lbl">Damage per Energy Point:</label><input type="text" id="ki-damage-per-power" placeholder="e.g., 0.5" value="1" class="inpt focus:ring-ki"></div>
                    <div><label for="ki-regen-percent" class="lbl">Regeneration Rate (% of Max):</label><div class="flex items-center gap-2"><input type="text" id="ki-regen-percent" placeholder="e.g., 10" class="flex-grow p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-ki focus:border-transparent text-sm"><button data-type="ki" class="regen-btn bg-ki hover:bg-ki-dark focus:ring-ki">Regen</button></div></div>
                </div>
            </div>
            <div id="nen-pool" class="energy-pool energy-pool-nen p-5 mb-5 rounded-lg shadow-sm border-l-4 bg-gradient-to-br from-white to-blue-100" style="display: none;">
                 <h3 class="text-xl font-semibold mb-4 flex items-center">Nen Energy Pool <span class="flex-grow h-px bg-gray-200 ml-3"></span></h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <div><label for="nen-max-energy" class="lbl">Max Energy:</label><input type="text" id="nen-max-energy" placeholder="Enter maximum" value="1000" class="inpt focus:ring-nen"></div>
                     <div><label for="nen-max-multiplier" class="lbl">Max Energy Multiplier:</label><input type="text" id="nen-max-multiplier" placeholder="e.g., 1" value="1" class="inpt focus:ring-nen"></div>
                     <div><label for="nen-total-energy" class="lbl">Total Energy (Calculated):</label><input type="text" id="nen-total-energy" readonly class="inpt-ro"></div>
                     <div><label for="nen-current-energy" class="lbl">Current Energy:</label><input type="text" id="nen-current-energy" readonly class="inpt-ro"></div>
                     <div><label for="nen-damage-per-power" class="lbl">Damage per Energy Point:</label><input type="text" id="nen-damage-per-power" placeholder="e.g., 0.5" value="1" class="inpt focus:ring-nen"></div>
                     <div><label for="nen-regen-percent" class="lbl">Regeneration Rate (% of Max):</label><div class="flex items-center gap-2"><input type="text" id="nen-regen-percent" placeholder="e.g., 10" class="flex-grow p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-nen focus:border-transparent text-sm"><button data-type="nen" class="regen-btn bg-nen hover:bg-nen-dark focus:ring-nen">Regen</button></div></div>
                </div>
            </div>
            <div id="chakra-pool" class="energy-pool energy-pool-chakra p-5 mb-5 rounded-lg shadow-sm border-l-4 bg-gradient-to-br from-white to-purple-100" style="display: none;">
                 <h3 class="text-xl font-semibold mb-4 flex items-center">Chakra Energy Pool <span class="flex-grow h-px bg-gray-200 ml-3"></span></h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <div><label for="chakra-max-energy" class="lbl">Max Energy:</label><input type="text" id="chakra-max-energy" placeholder="Enter maximum" value="1000" class="inpt focus:ring-chakra"></div>
                     <div><label for="chakra-max-multiplier" class="lbl">Max Energy Multiplier:</label><input type="text" id="chakra-max-multiplier" placeholder="e.g., 1" value="1" class="inpt focus:ring-chakra"></div>
                     <div><label for="chakra-total-energy" class="lbl">Total Energy (Calculated):</label><input type="text" id="chakra-total-energy" readonly class="inpt-ro"></div>
                     <div><label for="chakra-current-energy" class="lbl">Current Energy:</label><input type="text" id="chakra-current-energy" readonly class="inpt-ro"></div>
                     <div><label for="chakra-damage-per-power" class="lbl">Damage per Energy Point:</label><input type="text" id="chakra-damage-per-power" placeholder="e.g., 0.5" value="1" class="inpt focus:ring-chakra"></div>
                     <div><label for="chakra-regen-percent" class="lbl">Regeneration Rate (% of Max):</label><div class="flex items-center gap-2"><input type="text" id="chakra-regen-percent" placeholder="e.g., 10" class="flex-grow p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-chakra focus:border-transparent text-sm"><button data-type="chakra" class="regen-btn bg-chakra hover:bg-chakra-dark focus:ring-chakra">Regen</button></div></div>
                </div>
            </div>
            <div id="magic-pool" class="energy-pool energy-pool-magic p-5 mb-5 rounded-lg shadow-sm border-l-4 bg-gradient-to-br from-white to-teal-100" style="display: none;">
                 <h3 class="text-xl font-semibold mb-4 flex items-center">Magic Energy Pool <span class="flex-grow h-px bg-gray-200 ml-3"></span></h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <div><label for="magic-max-energy" class="lbl">Max Energy:</label><input type="text" id="magic-max-energy" placeholder="Enter maximum" value="1000" class="inpt inpt-magic"></div>
                     <div><label for="magic-max-multiplier" class="lbl">Max Energy Multiplier:</label><input type="text" id="magic-max-multiplier" placeholder="e.g., 1" value="1" class="inpt inpt-magic"></div>
                     <div><label for="magic-total-energy" class="lbl">Total Energy (Calculated):</label><input type="text" id="magic-total-energy" readonly class="inpt-ro"></div>
                     <div><label for="magic-current-energy" class="lbl">Current Energy:</label><input type="text" id="magic-current-energy" readonly class="inpt-ro"></div>
                     <div><label for="magic-damage-per-power" class="lbl">Damage per Energy Point:</label><input type="text" id="magic-damage-per-power" placeholder="e.g., 0.5" value="1" class="inpt inpt-magic"></div>
                     <div><label for="magic-regen-percent" class="lbl">Regeneration Rate (% of Max):</label><div class="flex items-center gap-2"><input type="text" id="magic-regen-percent" placeholder="e.g., 10" class="flex-grow p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-magic-focus focus:border-transparent text-sm"><button data-type="magic" class="regen-btn bg-magic hover:bg-magic-dark focus:ring-magic-focus">Regen</button></div></div>
                </div>
            </div>
            <div id="cursed-pool" class="energy-pool energy-pool-cursed p-5 mb-5 rounded-lg shadow-sm border-l-4 bg-gradient-to-br from-white to-red-100" style="display: none;">
                 <h3 class="text-xl font-semibold mb-4 flex items-center">Cursed Energy Pool <span class="flex-grow h-px bg-gray-200 ml-3"></span></h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <div><label for="cursed-max-energy" class="lbl">Max Energy:</label><input type="text" id="cursed-max-energy" placeholder="Enter maximum" value="1000" class="inpt inpt-cursed"></div>
                     <div><label for="cursed-max-multiplier" class="lbl">Max Energy Multiplier:</label><input type="text" id="cursed-max-multiplier" placeholder="e.g., 1" value="1" class="inpt inpt-cursed"></div>
                     <div><label for="cursed-total-energy" class="lbl">Total Energy (Calculated):</label><input type="text" id="cursed-total-energy" readonly class="inpt-ro"></div>
                     <div><label for="cursed-current-energy" class="lbl">Current Energy:</label><input type="text" id="cursed-current-energy" readonly class="inpt-ro"></div>
                     <div><label for="cursed-damage-per-power" class="lbl">Damage per Energy Point:</label><input type="text" id="cursed-damage-per-power" placeholder="e.g., 0.5" value="1" class="inpt inpt-cursed"></div>
                     <div><label for="cursed-regen-percent" class="lbl">Regeneration Rate (% of Max):</label><div class="flex items-center gap-2"><input type="text" id="cursed-regen-percent" placeholder="e.g., 10" class="flex-grow p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-cursed-focus focus:border-transparent text-sm"><button data-type="cursed" class="regen-btn bg-cursed hover:bg-cursed-dark focus:ring-cursed-focus">Regen</button></div></div>
                </div>
            </div>

            <div class="energy-slider-container bg-white p-5 mb-5 rounded-lg shadow-sm">
                 <label for="energy-slider" class="block mb-2 font-medium text-gray-600">Energy Used for Attack (% of Current):</label>
                 <input type="range" id="energy-slider" class="energy-slider w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" min="0" max="100" value="50" aria-valuemin="0" aria-valuemax="100" aria-valuenow="50" role="slider">
                 <div class="flex justify-between text-xs text-gray-500 mt-1 px-1"><span>0%</span><span>25%</span><span>50%</span><span>75%</span><span>100%</span></div>
                 <div class="mt-3 text-center text-sm font-medium text-success-dark bg-success-light p-2 rounded-md" id="energy-slider-value-display">50% (Energy Used: 0, Extra Damage: 0.00)</div>
            </div>

            <button id="calculate-btn" aria-label="Calculate final damage value" class="w-full px-4 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out text-lg font-semibold shadow-md mb-5"> Calculate Damage </button>

            <div id="loading" class="loading text-center p-5 hidden">
                 <div class="loading-spinner inline-block w-8 h-8 border-4 border-t-success border-gray-200 rounded-full animate-spin" aria-hidden="true"></div>
                 <div class="loading-text mt-2 text-gray-600">Calculating...</div><span class="sr-only">Loading, please wait</span>
            </div>

            <div id="result" class="result bg-success-light p-5 rounded-lg border-l-4 border-success shadow-sm hidden animate-fadeIn" aria-live="polite">
                 <div class="result-title text-lg font-semibold mb-2 text-success-dark">Calculated Damage:</div>
                 <div id="result-value" class="result-value text-3xl font-bold mb-3 break-words">0</div>
                 <div id="result-details" class="result-details text-sm text-gray-700 mt-3 border-t border-success/30 pt-3">
                     <p><strong>Energy Used:</strong> <span id="result-energy-used">0</span></p>
                     <p><strong>Extra Damage from Energy:</strong> <span id="result-extra-damage">0.00</span></p>
                     <hr class="my-2 border-success/20">
                     <p><strong>Scientific Notation:</strong> <span id="result-scientific">0</span></p>
                     <p><strong>In Words:</strong> <span id="result-words">Zero</span></p>
                 </div>
            </div>

        </div><div id="stats-panel" class="stats-panel md:w-1/4 lg:w-1/5 p-5 bg-white rounded-lg shadow-sm self-start sticky top-6 border-stats-border">
            <h3 id="stats-panel-header" class="stats-panel-header text-xl font-semibold mb-4 flex items-center text-stats-header"> Stats <span class="flex-grow h-px bg-gray-200 ml-3"></span> </h3>
            <div class="space-y-3">
                <p class="text-sm text-gray-600">Selected Current Energy: <span id="stat-current-energy" class="font-medium text-gray-800">0</span></p>
                <hr class="border-gray-200">
                <p class="text-sm text-gray-600">Total Damage Dealt: <span id="stat-total-damage" class="font-medium text-gray-800">0</span></p>
                <p class="text-sm text-gray-600">Total Energy Spent: <span id="stat-total-energy-spent" class="font-medium text-gray-800">0</span></p>
                <p class="text-sm text-gray-600">Highest Damage: <span id="stat-highest-damage" class="font-medium text-gray-800">0</span></p>
                <p class="text-sm text-gray-600">Number of Attacks: <span id="stat-attack-count" class="font-medium text-gray-800">0</span></p>

                <div id="kaioken-section" class="hidden pt-3 border-t border-gray-200">
                     <div class="flex items-center gap-2 mb-3">
                         <input type="checkbox" id="kaioken-checkbox" class="rounded border-gray-300 text-red-600 shadow-sm focus:ring-kaioken-focus">
                         <label for="kaioken-checkbox" class="text-sm font-medium text-kaioken-header">Kaioken?</label>
                     </div>
                     <div id="kaioken-details" class="hidden space-y-2">
                         <div class="flex items-center gap-2">
                             <div class="flex-grow">
                                  <label for="max-health" class="lbl">Max Health:</label>
                                  <input type="text" id="max-health" placeholder="e.g., 1000" value="1000" class="inpt inpt-kaioken">
                             </div>
                             <button id="regen-health-btn" title="Regenerate Health to Max" class="px-2 py-1 text-xs bg-success hover:bg-success-dark text-white rounded-md focus:outline-none focus:ring-2 focus:ring-success focus:ring-offset-1 self-end mb-1">Regen Health</button>
                         </div>
                         <div><label for="kaioken-strain" class="lbl">Kaioken Strain (% Max HP):</label><input type="text" id="kaioken-strain" placeholder="e.g., 10" value="10" class="inpt inpt-kaioken"></div>
                         <div><label for="current-health" class="lbl">Current Health:</label><input type="text" id="current-health" readonly class="inpt-ro"></div>
                     </div>
                </div>
                </div>
        </div></div><script>
        // --- DOM Element References ---
        const energyTypeSelect = document.getElementById('energy-type');
        const kiPoolDiv = document.getElementById('ki-pool');
        const nenPoolDiv = document.getElementById('nen-pool');
        const chakraPoolDiv = document.getElementById('chakra-pool');
        const magicPoolDiv = document.getElementById('magic-pool');
        const cursedPoolDiv = document.getElementById('cursed-pool'); // Added
        const energySlider = document.getElementById('energy-slider');
        const energySliderValueDisplay = document.getElementById('energy-slider-value-display');
        const calculateBtn = document.getElementById('calculate-btn');
        const resultDiv = document.getElementById('result');
        const resultValueEl = document.getElementById('result-value');
        const resultEnergyUsedEl = document.getElementById('result-energy-used');
        const resultExtraDamageEl = document.getElementById('result-extra-damage');
        const resultScientificEl = document.getElementById('result-scientific');
        const resultWordsEl = document.getElementById('result-words');
        const loadingDiv = document.getElementById('loading');
        const messageArea = document.getElementById('message-area');
        const dynamicModifiersContainer = document.getElementById('dynamic-modifiers-container');
        const addDynamicBoxBtn = document.getElementById('add-dynamic-box');
        const baseDamageInput = document.getElementById('base-damage');
        const baseMultiplierInput = document.getElementById('base-multiplier');
        const formMultiplierInput = document.getElementById('form-multiplier');

        // Stats Panel Elements
        const statsPanel = document.getElementById('stats-panel');
        const statsPanelHeader = document.getElementById('stats-panel-header');
        const statCurrentEnergyEl = document.getElementById('stat-current-energy');
        const statTotalDamageEl = document.getElementById('stat-total-damage');
        const statTotalEnergySpentEl = document.getElementById('stat-total-energy-spent');
        const statAttackCountEl = document.getElementById('stat-attack-count');
        const statHighestDamageEl = document.getElementById('stat-highest-damage');

        // Kaioken Elements
        const kaiokenSection = document.getElementById('kaioken-section');
        const kaiokenCheckbox = document.getElementById('kaioken-checkbox');
        const kaiokenDetails = document.getElementById('kaioken-details');
        const maxHealthInput = document.getElementById('max-health');
        const kaiokenStrainInput = document.getElementById('kaioken-strain');
        const currentHealthEl = document.getElementById('current-health');
        const regenHealthBtn = document.getElementById('regen-health-btn');

        // --- Global State for Stats ---
        let totalDamageDealt = 0;
        let totalEnergySpent = 0;
        let attackCount = 0;
        let highestDamage = 0;

        // --- Utility Functions ---
        function safeParseFloat(value, defaultValue = 0) { if (typeof value !== 'string' && typeof value !== 'number') return defaultValue; const num = parseFloat(String(value).replace(/,/g, '')); return isNaN(num) ? defaultValue : num; }
        function formatNumber(num) { if (typeof num !== 'number' || isNaN(num)) return '0'; try { const options = { maximumFractionDigits: 2 }; return num.toLocaleString('en-US', options); } catch (e) { console.warn("Format err:", e); return num.toExponential(2); } }
        function showMessage(text, type = 'info') { messageArea.textContent = text; messageArea.className = 'mb-4 p-3 rounded-md text-sm border'; messageArea.classList.remove('hidden'); switch (type) { case 'error': messageArea.classList.add('bg-error-light', 'text-error-dark', 'border-error'); break; case 'success': messageArea.classList.add('bg-success-light', 'text-success-dark', 'border-success'); break; default: messageArea.classList.add('bg-blue-100', 'text-blue-800', 'border-blue-300'); } setTimeout(() => { messageArea.classList.add('hidden'); }, 5000); }
        function showLoading(isLoading) { loadingDiv.classList.toggle('hidden', !isLoading); if(isLoading) resultDiv.classList.add('hidden'); calculateBtn.disabled = isLoading; calculateBtn.classList.toggle('opacity-50', isLoading); calculateBtn.classList.toggle('cursor-not-allowed', isLoading); }

        // --- Energy Pool Logic ---
        function getEnergyElements(type) {
            // Updated validation to include 'magic' and 'cursed'
            if (!['ki', 'nen', 'chakra', 'magic', 'cursed'].includes(type)) {
                console.error("Invalid energy type requested:", type);
                return null;
            }
            return { /* ... return elements ... */ maxEnergyEl: document.getElementById(`${type}-max-energy`), maxMultiplierEl: document.getElementById(`${type}-max-multiplier`), totalEnergyEl: document.getElementById(`${type}-total-energy`), currentEnergyEl: document.getElementById(`${type}-current-energy`), damagePerPowerEl: document.getElementById(`${type}-damage-per-power`), regenPercentEl: document.getElementById(`${type}-regen-percent`) };
        }
        function calculateTotalEnergy(type) { const els = getEnergyElements(type); if (!els?.maxEnergyEl || !els?.maxMultiplierEl || !els?.totalEnergyEl || !els?.currentEnergyEl) { console.error(`Elements missing: ${type}`); return 0; } const maxEnergy = safeParseFloat(els.maxEnergyEl.value, 0); const multiplier = safeParseFloat(els.maxMultiplierEl.value, 1); const totalEnergy = maxEnergy * multiplier; els.totalEnergyEl.value = formatNumber(totalEnergy); els.currentEnergyEl.value = formatNumber(totalEnergy); return totalEnergy; }
        function regenerateEnergy(type) { const els = getEnergyElements(type); if (!els?.totalEnergyEl || !els?.currentEnergyEl || !els?.regenPercentEl) { console.error(`Elements missing: ${type}`); return; } const totalEnergy = safeParseFloat(els.totalEnergyEl.value.replace(/,/g, ''), 0); let currentEnergy = safeParseFloat(els.currentEnergyEl.value.replace(/,/g, ''), 0); const regenPercent = safeParseFloat(els.regenPercentEl.value, 0); if (totalEnergy <= 0) { showMessage('Max Energy must be positive.', 'error'); return; } if (regenPercent <= 0) { showMessage('Regen Rate must be positive.', 'error'); return; } const regenAmount = totalEnergy * (regenPercent / 100); let newEnergy = Math.min(currentEnergy + regenAmount, totalEnergy); els.currentEnergyEl.value = formatNumber(newEnergy); showMessage(`${formatNumber(regenAmount)} regenerated. Current: ${formatNumber(newEnergy)}`, 'success'); updateSliderDisplay(); updateStatsDisplay(); }

        // --- Kaioken Styling ---
        function applyKaiokenStyle() { if (!statsPanel || !statsPanelHeader) return; statsPanel.classList.remove('border-stats-border'); statsPanel.classList.add('border-kaioken-border'); statsPanelHeader.classList.remove('text-stats-header'); statsPanelHeader.classList.add('text-kaioken-header'); }
        function removeKaiokenStyle() { if (!statsPanel || !statsPanelHeader) return; statsPanel.classList.add('border-stats-border'); statsPanel.classList.remove('border-kaioken-border'); statsPanelHeader.classList.add('text-stats-header'); statsPanelHeader.classList.remove('text-kaioken-header'); }

        // --- Health Update ---
        function updateCurrentHealthDisplay() { if (energyTypeSelect.value === 'ki' && kaiokenCheckbox.checked && maxHealthInput && currentHealthEl) { const maxHealth = safeParseFloat(maxHealthInput.value, 0); let currentHealth = safeParseFloat(currentHealthEl.value.replace(/,/g,''), -1); if (currentHealth === -1 || currentHealth > maxHealth || currentHealthEl.value === '') { currentHealthEl.value = formatNumber(maxHealth); } } else if (currentHealthEl) { if (maxHealthInput && currentHealthEl.value === '') { currentHealthEl.value = formatNumber(safeParseFloat(maxHealthInput.value, 0)); } } }
        function regenerateHealth() { if (!maxHealthInput || !currentHealthEl) { console.error("Health elements missing."); return; } const maxHealth = safeParseFloat(maxHealthInput.value, 0); currentHealthEl.value = formatNumber(maxHealth); showMessage('Health fully regenerated!', 'success'); updateStatsDisplay(); }


        // --- Show/Hide Logic ---
        function showSelectedEnergyPool() {
            const selectedType = energyTypeSelect.value;
            // Hide/show energy pool divs
            kiPoolDiv.style.display = selectedType === 'ki' ? 'block' : 'none';
            nenPoolDiv.style.display = selectedType === 'nen' ? 'block' : 'none';
            chakraPoolDiv.style.display = selectedType === 'chakra' ? 'block' : 'none';
            magicPoolDiv.style.display = selectedType === 'magic' ? 'block' : 'none';
            cursedPoolDiv.style.display = selectedType === 'cursed' ? 'block' : 'none'; // Added Cursed

            // Show/Hide Kaioken section
            if (kaiokenSection) {
                 if (selectedType === 'ki') {
                     kaiokenSection.classList.remove('hidden');
                     if (kaiokenCheckbox.checked) {
                        kaiokenDetails.classList.remove('hidden');
                        updateCurrentHealthDisplay();
                     }
                 } else { // Hide for Nen, Chakra, Magic, Cursed
                     kaiokenSection.classList.add('hidden');
                     if (kaiokenCheckbox.checked) {
                         kaiokenCheckbox.checked = false;
                         kaiokenDetails.classList.add('hidden');
                         removeKaiokenStyle();
                     }
                 }
            }

            calculateTotalEnergy(selectedType);
            updateSliderDisplay();
            updateStatsDisplay();
        }

        // --- Dynamic Modifiers Logic ---
        let dynamicModifierCount = 0;
        function addDynamicModifier() { dynamicModifierCount++; const modifierId = `dynamic-modifier-${dynamicModifierCount}`; const newModifierDiv = document.createElement('div'); newModifierDiv.className = 'dynamic-box additive p-4 mt-3 border rounded-md border-l-4 relative transition-all duration-300 ease-in-out bg-success-light border-success animate-fadeIn'; newModifierDiv.id = modifierId; newModifierDiv.innerHTML = `<div class="absolute top-2 right-2"><button class="remove-dynamic-box bg-error text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-error-dark focus:outline-none focus:ring-2 focus:ring-error focus:ring-offset-1" aria-label="Remove this modifier" data-target="${modifierId}">×</button></div><div class="modifier-type-selector flex gap-2 mb-3 border-b pb-2"><div class="modifier-type-option additive active flex-1 p-2 text-center border rounded-md cursor-pointer transition-all duration-300 ease-in-out text-sm" data-value="additive" tabindex="0" role="radio" aria-checked="true"><input type="radio" name="modifier-type-${modifierId}" value="additive" class="sr-only" checked> Additive (+)</div><div class="modifier-type-option multiplicative flex-1 p-2 text-center border rounded-md cursor-pointer transition-all duration-300 ease-in-out text-sm" data-value="multiplicative" tabindex="0" role="radio" aria-checked="false"><input type="radio" name="modifier-type-${modifierId}" value="multiplicative" class="sr-only"> Multiplier (×)</div></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-3"><div><label for="modifier-name-${modifierId}" class="lbl">Modifier Name:</label><input type="text" id="modifier-name-${modifierId}" placeholder="e.g., Buff" class="modifier-name-input w-full p-1.5 border border-gray-300 rounded-md focus:ring-1 focus:ring-success focus:border-transparent text-sm"></div><div><label for="modifier-value-${modifierId}" class="lbl">Value:</label><input type="text" id="modifier-value-${modifierId}" placeholder="e.g., 50 or 1.2" value="0" class="modifier-value-input w-full p-1.5 border border-gray-300 rounded-md focus:ring-1 focus:ring-success focus:border-transparent text-sm"></div></div>`; dynamicModifiersContainer.appendChild(newModifierDiv); addListenersToModifierBox(newModifierDiv); }
        function addListenersToModifierBox(modifierDiv) { modifierDiv.querySelector('.remove-dynamic-box').addEventListener('click', function() { document.getElementById(this.dataset.target)?.remove(); updateDamageCalculations(); }); modifierDiv.querySelectorAll('.modifier-type-option').forEach(option => { option.addEventListener('click', function() { const box = this.closest('.dynamic-box'); const value = this.dataset.value; box.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false); this.querySelector('input[type="radio"]').checked = true; box.querySelectorAll('.modifier-type-option').forEach(opt => { opt.classList.remove('active'); opt.setAttribute('aria-checked', 'false'); }); this.classList.add('active'); this.setAttribute('aria-checked', 'true'); box.classList.remove('additive', 'multiplicative', 'bg-success-light', 'border-success', 'bg-ki/10', 'border-ki'); if (value === 'additive') { box.classList.add('additive', 'bg-success-light', 'border-success'); } else { box.classList.add('multiplicative', 'bg-ki/10', 'border-ki'); } updateDamageCalculations(); }); option.addEventListener('keydown', function(e) { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); this.click(); } }); }); modifierDiv.querySelectorAll('.modifier-name-input, .modifier-value-input').forEach(input => { input.addEventListener('input', updateDamageCalculations); }); }

        // --- Stats Update Logic ---
        function updateStatsDisplay() { if (statTotalDamageEl) statTotalDamageEl.textContent = formatNumber(totalDamageDealt); if (statTotalEnergySpentEl) statTotalEnergySpentEl.textContent = formatNumber(totalEnergySpent); if (statAttackCountEl) statAttackCountEl.textContent = attackCount.toLocaleString(); if (statHighestDamageEl) statHighestDamageEl.textContent = formatNumber(highestDamage); const selectedType = energyTypeSelect.value; const els = getEnergyElements(selectedType); if (statCurrentEnergyEl && els?.currentEnergyEl) { statCurrentEnergyEl.textContent = els.currentEnergyEl.value; } else if (statCurrentEnergyEl) { statCurrentEnergyEl.textContent = 'N/A'; } }

        // --- Calculation Logic ---
        function updateSliderDisplay() { const energyType = energyTypeSelect.value; const els = getEnergyElements(energyType); if (!els?.currentEnergyEl || !els?.damagePerPowerEl) { console.error(`Slider elements missing: ${energyType}`); energySliderValueDisplay.textContent = `Error`; return; } const sliderPercent = energySlider.value; const currentEnergy = safeParseFloat(els.currentEnergyEl.value.replace(/,/g, ''), 0); const damagePerPower = safeParseFloat(els.damagePerPowerEl.value, 1); const energyUsed = currentEnergy * (sliderPercent / 100); const extraDamage = energyUsed * damagePerPower; energySliderValueDisplay.textContent = `${sliderPercent}% (Energy Used: ${formatNumber(energyUsed)}, Extra Damage: ${formatNumber(extraDamage)})`; }

        function performCalculation() {
            showLoading(true);
            setTimeout(() => {
                try {
                    // Gather Inputs & Calculate Damage
                    const baseDamage = safeParseFloat(baseDamageInput.value, 0); const baseMultiplier = safeParseFloat(baseMultiplierInput.value, 1); const formMultiplier = safeParseFloat(formMultiplierInput.value, 1); const energyType = energyTypeSelect.value; const sliderPercent = safeParseFloat(energySlider.value, 0); const els = getEnergyElements(energyType); if (!els?.currentEnergyEl || !els?.damagePerPowerEl) { throw new Error(`Elements missing: ${energyType}`); } const currentEnergy = safeParseFloat(els.currentEnergyEl.value.replace(/,/g, ''), 0); const damagePerPower = safeParseFloat(els.damagePerPowerEl.value, 1); let finalDamage = baseDamage * baseMultiplier * formMultiplier; document.querySelectorAll('#dynamic-modifiers-container .dynamic-box').forEach(modifierDiv => { const valueInput = modifierDiv.querySelector('.modifier-value-input'); const typeOption = modifierDiv.querySelector('.modifier-type-option.active'); if (valueInput && typeOption) { const modifierValue = safeParseFloat(valueInput.value, 0); const modifierType = typeOption.dataset.value; if (modifierType === 'additive') { finalDamage += modifierValue; } else if (modifierType === 'multiplicative') { const multiplier = (modifierValue === 0 && valueInput.value.trim() !== '0') ? 1 : modifierValue; finalDamage *= multiplier; } } }); const energyUsed = currentEnergy * (sliderPercent / 100); const extraDamage = energyUsed * damagePerPower; finalDamage += extraDamage;

                    // Update Current Energy
                    let newCurrentEnergy = Math.max(0, currentEnergy - energyUsed);
                    els.currentEnergyEl.value = formatNumber(newCurrentEnergy);

                    // Apply Kaioken Strain (if active)
                    if (energyType === 'ki' && kaiokenCheckbox.checked) {
                        const currentHealth = safeParseFloat(currentHealthEl.value.replace(/,/g, ''), 0);
                        if (currentHealth > 0) {
                            const maxHealth = safeParseFloat(maxHealthInput.value, 0);
                            const kaiokenStrain = safeParseFloat(kaiokenStrainInput.value, 0);
                            if (maxHealth > 0 && kaiokenStrain > 0) {
                                const strainCost = maxHealth * (kaiokenStrain / 100);
                                let newHealth = Math.max(0, currentHealth - strainCost);
                                currentHealthEl.value = formatNumber(newHealth);
                                if (newHealth === 0) { showMessage('Warning: Current Health depleted by Kaioken strain!', 'error'); }
                            }
                        } else { showMessage('Cannot attack: Current Health is zero while Kaioken is active.', 'error'); /* Consider preventing calculation */ }
                    }

                    // Update Stats
                    totalDamageDealt += finalDamage; totalEnergySpent += energyUsed; attackCount++; if (finalDamage > highestDamage) { highestDamage = finalDamage; } updateStatsDisplay();

                    // Display Results
                    resultValueEl.textContent = formatNumber(finalDamage); resultEnergyUsedEl.textContent = formatNumber(energyUsed); resultExtraDamageEl.textContent = formatNumber(extraDamage); displayAllFormats(finalDamage); resultDiv.classList.remove('hidden', 'bg-error-light', 'border-error', 'text-error-dark'); resultDiv.classList.add('bg-success-light', 'border-success', 'text-success-dark'); resultDiv.querySelector('.result-title').className = 'result-title text-lg font-semibold mb-2 text-success-dark'; showMessage('Calculation successful!', 'success'); updateSliderDisplay();

                } catch (error) { console.error("Calc Error:", error); resultValueEl.textContent = 'Error'; resultEnergyUsedEl.textContent = 'N/A'; resultExtraDamageEl.textContent = 'N/A'; resultScientificEl.textContent = 'N/A'; resultWordsEl.textContent = 'Error'; resultDiv.classList.remove('hidden', 'bg-success-light', 'border-success', 'text-success-dark'); resultDiv.classList.add('bg-error-light', 'border-error', 'text-error-dark'); resultDiv.querySelector('.result-title').className = 'result-title text-lg font-semibold mb-2 text-error-dark'; showMessage(`Calculation failed: ${error.message || 'Unknown error'}`, 'error'); } finally { showLoading(false); }
            }, 50);
        }
        function updateDamageCalculations() { updateSliderDisplay(); }

        // --- Number Formatting (Scientific & Words) ---
        function displayAllFormats(damage) { try { resultScientificEl.textContent = damage.toExponential(2).replace(/e\+?(-?)/, ' x 10^$1'); } catch (e) { resultScientificEl.textContent = "Invalid"; console.error("Sci err:", e); } try { resultWordsEl.textContent = convertNumberToWords(damage); } catch (e) { resultWordsEl.textContent = "Error"; console.error("Words err:", e); } }
        function convertNumberToWords(number) { /* ... Full function ... */ if (typeof number !== 'number' || !isFinite(number)) { return 'Invalid Number'; } const numStr = String(number); const [integerPartStr, decimalPartStr] = numStr.split('.'); let integerPart; try { integerPart = BigInt(integerPartStr); } catch (e) { console.error("BigInt error:", e); return "Too large"; } const units = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine', 'Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen']; const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety']; const scales = ['', 'Thousand', 'Million', 'Billion', 'Trillion', 'Quadrillion', 'Quintillion', 'Sextillion', 'Septillion', 'Octillion', 'Nonillion', 'Decillion', 'Undecillion', 'Duodecillion', 'Tredecillion', 'Quattuordecillion', 'Quindecillion']; if (integerPart === 0n && (!decimalPartStr || safeParseFloat('0.' + decimalPartStr) === 0)) { return 'Zero'; } let words = ''; let isNegative = false; if (integerPart < 0n) { isNegative = true; integerPart = -integerPart; } function convertHundreds(num) { let word = ''; const h = Math.floor(num / 100); const r = num % 100; if (h > 0) { word += units[h] + ' Hundred'; } if (r > 0) { if (word !== '') word += ' '; if (r < 20) { word += units[r]; } else { const t = Math.floor(r / 10); const o = r % 10; word += tens[t]; if (o > 0) { word += '-' + units[o]; } } } return word; } if (integerPart === 0n) { words = ''; } else { let scaleIndex = 0; let tempWords = []; while (integerPart > 0n) { if (scaleIndex >= scales.length) { return "Too large"; } const chunk = Number(integerPart % 1000n); if (chunk !== 0) { tempWords.push(convertHundreds(chunk) + (scaleIndex > 0 ? ' ' + scales[scaleIndex] : '')); } integerPart /= 1000n; scaleIndex++; } words = tempWords.reverse().join(', '); } if (decimalPartStr && safeParseFloat('0.' + decimalPartStr) !== 0) { if (words !== '') { words += ' Point'; } else if (integerPartStr === '0') { words = 'Zero Point'; } else { words += ' Point'; } for (const digit of decimalPartStr) { words += ' ' + (units[parseInt(digit)] || 'Zero'); } } if (isNegative) { words = 'Negative ' + words; } return words.trim() || 'Zero'; }

        // --- Event Listeners Setup ---
        energyTypeSelect.addEventListener('change', showSelectedEnergyPool);
        energySlider.addEventListener('input', updateSliderDisplay);
        calculateBtn.addEventListener('click', performCalculation);
        addDynamicBoxBtn.addEventListener('click', addDynamicModifier);
        // Updated loop to include 'cursed'
        ['ki', 'nen', 'chakra', 'magic', 'cursed'].forEach(type => { const els = getEnergyElements(type); if (els?.maxEnergyEl && els?.maxMultiplierEl && els?.damagePerPowerEl) { els.maxEnergyEl.addEventListener('input', () => { calculateTotalEnergy(type); updateSliderDisplay(); updateStatsDisplay(); }); els.maxMultiplierEl.addEventListener('input', () => { calculateTotalEnergy(type); updateSliderDisplay(); updateStatsDisplay(); }); els.damagePerPowerEl.addEventListener('input', updateSliderDisplay); } else { console.warn(`Listeners not attached: ${type}.`); } });
        document.querySelectorAll('.regen-btn').forEach(button => { button.addEventListener('click', function() { regenerateEnergy(this.dataset.type); }); });
        baseDamageInput.addEventListener('input', updateDamageCalculations);
        baseMultiplierInput.addEventListener('input', updateDamageCalculations);
        formMultiplierInput.addEventListener('input', updateDamageCalculations);

        // Kaioken Listeners
        if (kaiokenCheckbox) { kaiokenCheckbox.addEventListener('change', () => { const isChecked = kaiokenCheckbox.checked; kaiokenDetails.classList.toggle('hidden', !isChecked); if (isChecked) { applyKaiokenStyle(); updateCurrentHealthDisplay(); } else { removeKaiokenStyle(); } }); }
        if (maxHealthInput) { maxHealthInput.addEventListener('input', updateCurrentHealthDisplay); }
        if (regenHealthBtn) { regenHealthBtn.addEventListener('click', regenerateHealth); }

        // --- Initial Setup on Page Load ---
        document.addEventListener('DOMContentLoaded', () => { showSelectedEnergyPool(); });

    </script>

</body>
</html>
